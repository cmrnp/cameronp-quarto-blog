<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Cameron Patrick</title>
<link>https://cameronpatrick.com/index.html</link>
<atom:link href="https://cameronpatrick.com/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.3.433</generator>
<lastBuildDate>Sun, 30 Jul 2023 14:00:00 GMT</lastBuildDate>
<item>
  <title>Dirty imputation done dirt cheap: implementing Multiple Imputation by Chained Equations in one blog post</title>
  <dc:creator>Cameron Patrick</dc:creator>
  <link>https://cameronpatrick.com/post/2023/07/mice-in-a-blog-post/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Coding up an algorithm is a great way to make sure you really understand how the details work. In this post I’m going to implement multiple imputation and the MICE algorithm <span class="citation" data-cites="vanbuuren2007multipleimputationdiscrete">(Van Buuren, 2007)</span>, albeit in much simplified form: only considering missing data in numeric variables, only using Normal-distribution Bayesian linear regression to generate the imputed data, no concerns about robustness of the code for production purposes.</p>
<p>If the standard version of this method is called MICE, think of this as a smaller, cuter, maybe slightly endangered variation. Perhaps a fat-tailed dunnart.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://cameronpatrick.com/post/2023/07/mice-in-a-blog-post/fat-tailed-dunnart.jpg" class="img-fluid figure-img" width="715"></p>
<figcaption class="figure-caption">Fat-tailed dunnart in Queensland, Australia. Image by <a href="https://commons.wikimedia.org/wiki/File:Fat-tailed_Dunnart_(Sminthopsis_crassicaudata)_(9998321085).jpg">Bernard Dupont, sourced from Wikimedia Commons (CC-SA licence)</a>.</figcaption>
</figure>
</div>
</section>
<section id="bayesian-linear-regression" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-linear-regression">Bayesian linear regression</h2>
<p>We will be imputing each individual variable with missing data using Bayesian linear regression with uninformative Jeffreys priors. For this choice of prior, the posterior distribution of the parameters has an easily computable analytic distribution. This approach is explained in detail in <span class="citation" data-cites="gelman2014bayesiandataanalysis">Gelman et al. (2014)</span>, chapter 14.</p>
<p>The regression equation is given by <img src="https://latex.codecogs.com/png.latex?E(Y%7CX)%20=%20X%5ET%20%5Cbeta">, where <img src="https://latex.codecogs.com/png.latex?Y"> is a column vector of observations, <img src="https://latex.codecogs.com/png.latex?X"> is the design matrix, and <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> is a column vector of regression coefficients. We assume independent normally distributed errors with equal standard deviation: <img src="https://latex.codecogs.com/png.latex?Y%7CX%20%5Csim%20%5Cmathrm%7BMVN%7D(X%5ET%20%5Cbeta,%20%5Csigma%5E2%20I)">. In other words, the usual classical linear regression.</p>
<section id="obtaining-parameter-estimates-from-jeffreys-priors" class="level3">
<h3 class="anchored" data-anchor-id="obtaining-parameter-estimates-from-jeffreys-priors">Obtaining parameter estimates from Jeffreys priors</h3>
<p>The simplest choice of prior (in terms of easily obtaining a posterior distribution) is the Jeffreys prior, which is an improper uninformative prior: uniform over <img src="https://latex.codecogs.com/png.latex?(%5Cbeta,%20%5Clog%20%5Csigma)">. In this case, the posterior distribution of <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> is multivariate normal: <img src="https://latex.codecogs.com/png.latex?%5Cbeta%20%5Csim%20%5Cmathrm%7BMVN%7D(%5Chat%5Cbeta,%20V)">. Here <img src="https://latex.codecogs.com/png.latex?%5Chat%5Cbeta%20=%20(X%5ET%20X)%5E%7B-1%7D%20X%5ET%20Y"> is the frequentist maximum likelihood estimate (ordinary least squares regression) and <img src="https://latex.codecogs.com/png.latex?V%20=%20%5Csigma%5E2%20(X%5ET%20X)%5E%7B-1%7D"> is the usual linear regression variance-covariance matrix.</p>
<p>The posterior distribution of <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2"> is <img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BInverse-%7D%5Cchi%5E2(n-k,%20s%5E2)"> where <img src="https://latex.codecogs.com/png.latex?s%5E2"> is the standard frequentist estimate of the residual variance <span class="citation" data-cites="gelman2014bayesiandataanalysis">(Gelman et al., 2014, p. 355)</span>. This scaled inverse <img src="https://latex.codecogs.com/png.latex?%5Cchi%5E2"> distribution was a new one to me<sup>1</sup>. We say a random variable <img src="https://latex.codecogs.com/png.latex?U%20%5Csim%20%5Cmathrm%7BInverse-%7D%5Cchi%5E2(%5Cnu,%20%5Cmu)"> if <img src="https://latex.codecogs.com/png.latex?V%20%5Csim%20%5Cchi%5E2(%5Cnu)"> and <img src="https://latex.codecogs.com/png.latex?U%20=%20%5Cnu%5Cmu/V"> <span class="citation" data-cites="gelman2014bayesiandataanalysis">(Gelman et al., 2014, p. 581)</span>.</p>
<p>We could just use the built-in R <code>lm</code> function, but it’s been a long time since I last implemented linear regression from scratch, so thought I’d give it a go here. If you’re not interested in seeing this, skip to the section about drawing from the posterior distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># estimate_bayes_lm_jeffreys(Y, X): obtain Bayesian linear regression parameter</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># estimates from design matrix X and observations Y, using a Jeffreys prior.</span></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Should produce the same output as lm().</span></span>
<span id="cb1-4">estimate_bayes_lm_jeffreys <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(Y, X) {</span>
<span id="cb1-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.matrix</span>(X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(X)))</span>
<span id="cb1-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.vector</span>(Y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(Y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(Y)))</span>
<span id="cb1-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(Y))</span>
<span id="cb1-8"></span>
<span id="cb1-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># crossprod(X) computes X^T X</span></span>
<span id="cb1-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># solve(X, Y) computes X^-1 Y</span></span>
<span id="cb1-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Some fiddling is needed since we want our vector outputs to be R vectors,</span></span>
<span id="cb1-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># not R matrices</span></span>
<span id="cb1-13">  xtx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">crossprod</span>(X)</span>
<span id="cb1-14">  beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.vector</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(xtx, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> Y))</span>
<span id="cb1-15">  df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(X)</span>
<span id="cb1-16">  s2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.vector</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">crossprod</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> beta) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> df)</span>
<span id="cb1-17">  V <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> s2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(xtx)</span>
<span id="cb1-18"></span>
<span id="cb1-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Attach variable names to regression coefficients</span></span>
<span id="cb1-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(beta) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(X)</span>
<span id="cb1-21"></span>
<span id="cb1-22">  res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> Y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beta =</span> beta, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">V =</span> V, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">s2 =</span> s2)</span>
<span id="cb1-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(res) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bayeslm"</span></span>
<span id="cb1-24">  res</span>
<span id="cb1-25">}</span></code></pre></div>
</div>
<p>This function expects a vector of observations and a design matrix containing the predictors, but that’s not very convenient in practice. To make this easier to use, let’s write a function that implements a formula interface closer to the standard R <code>lm</code> function. This takes advantage of two base R functions: <code>model.frame</code> takes a model formula and prepares a data frame with the variables mentioned in it, with the outcome variable first, omitting missing values, and providing the option to only include a subset of rows; and <code>model.matrix</code> which creates a design matrix from a formula and a data frame, adding an intercept and creating dummy variables for categorical variables if needed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">bayes_lm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb2-2">  formula, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subset =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb2-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.action =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getOption</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"na.action"</span>),</span>
<span id="cb2-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimator =</span> estimate_bayes_lm_jeffreys</span>
<span id="cb2-5">) {</span>
<span id="cb2-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.character</span>(na.action)) {</span>
<span id="cb2-7">    na.action <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get</span>(na.action)</span>
<span id="cb2-8">  }</span>
<span id="cb2-9">  mf_args <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> formula, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data,</span>
<span id="cb2-10">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subset =</span> subset, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.action =</span> na.action)</span>
<span id="cb2-11">  model_frame <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do.call</span>(stats<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>model.frame, mf_args)</span>
<span id="cb2-12">  model_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(formula, model_frame)</span>
<span id="cb2-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">estimator</span>(model_frame[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], model_matrix)</span>
<span id="cb2-14">}</span></code></pre></div>
</div>
<p>To make the objects that we’ve created behave a bit more like standard R <code>lm</code> objects, we can implement some S3 methods for our new type of object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">coef.bayeslm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(m) m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>beta</span>
<span id="cb3-2">vcov.bayeslm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(m) m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V</span>
<span id="cb3-3">sigma.bayeslm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(m) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>s2)</span>
<span id="cb3-4">df.residual.bayeslm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(m) m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df</span>
<span id="cb3-5">resid.bayeslm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(m) (m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>beta))</span>
<span id="cb3-6">print.bayeslm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(m, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) {</span>
<span id="cb3-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Coefficients:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span>(m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>beta, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> digits), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quote =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb3-9">}</span>
<span id="cb3-10">summary.bayeslm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(m)</span>
<span id="cb3-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb3-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>beta),</span>
<span id="cb3-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>beta,</span>
<span id="cb3-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">std.error =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diag</span>(m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V)),</span>
<span id="cb3-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row.names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>beta)</span>
<span id="cb3-16">  )</span></code></pre></div>
</div>
<p>Let’s make sure this works as expected, using the <code>penguins</code> data from the <code>palmerpenguins</code> package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(palmerpenguins)</span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(penguins)</span></code></pre></div>
</div>
<p>Fit two models, one using <code>lm</code> and one using <code>bayes_lm</code>, to predict bill length from flipper length:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">penguins_lm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(</span>
<span id="cb5-2">  bill_length_mm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> flipper_length_mm , </span>
<span id="cb5-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> penguins</span>
<span id="cb5-4">)</span>
<span id="cb5-5">penguins_blm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bayes_lm</span>(</span>
<span id="cb5-6">  bill_length_mm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> flipper_length_mm,</span>
<span id="cb5-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> penguins</span>
<span id="cb5-8">)</span></code></pre></div>
</div>
<p>Check that the regression coefficients and standard errors are the same for both models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(penguins_lm)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = bill_length_mm ~ flipper_length_mm, data = penguins)

Residuals:
    Min      1Q  Median      3Q     Max 
-8.5792 -2.6715 -0.5721  2.0148 19.1518 

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)       -7.26487    3.20016   -2.27   0.0238 *  
flipper_length_mm  0.25477    0.01589   16.03   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.126 on 340 degrees of freedom
  (2 observations deleted due to missingness)
Multiple R-squared:  0.4306,    Adjusted R-squared:  0.4289 
F-statistic: 257.1 on 1 and 340 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(penguins_blm)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               term   estimate  std.error
1       (Intercept) -7.2648678 3.20015684
2 flipper_length_mm  0.2547682 0.01588914</code></pre>
</div>
</div>
</section>
<section id="sec-drawing-posterior" class="level3">
<h3 class="anchored" data-anchor-id="sec-drawing-posterior">Drawing from the posterior predictive distribution</h3>
<p>To sample from the posterior predictive distribution, we use a two-stage process. First, draw from the posterior distribution of the parameters (regression coefficients and residual variance). As previously discussed, the regression coefficients have a multivariate normal distribution and the residual variance has an <img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BInverse-%7D%5Cchi%5E2"> distribution. Secondly, draw posterior predictions conditional on those parameter estimates, using <img src="https://latex.codecogs.com/png.latex?Y%7CX,%5Cbeta,%5Csigma%5E2%20%5Csim%20%5Cmathrm%7BN%7D(X%5ET%20%5Cbeta,%20%5Csigma%5E2)">.</p>
<p>The function below does the first stage, drawing from the posterior distribution of the model parameters. It doesn’t require the model to be fit using the code from above, this should work for any <code>lm</code> model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">draw_bayes_lm_params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(m, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraw =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb10-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inherits</span>(m, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lm"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bayeslm"</span>)))</span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(ndraw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(ndraw) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ndraw <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-4"></span>
<span id="cb10-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Draw from the posterior distribution of parameters</span></span>
<span id="cb10-6">  draw_beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mvtnorm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rmvnorm</span>(ndraw, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(m), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vcov</span>(m))</span>
<span id="cb10-7">  df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">df.residual</span>(m)</span>
<span id="cb10-8">  draw_sigma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sigma</span>(m) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rchisq</span>(ndraw, df))</span>
<span id="cb10-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beta =</span> draw_beta, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sigma =</span> draw_sigma)</span>
<span id="cb10-10">}</span></code></pre></div>
</div>
<p>To get some idea if this is working, let’s plot the posterior distribution of our parmaeters. They look like what we might expect - normally distributed about the parameter estimates shown above. In fact the distribution of sigma looks far closer to normal than I expected, given it’s actually a scaled inverse Chi squared distribution!</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12345</span>)</span>
<span id="cb11-2">penguins_blm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">draw_bayes_lm_params</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(as_tibble) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sigma =</span> value) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_slabinterval</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"panels"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(var), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"density"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">panel_border</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://cameronpatrick.com/post/2023/07/mice-in-a-blog-post/index_files/figure-html/posterior-param-dists-1.png" class="img-fluid figure-img" width="715"></p>
</figure>
</div>
</div>
</div>
<p>The posterior regression coefficients for flipper length and intercept are negatively correlated, as we might expect:</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">54321</span>)</span>
<span id="cb12-2">penguins_blm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">draw_bayes_lm_params</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pluck</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> flipper_length_mm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">(Intercept)</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://cameronpatrick.com/post/2023/07/mice-in-a-blog-post/index_files/figure-html/posterior-param-corr-1.png" class="img-fluid figure-img" width="715"></p>
</figure>
</div>
</div>
</div>
<p>Now we’re more confident that seemed to work, we can write another function to estimate the posterior predictive distribution of a bunch of new observations, given their X values. This works by drawing a set of <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> parameters, calculating Y values from those, and adding some normally-distributed random noise based on <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2">. This results in the model-predicted distribution of new observations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">draw_bayes_lm_ppred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(m, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraw =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb13-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inherits</span>(m, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lm"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bayeslm"</span>)))</span>
<span id="cb13-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.matrix</span>(X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(X)))</span>
<span id="cb13-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(m)))</span>
<span id="cb13-5"></span>
<span id="cb13-6">  params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">draw_bayes_lm_params</span>(m, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraw =</span> ndraw)</span>
<span id="cb13-7">  X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>beta) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(</span>
<span id="cb13-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ndraw, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sigma, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(X))),</span>
<span id="cb13-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(X)</span>
<span id="cb13-10">  )</span>
<span id="cb13-11">}</span></code></pre></div>
</div>
<p>To demonstrate this in action, the plot below shows a subset of the penguins data, the regression line (grey), the observed data (solid blue circles), and 10 draws from the posterior predictive distribution (hollow red circles):</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb14-2">penguins_subset <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> penguins <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb14-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(bill_length_mm, flipper_length_mm) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb14-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb14-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample_n</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb14-6">penguins_subset_ppred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">draw_bayes_lm_ppred</span>(</span>
<span id="cb14-7">  penguins_blm, </span>
<span id="cb14-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(bill_length_mm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> flipper_length_mm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> penguins_subset), </span>
<span id="cb14-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraw =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb14-10">)</span>
<span id="cb14-11">penguins_subset_ppred_dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> penguins_subset_ppred <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb14-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.name_repair =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unique"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb14-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flipper_length_mm =</span> penguins_subset<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>flipper_length_mm) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb14-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>flipper_length_mm, </span>
<span id="cb14-15">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rep"</span>,</span>
<span id="cb14-16">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bill_length_mm"</span>)</span>
<span id="cb14-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(penguins_subset, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> flipper_length_mm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> bill_length_mm)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(penguins_blm)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb14-19">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slope =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(penguins_blm)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb14-20">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>,</span>
<span id="cb14-21">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,</span>
<span id="cb14-22">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodgerblue4"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stroke =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick4"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb14-25">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> penguins_subset_ppred_dat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://cameronpatrick.com/post/2023/07/mice-in-a-blog-post/index_files/figure-html/posterior-ppred-plot-1.png" class="img-fluid figure-img" width="715"></p>
</figure>
</div>
</div>
</div>
<p>If we only had missing values in one variable, we would be at the point of producing imputed datasets now. But real-life missing data problems tend to have missing data in multiple variables, so we will need to use an iterative method to generate imputations for all variables.</p>
</section>
</section>
<section id="creating-imputations-by-chained-equations" class="level2">
<h2 class="anchored" data-anchor-id="creating-imputations-by-chained-equations">Creating imputations by chained equations</h2>
<p>Now we have a function to draw from the posterior of a Bayesian linear regression, we can apply it iteratively to each incomplete variable to produce multiple imputed datasets. The MICE algorithm works something like this:</p>
<ol type="1">
<li><p>Create an initial dataset with complete values for all variables. (In this simple implementation, I will replace all missing values with the mean of the observed values.)</p></li>
<li><p>For each incomplete variable, take the most recent iteration and fit an appropriate linear regression to the subset of the observations for which that variable has been observed. Draw from the posterior predictive distribution to fill in new values for the observations where that variable was not observed.</p></li>
<li><p>Repeat step 2 a fixed number of terms (<code>iter</code> in our example implementation).</p></li>
<li><p>Repeat the entire procedure (steps 1 to 3) <code>m</code> times to produce <code>m</code> imputed datasets.</p></li>
</ol>
<p>This section of the blog will reimplement a simple version of this algorithm, which I have named dunnart (a smaller, cuter <del>MICE</del> mouse). It only supports imputation of numerical variables, and only using linear regression. Rather than the comprehensive inputs <code>mice</code> uses to control the imputation algorithm, the main input will be a list of regression formulas, one for each variable to impute.</p>
<section id="the-first-iteration-of-imputed-data" class="level3">
<h3 class="anchored" data-anchor-id="the-first-iteration-of-imputed-data">The first iteration of imputed data</h3>
<p>For the initial iteration of imputation, we will replace all missing values with the mean of the non-missing values. The function below does some error checking (ensures that at it is being called on a numeric variable with at least one missing value and at least one observed value) and then uses <code>replace_na()</code> from the <code>tidyr</code> package to do the actual work.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">dunnart_initial_imputation_for_var <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb15-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.vector</span>(x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(x))</span>
<span id="cb15-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(x)))</span>
<span id="cb15-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(x)))</span>
<span id="cb15-5"></span>
<span id="cb15-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># replace missing values with the mean of the non-missing values</span></span>
<span id="cb15-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replace_na</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span>
<span id="cb15-8">}</span></code></pre></div>
</div>
<p>The function below applies <code>dunnart_initial_imputation_for_var</code> to several variables in a data frame, selected based on them appearing as outcome variables in a list of regression formulas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">dunnart_initial_imputation_for_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(dat, formula_list) {</span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.data.frame</span>(dat))</span>
<span id="cb16-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.list</span>(formula_list))</span>
<span id="cb16-4"></span>
<span id="cb16-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find the outcome variable in each formula in formula_list</span></span>
<span id="cb16-6">  vars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_chr</span>(formula_list, \(f) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all.vars</span>(f)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb16-7"></span>
<span id="cb16-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># do the initial imputation for each of those variables</span></span>
<span id="cb16-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(dat, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_of</span>(vars), dunnart_initial_imputation_for_var))</span>
<span id="cb16-10">}</span></code></pre></div>
</div>
</section>
<section id="creating-subsequent-iterations" class="level3">
<h3 class="anchored" data-anchor-id="creating-subsequent-iterations">Creating subsequent iterations</h3>
<p>The function below, <code>dunnart_impute_var</code>, is really the heart of the multiple imputation algorithm. It takes the original data frame with incomplete data <code>dat_orig</code>, the current working iteration of the imputed data <code>dat_cur</code>, and a regression formula <code>formula</code> to specify which predictors are used for the imputation. There’s an additional flag <code>verbose</code> which controls how much diagnostic information is printed to the console (the default emulates the output of <code>mice</code> as it runs).</p>
<p>The steps are as follows:</p>
<ol type="1">
<li><p>Determine which variable we’re imputing, based on the outcome variable of the regression formula.</p></li>
<li><p>Determine which observations we need to impute (and the inverse: which observations we should fit the regression model to), based on the original incomplete data frame.</p></li>
<li><p>Fit a linear regression using the provided model formula to the observations of current imputation-in-progress data frame chosen above.</p></li>
<li><p>Draw from the posterior predictive distribution of the observations which were not used to fit that model and use them to replace the corresponding observations of the variable we’re imputing.</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">dunnart_impute_var <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(dat_orig, dat_cur, formula, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb17-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.data.frame</span>(dat_orig) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.data.frame</span>(dat_cur) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb17-3">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inherits</span>(formula, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"formula"</span>))</span>
<span id="cb17-4"> </span>
<span id="cb17-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find the variable we're imputing</span></span>
<span id="cb17-6">  out_var <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all.vars</span>(formula)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb17-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (verbose <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) {</span>
<span id="cb17-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"    imputing using"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">deparse1</span>(formula), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb17-9">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (verbose <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb17-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>, out_var)</span>
<span id="cb17-11">  }</span>
<span id="cb17-12"></span>
<span id="cb17-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># which rows have missing data in the original data frame?</span></span>
<span id="cb17-14">  miss_rows <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(dat_orig[[out_var]])</span>
<span id="cb17-15"></span>
<span id="cb17-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fit a regression model to the rows that didn't have missing values in</span></span>
<span id="cb17-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the original data</span></span>
<span id="cb17-18">  mod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(formula, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> dat_cur[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>miss_rows, ])</span>
<span id="cb17-19"></span>
<span id="cb17-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># draw predictions for the rows with missing values</span></span>
<span id="cb17-21">  mf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.frame</span>(formula, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> dat_cur[miss_rows, ])</span>
<span id="cb17-22">  mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(formula, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> mf)</span>
<span id="cb17-23">  dat_cur[miss_rows, out_var] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">draw_bayes_lm_ppred</span>(mod, mat)</span>
<span id="cb17-24"></span>
<span id="cb17-25">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># return the updated data frame</span></span>
<span id="cb17-26">  dat_cur</span>
<span id="cb17-27">}</span></code></pre></div>
</div>
<p>To get one complete iteration of the MICE algorithm for a single imputed dataset, we need to apply the above function to each variable we need to impute. This is done using the <code>reduce()</code> function from the <code>purrr</code> package, which repeatedly applies a function to its own output (the current imputed dataset, <code>dat_cur</code>) and a list of new values (the regression model formulas for the variables to impute, <code>formula_list</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">dunnart_impute_iterate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb18-2">  dat_orig, dat_cur, formula_list, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">j =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">m =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb18-3">) {</span>
<span id="cb18-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.data.frame</span>(dat_orig) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.data.frame</span>(dat_cur) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb18-5">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.list</span>(formula_list) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(dat_cur)))</span>
<span id="cb18-6"></span>
<span id="cb18-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (verbose <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) {</span>
<span id="cb18-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  imputation"</span>, j, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"of"</span>, m, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb18-9">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (verbose <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb18-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  ["</span>, j, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>, m, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"]"</span>)</span>
<span id="cb18-11">  }</span>
<span id="cb18-12"></span>
<span id="cb18-13">  dat_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reduce</span>(</span>
<span id="cb18-14">    formula_list,</span>
<span id="cb18-15">    \(dat, form) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dunnart_impute_var</span>(dat_orig, dat, form, verbose),</span>
<span id="cb18-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.init =</span> dat_cur</span>
<span id="cb18-17">  )</span>
<span id="cb18-18"></span>
<span id="cb18-19">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (verbose <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb18-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb18-21">  }</span>
<span id="cb18-22"></span>
<span id="cb18-23">  dat_out</span>
<span id="cb18-24">}</span></code></pre></div>
</div>
</section>
<section id="creating-multiple-imputed-datasets" class="level3">
<h3 class="anchored" data-anchor-id="creating-multiple-imputed-datasets">Creating multiple imputed datasets</h3>
<p>The functions we have above all operate on a single imputed dataset, but we want to produce multiple imputed datasets. The <code>dunnart_multiple_impute_iterate</code> function applies the <code>dunnart_impute_iterate</code> function to a list of imputed datasets using the <code>map2()</code> function from the <code>purrr</code> package. The code is slightly messier than ideal because we pass through some additional information (the imputation index and the total number of imputations) to allow progress reporting in verbose mode.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">dunnart_multiple_impute_iterate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb19-2">  data, imp_out, formula_list, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb19-3">) {</span>
<span id="cb19-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (verbose <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb19-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imputation iteration"</span>, i, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"of"</span>, iter, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-6">  }</span>
<span id="cb19-7"></span>
<span id="cb19-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># apply one imputation step to each imputed dataset</span></span>
<span id="cb19-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map2</span>(</span>
<span id="cb19-10">    imp_out,</span>
<span id="cb19-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(imp_out),</span>
<span id="cb19-12">    \(dat_cur, j) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dunnart_impute_iterate</span>(</span>
<span id="cb19-13">      data, dat_cur, formula_list, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> verbose,</span>
<span id="cb19-14">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">j =</span> j, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">m =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(imp_out)</span>
<span id="cb19-15">    )</span>
<span id="cb19-16">  )</span>
<span id="cb19-17">}</span></code></pre></div>
</div>
<p>Finally, putting it all together: <code>dunnart_impute()</code> is our equivalent of the <code>mice()</code> function, taking an incomplete dataset, a list of model formulas, the number of imputed datasets and number of iterations to run, and returning the multiple imputed output. Most of the code here is error checking. The two statements that actually do the work are the ones beginning <code>imp_out &lt;- map(...)</code> to create the initial imputation, and <code>all_imps &lt;- accumulate(...)</code> to create the subsequent iterations by repeatedly calling <code>dunnart_multiple_impute_iterate()</code>. Finally we create an object of class <code>dunnart</code> to hold the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">dunnart_impute <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb20-2">  data, formula_list, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">m =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb20-3">) {</span>
<span id="cb20-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.data.frame</span>(data))</span>
<span id="cb20-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.list</span>(formula_list) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> </span>
<span id="cb20-6">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_lgl</span>(formula_list, \(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inherits</span>(x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"formula"</span>))))</span>
<span id="cb20-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(m) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(m) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(m) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> m <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(iter) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(iter) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(iter) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb20-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.logical</span>(verbose) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(verbose)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> </span>
<span id="cb20-10">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(verbose) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(verbose))</span>
<span id="cb20-11"></span>
<span id="cb20-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set up initial imputations (mean imputation)</span></span>
<span id="cb20-13">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (verbose <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb20-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generating"</span>, m, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"initial imputations</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb20-15">  }</span>
<span id="cb20-16">  imp_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(</span>
<span id="cb20-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(m), </span>
<span id="cb20-18">    \(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dunnart_initial_imputation_for_df</span>(data, formula_list)</span>
<span id="cb20-19">  )</span>
<span id="cb20-20"></span>
<span id="cb20-21">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check for any NA values after initial imputation, signifying that some</span></span>
<span id="cb20-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># variables with missing data do not have imputation formulas provided</span></span>
<span id="cb20-23">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_lgl</span>(imp_out, \(dat) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(dat))))) {</span>
<span id="cb20-24">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NAs found after initial imputation step - fix imputation formulas"</span>)</span>
<span id="cb20-25">  }</span>
<span id="cb20-26"></span>
<span id="cb20-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># repeat the imputation iteration step 'iter' times</span></span>
<span id="cb20-28">  all_imps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">accumulate</span>(</span>
<span id="cb20-29">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(iter),</span>
<span id="cb20-30">    \(imp, i) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dunnart_multiple_impute_iterate</span>(</span>
<span id="cb20-31">      data, imp, formula_list, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> verbose, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i =</span> i, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> iter</span>
<span id="cb20-32">    ),</span>
<span id="cb20-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.init =</span> imp_out</span>
<span id="cb20-34">  )</span>
<span id="cb20-35"></span>
<span id="cb20-36">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># return results</span></span>
<span id="cb20-37">  res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb20-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">m =</span> m,</span>
<span id="cb20-39">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> iter,</span>
<span id="cb20-40">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula_list =</span> formula_list,</span>
<span id="cb20-41">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">orig_data =</span> data,</span>
<span id="cb20-42">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iterations =</span> all_imps,</span>
<span id="cb20-43">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">imputations =</span> all_imps[[iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span>
<span id="cb20-44">  )</span>
<span id="cb20-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(res) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dunnart"</span></span>
<span id="cb20-46">  res</span>
<span id="cb20-47">}</span></code></pre></div>
</div>
</section>
<section id="functions-for-extracting-imputed-data" class="level3">
<h3 class="anchored" data-anchor-id="functions-for-extracting-imputed-data">Functions for extracting imputed data</h3>
<p>Define a <code>print</code> method for <code>dunnart</code> objects so that we see a nice summary instead of all of the imputed data spewed to the console:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1">print.dunnart <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(obj) {</span>
<span id="cb21-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"'dunnart' multiple imputation object:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb21-3">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" -"</span>, obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>m, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imputed datasets</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb21-4">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" -"</span>, obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>iter, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iterations</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb21-5">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" -"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>orig_data), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"observations of"</span>,</span>
<span id="cb21-6">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>orig_data), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variables</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb21-7">}</span></code></pre></div>
</div>
<p>The <code>dunnart_complete_long</code> function does something similar to the <code>complete</code> function in <code>mice</code>, returning a long-form data frame with all imputed datasets, containing a <code>.imp</code> variable identifying the imputation and a <code>.id</code> variable identifying the row within the imputation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">dunnart_complete_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(obj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iteration =</span> obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>iter) {</span>
<span id="cb22-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inherits</span>(obj, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dunnart"</span>))</span>
<span id="cb22-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.numeric</span>(iteration) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(iteration) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb22-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(iteration <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> iteration <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>iter)</span>
<span id="cb22-5"></span>
<span id="cb22-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb22-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>iterations[[iteration <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]],</span>
<span id="cb22-8">        \(dat) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(dat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.before =</span> 1L,</span>
<span id="cb22-9">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_of</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>))),</span>
<span id="cb22-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".imp"</span></span>
<span id="cb22-11">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.imp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(.imp)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">remove_rownames</span>()</span>
<span id="cb22-14">}</span></code></pre></div>
</div>
<p>The <code>dunnart_all_iters_long()</code> function does similar, but includes all intermediate iterations of the imputation process. This will be used later to create trace plots to assess imputation convergence.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">dunnart_all_iters_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(obj) {</span>
<span id="cb23-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inherits</span>(obj, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dunnart"</span>))</span>
<span id="cb23-3">  iters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>iter</span>
<span id="cb23-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb23-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(iters, \(i) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dunnart_complete_long</span>(obj, i)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb23-6">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_names</span>(iters),</span>
<span id="cb23-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".iter"</span></span>
<span id="cb23-8">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb23-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.iter =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(.iter))</span>
<span id="cb23-10">}</span></code></pre></div>
</div>
</section>
</section>
<section id="taking-it-for-a-test-ride" class="level2">
<h2 class="anchored" data-anchor-id="taking-it-for-a-test-ride">Taking it for a test ride</h2>
<p>For this example we’ll use the <code>nhanes</code> data from the <code>mice</code> package. This dataset contains four variables: <code>age</code>, <code>bmi</code>, <code>hyp</code>, and <code>chl</code>; of which <code>age</code> is completely observed but all of the others contain missing values. The variable <code>hyp</code> is an indicator variable for a binary factor but we will treat it as if it’s numeric for our imputation purposes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(nhanes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">package =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mice"</span>)</span></code></pre></div>
</div>
<p>The code below calls the <code>dunnart_impute()</code> function to obtain 5 imputed datasets, using 10 iterations. Each variable is imputed using all other variables. Unlike in <code>mice</code>, we need to specify this by providing a full regression formula for each variable to be imputed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">314159</span>)</span>
<span id="cb25-2">imp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dunnart_impute</span>(</span>
<span id="cb25-3">  nhanes,</span>
<span id="cb25-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb25-5">    bmi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> hyp <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> chl,</span>
<span id="cb25-6">    hyp <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bmi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> chl,</span>
<span id="cb25-7">    chl <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bmi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> hyp</span>
<span id="cb25-8">  ),</span>
<span id="cb25-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">m =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb25-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb25-11">)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>generating 5 initial imputations
imputation iteration 1 of 10 
  [ 1 / 5 ]  bmi  hyp  chl
  [ 2 / 5 ]  bmi  hyp  chl
  [ 3 / 5 ]  bmi  hyp  chl
  [ 4 / 5 ]  bmi  hyp  chl
  [ 5 / 5 ]  bmi  hyp  chl
imputation iteration 2 of 10 
  [ 1 / 5 ]  bmi  hyp  chl
  [ 2 / 5 ]  bmi  hyp  chl
  [ 3 / 5 ]  bmi  hyp  chl
  [ 4 / 5 ]  bmi  hyp  chl
  [ 5 / 5 ]  bmi  hyp  chl
imputation iteration 3 of 10 
  [ 1 / 5 ]  bmi  hyp  chl
  [ 2 / 5 ]  bmi  hyp  chl
  [ 3 / 5 ]  bmi  hyp  chl
  [ 4 / 5 ]  bmi  hyp  chl
  [ 5 / 5 ]  bmi  hyp  chl
imputation iteration 4 of 10 
  [ 1 / 5 ]  bmi  hyp  chl
  [ 2 / 5 ]  bmi  hyp  chl
  [ 3 / 5 ]  bmi  hyp  chl
  [ 4 / 5 ]  bmi  hyp  chl
  [ 5 / 5 ]  bmi  hyp  chl
imputation iteration 5 of 10 
  [ 1 / 5 ]  bmi  hyp  chl
  [ 2 / 5 ]  bmi  hyp  chl
  [ 3 / 5 ]  bmi  hyp  chl
  [ 4 / 5 ]  bmi  hyp  chl
  [ 5 / 5 ]  bmi  hyp  chl
imputation iteration 6 of 10 
  [ 1 / 5 ]  bmi  hyp  chl
  [ 2 / 5 ]  bmi  hyp  chl
  [ 3 / 5 ]  bmi  hyp  chl
  [ 4 / 5 ]  bmi  hyp  chl
  [ 5 / 5 ]  bmi  hyp  chl
imputation iteration 7 of 10 
  [ 1 / 5 ]  bmi  hyp  chl
  [ 2 / 5 ]  bmi  hyp  chl
  [ 3 / 5 ]  bmi  hyp  chl
  [ 4 / 5 ]  bmi  hyp  chl
  [ 5 / 5 ]  bmi  hyp  chl
imputation iteration 8 of 10 
  [ 1 / 5 ]  bmi  hyp  chl
  [ 2 / 5 ]  bmi  hyp  chl
  [ 3 / 5 ]  bmi  hyp  chl
  [ 4 / 5 ]  bmi  hyp  chl
  [ 5 / 5 ]  bmi  hyp  chl
imputation iteration 9 of 10 
  [ 1 / 5 ]  bmi  hyp  chl
  [ 2 / 5 ]  bmi  hyp  chl
  [ 3 / 5 ]  bmi  hyp  chl
  [ 4 / 5 ]  bmi  hyp  chl
  [ 5 / 5 ]  bmi  hyp  chl
imputation iteration 10 of 10 
  [ 1 / 5 ]  bmi  hyp  chl
  [ 2 / 5 ]  bmi  hyp  chl
  [ 3 / 5 ]  bmi  hyp  chl
  [ 4 / 5 ]  bmi  hyp  chl
  [ 5 / 5 ]  bmi  hyp  chl</code></pre>
</div>
</div>
<section id="diagnostics" class="level3">
<h3 class="anchored" data-anchor-id="diagnostics">Diagnostics</h3>
<section id="trace-plots" class="level4">
<h4 class="anchored" data-anchor-id="trace-plots">Trace plots</h4>
<p>The plot below shows the mean and standard deviation of the imputed values of each variable at each iteration of the imputation process. Each coloured line shows a different imputed dataset. The ‘zeroth’ iteration is the initial mean imputation step where all imputed datasets are the same. The subsequent iterations show that the imputations very quickly start ‘mixing’ well, resembling a low-resolution fuzzy caterpillar.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1">miss_rows <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> nhanes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bmi, hyp, chl), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"miss"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">miss =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(miss))</span>
<span id="cb27-5"></span>
<span id="cb27-6">trace_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dunnart_all_iters_long</span>(imp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bmi, hyp, chl), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(miss_rows, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(miss) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb27-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(value),</span>
<span id="cb27-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(value),</span>
<span id="cb27-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(.iter, .imp, var)</span>
<span id="cb27-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(.iter, .imp), as.factor))</span>
<span id="cb27-16"></span>
<span id="cb27-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_grid</span>(</span>
<span id="cb27-18">  trace_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .iter, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> .imp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> .imp)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>var, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">panel_border</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-23">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>),</span>
<span id="cb27-24">  trace_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-25">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> .iter, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> .imp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> .imp)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-26">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-27">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>var, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-28">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">panel_border</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-29">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>),</span>
<span id="cb27-30">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb27-31">)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://cameronpatrick.com/post/2023/07/mice-in-a-blog-post/index_files/figure-html/trace-plot-1.png" class="img-fluid figure-img" width="715"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="distribution-of-imputed-data" class="level4">
<h4 class="anchored" data-anchor-id="distribution-of-imputed-data">Distribution of imputed data</h4>
<p>In the plot below, the blue circles show the original (completely observed data) and the red circles showing imputed values. We can see that the imputation for ‘hyp’ isn’t ideal, with the original data only taking the values of 1 or 2, but imputed values being anywhere on the real line.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dunnart_complete_long</span>(imp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb28-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bmi, hyp, chl), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb28-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(miss_rows, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb28-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> .imp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> miss)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_colour_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodgerblue3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick3"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_grid</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>var, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_x"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">panel_border</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://cameronpatrick.com/post/2023/07/mice-in-a-blog-post/index_files/figure-html/distribution-plot-1.png" class="img-fluid figure-img" width="715"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="running-an-analysis-on-the-imputed-data" class="level2">
<h2 class="anchored" data-anchor-id="running-an-analysis-on-the-imputed-data">Running an analysis on the imputed data</h2>
<p>Running the same analysis repeatedly on the imputed data is a fairly straightforward task. The function <code>dunnart_analyse()</code> below does this. The actual work is in the line <code>res &lt;- map(obj$imputations, fn)</code> which calls a provded function on each imputation and returns the result as a list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1">dunnart_analyse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(obj, fn) {</span>
<span id="cb29-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inherits</span>(obj, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dunnart"</span>))</span>
<span id="cb29-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.function</span>(fn))</span>
<span id="cb29-4"></span>
<span id="cb29-5">  res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>imputations, fn)</span>
<span id="cb29-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(res) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dunnart_analysis"</span></span>
<span id="cb29-7">  res</span>
<span id="cb29-8">}</span></code></pre></div>
</div>
<p>As an example, let’s fit a regression model to our imputed data to predict <code>chl</code> from all other variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1">example_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dunnart_analyse</span>(</span>
<span id="cb30-2">  imp,</span>
<span id="cb30-3">  \(dat) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(chl <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bmi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> hyp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> dat)</span>
<span id="cb30-4">)</span></code></pre></div>
</div>
</section>
<section id="pooling-imputations-using-rubins-rules" class="level2">
<h2 class="anchored" data-anchor-id="pooling-imputations-using-rubins-rules">Pooling imputations using Rubin’s rules</h2>
<p>Once repeated analyses on each imputed dataset have been done, the results need to be combined into a single output. This is done using Rubin’s rules, as described in e.g. <span class="citation" data-cites="rubin1996multipleimputation18">Rubin (1996)</span>. The final pooled estimate is the mean of the estimates from each dataset, and the variance of the estimate is the mean of the estimates from each dataset plus <img src="https://latex.codecogs.com/png.latex?(m+1)/m"> times the between-imputation variance. There are some additional rules to derive the appropriate degrees of freedom for a <em>t</em> distribution but in this case we will keep things simple and just use a large-sample Normal approximation.</p>
<p>The function below implements this, taking advantage of the <code>broom::tidy()</code> function to obtain a data frame of estimates and standard errors for each model parameter. In principle a different function could be supplied (e.g.&nbsp;from the <code>emmeans</code> or <code>marginaleffects</code> package) to obtain a data frame of estimates and standard errors of any estimand of interest from a model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">dunnart_pool <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(obj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tidy_fn =</span> broom<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>tidy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conf_level =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>) {</span>
<span id="cb31-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inherits</span>(obj, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dunnart_analysis"</span>))</span>
<span id="cb31-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.function</span>(tidy_fn))</span>
<span id="cb31-4"></span>
<span id="cb31-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># apply the tidier function to each imputation dataset. this should return</span></span>
<span id="cb31-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># a data frame for each analysis output.</span></span>
<span id="cb31-7">  tidy_analysis <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb31-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(obj, tidy_fn),</span>
<span id="cb31-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".imp"</span></span>
<span id="cb31-10">  )</span>
<span id="cb31-11"></span>
<span id="cb31-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of imputed datasets (needed for Rubin's rules)</span></span>
<span id="cb31-13">  m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(obj)</span>
<span id="cb31-14"></span>
<span id="cb31-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># multiplier for confidence interval, e.g. 1.96 for 95% CI</span></span>
<span id="cb31-16">  ci_mult <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>conf_level)</span>
<span id="cb31-17"></span>
<span id="cb31-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># apply Rubin's rules and compute CIs and p-values</span></span>
<span id="cb31-19">  tidy_analysis <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb31-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb31-21">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">std.error =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(std.error<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>m <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(estimate)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb31-22">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(estimate),</span>
<span id="cb31-23">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> term</span>
<span id="cb31-24">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb31-25">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(std.error, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.after =</span> estimate) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb31-26">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb31-27">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">statistic =</span> estimate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> std.error,</span>
<span id="cb31-28">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p.value =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pnorm</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(statistic)),</span>
<span id="cb31-29">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conf.low =</span> estimate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ci_mult<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>std.error,</span>
<span id="cb31-30">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conf.high =</span> estimate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ci_mult<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>std.error</span>
<span id="cb31-31">    )</span>
<span id="cb31-32">}</span></code></pre></div>
</div>
<p>We can apply this to the regression model we fit earlier to get a table of pooled model parameters:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dunnart_pool</span>(example_model)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 7
  term        estimate std.error statistic   p.value conf.low conf.high
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 (Intercept)   -70.0      66.4     -1.05  0.291      -200.        60.1
2 age            47.7      10.9      4.37  0.0000122    26.3       69.1
3 bmi             7.12      2.32     3.07  0.00213       2.58      11.7
4 hyp            -9.92     19.8     -0.502 0.616       -48.7       28.8</code></pre>
</div>
</div>
<p>This is very similar to the results from the complete case analysis, which is reassuring:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1">broom<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(chl <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bmi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> hyp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> nhanes), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conf.int =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 7
  term        estimate std.error statistic p.value conf.low conf.high
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 (Intercept)   -81.0      61.8     -1.31  0.222    -221.        58.8
2 age            55.2      14.3      3.86  0.00383    22.9       87.5
3 bmi             7.07      2.05     3.44  0.00736     2.42      11.7
4 hyp            -6.22     23.2     -0.268 0.794     -58.7       46.2</code></pre>
</div>
</div>
</section>
<section id="references" class="level2">




</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-line-spacing="2">
<div id="ref-gelman2014bayesiandataanalysis" class="csl-entry">
Gelman, A., Carlin, J. B., Stern, H. S., Dunson, D. B., Vehtari, A., &amp; Rubin, D. B. (2014). <em>Bayesian data analysis</em> (Third edition). CRC Press.
</div>
<div id="ref-rubin1996multipleimputation18" class="csl-entry">
Rubin, D. B. (1996). Multiple Imputation after 18+ Years. <em>Journal of the American Statistical Association</em>, <em>91</em>(434), 473–489. <a href="https://doi.org/10.1080/01621459.1996.10476908">https://doi.org/10.1080/01621459.1996.10476908</a>
</div>
<div id="ref-vanbuuren2007multipleimputationdiscrete" class="csl-entry">
Van Buuren, S. (2007). Multiple imputation of discrete and continuous data by fully conditional specification. <em>Statistical Methods in Medical Research</em>, <em>16</em>(3), 219–242. <a href="https://doi.org/10.1177/0962280206074463">https://doi.org/10.1177/0962280206074463</a>
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Well, I probably met it and forgot about it long ago in undergrad Bayes class.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>statistics</category>
  <guid>https://cameronpatrick.com/post/2023/07/mice-in-a-blog-post/index.html</guid>
  <pubDate>Sun, 30 Jul 2023 14:00:00 GMT</pubDate>
</item>
<item>
  <title>Some Quarto PDF formatting tips, with particular reference to thesis writing</title>
  <dc:creator>Cameron Patrick</dc:creator>
  <link>https://cameronpatrick.com/post/2023/07/quarto-thesis-formatting/index.html</link>
  <description><![CDATA[ 




<p>I decided to write my PhD thesis in <a href="https://quarto.org/">Quarto</a>. Between my idiosyncratic standards for the PDF output and the university’s rigid requirements for what a PhD thesis ought to look like, I knew that some degree of tweaking the formatting settings would be required. I’ve never really used Quarto for PDF output before, but since I’m fairly confident using LaTeX, I figured “how hard could it possibly be”.</p>
<p>This post is a slightly elaborated version of the notes I made for myself during the process, shared in the hope that it may be useful for others who want to use Quarto to write reports or theses with idiosyncratic styling.</p>
<p>The one piece of this post that I haven’t seen spelled out anywhere else on the web is the section on additional front matter before and after the table of contents, which took a bit of LaTeX trickery to achieve. The solution I found is better than the other alternatives I’ve seen (for my purposes, anyway), because it allows you to write the front matter in Markdown instead of LaTeX and have it present in the HTML output as well as PDF.</p>
<section id="basic-principles" class="level2">
<h2 class="anchored" data-anchor-id="basic-principles">Basic principles</h2>
<ul>
<li>Start by creating a “Quarto book project” using your favourite IDE (RStudio)</li>
<li>It’s probably a good idea to use git and periodically commit as you mess with stuff, but I just YOLO’ed it until I had something I was happy with</li>
<li>You should probably <a href="https://rstudio.github.io/renv/articles/renv.html">set up <code>renv</code></a> so your package versions are tracked and reproducible. <code>renv::init()</code></li>
<li>Most of the configuration begins in editing the YAML file, <code>_quarto.yml</code></li>
<li>The most basic but also most important options are documented in the <a href="https://quarto.org/docs/reference/formats/pdf.html">Quarto PDF Options</a> section of the Quarto manual</li>
<li>Achieving more complex goals requires writing chunks of LaTeX code which you reference in the YAML (or sometimes include inline in your chapter <code>.qmd</code> files)</li>
<li>Some of what I’m explaining here wasn’t documented and required reading the Quarto source code. I am not to be held responsible for any voided warranty or code that stops working with the next release of Quarto</li>
<li>I’m assuming you have some familiarity with YAML, Markdown, and LaTeX; but not necessarily with Quarto. In other words, I’m writing for me-last-week. Good luck</li>
</ul>
</section>
<section id="bibliography-workflow" class="level2">
<h2 class="anchored" data-anchor-id="bibliography-workflow">Bibliography workflow</h2>
<p>Thanks to <a href="https://twitter.com/bmwiernik/status/1674046248041721856">Brenton Wiernik</a> and <a href="https://twitter.com/realHollanders/status/1673994887736487939">Matthijs Hollanders</a> on Twitter for pointing me in the right direction here.</p>
<ul>
<li>Use <a href="https://www.zotero.org/">Zotero</a> and the <a href="https://retorque.re/zotero-better-bibtex/">Better BibTeX for Zotero</a> plugin</li>
<li>(Aside: the <a href="http://zotfile.com/">ZotFile</a> plugin may also be useful if/when I exceed my free Zotero PDF storage limit, although I like Zotero enough I may well just give them cash for cloud storage.)</li>
<li>Set a sensible schema for naming your reference keys in the Better BibTeX settings. I’m using <code>auth.lower + year + shorttitle.lower</code> which generates keys like <code>@rubin1974estimatingcausaleffects</code></li>
<li>Set Zotero “quick copy” format to Better BibTeX Citation Key and set it to use Markdown, so you can hit Command-Shift-C to copy the citation in Markdown format</li>
<li>Export using the Better CSL YAML plugin (you can also set it to automatically update when your Zotero library changes), or use the <a href="https://github.com/paleolimbot/rbbt">R Better BibTeX</a> package to get an automatically updated bibliography export every time you knit your document (I haven’t tried this yet)</li>
<li>Grab a CSL file for your preferred bibliography and citation format and copy it into your Quarto project</li>
<li>Add <code>bibliography</code> and <code>csl</code> top-level keys to your YAML:</li>
</ul>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bibliography</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> references.yaml</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">csl</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> apa.csl</span></span></code></pre></div>
<p>I’ve also edited my <code>references.qmd</code> Markdown file which generates the bibliography so it has a ragged right margin (i.e.&nbsp;left justified, not full justified):</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># References {.unnumbered}</span></span>
<span id="cb2-2"></span>
<span id="cb2-3">\begingroup</span>
<span id="cb2-4">\raggedright</span>
<span id="cb2-5">::: {#refs}</span>
<span id="cb2-6">:::</span>
<span id="cb2-7">\endgroup</span></code></pre></div>
</section>
<section id="yeeting-the-rstudio-visual-editor" class="level2">
<h2 class="anchored" data-anchor-id="yeeting-the-rstudio-visual-editor">Yeeting the RStudio visual editor</h2>
<p>If you’re like me, and can’t stand the RStudio visual Markdown editor but accidentally clicked the “Visual editor” check box when creating the project, change your YAML to say:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">editor</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> source</span></span></code></pre></div>
<p>Instead of <code>editor: visual</code>. Or vice versa, if you prefer the visual editor.</p>
</section>
<section id="easy-pdf-tweaks-only-yaml-needed" class="level2">
<h2 class="anchored" data-anchor-id="easy-pdf-tweaks-only-yaml-needed">Easy PDF tweaks (only YAML needed)</h2>
<p>All of these go inside the <code>format:</code> → <code>pdf:</code> chunk of the YAML. They’re documented in the Quarto manual but that’s very long and sometimes unclear (partly because Quarto can produce PDF output both via LaTeX and via HTML, and different options apply to each). Here’s what I cared about enough to mess with:</p>
<ul>
<li>LaTeX document class: Quarto’s default templates will take advantage of the KOMA Script classes if you use those, and they seem to make some customisation nicer than the LaTeX packages I’ve used previously. So <code>documentclass: scrbook</code> for two-sided or <code>documentclass: scrreprt</code> for single-sided (note the lack of “o” in “scrreprt”)</li>
<li>You can change the name of the PDF file produced, e.g.&nbsp;<code>output-file: "FirstnameLastname_thesis.pdf"</code> (this one goes under the <code>book:</code> top-level YAML section, not under <code>format: pdf:</code>)</li>
<li>Set <code>keep-tex: true</code> so you can take a squiz at the generated TeX file. I found this helped when figuring out what I needed to change to bend the output to my whims</li>
<li>Enable Table of Contents, List of Figures, List of Tables; <code>toc-depth</code> of three means that the Table of Contents will show up to <code>\subsection</code> (or <code>###</code> headings in Markdown):</li>
</ul>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb4-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toc</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb4-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toc-depth</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb4-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toc-title</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Table of contents"</span></span>
<span id="cb4-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lof</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb4-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lot</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">true</span></span></code></pre></div>
<ul>
<li>Section numbering: <code>number-depth</code> appears to count differently from <code>toc-depth</code>, so the below will have numbered <code>\subsection</code> (<code>###</code>) but not <code>\subsubsection</code> (<code>####</code>):</li>
</ul>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb5-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">number-sections</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb5-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">number-depth</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span></code></pre></div>
<ul>
<li>Paper size: <code>papersize: a4</code> or you’ll get US Letter</li>
<li>Margins: you can either use the KOMA Script options (see below) which use some kind of fancy formula to derive margins, or you can specify options to the LaTeX <code>geometry</code> package in your YAML. Below is what I’m currently using, copied from my MSc thesis LaTeX preamble. I can’t remember what the header and footer bits do exactly. <code>heightrounded</code> helps prevent “underfull vbox” warnings by making sure the text height is a multiple of the line height</li>
</ul>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb6-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geometry</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb6-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> inner=3cm</span></span>
<span id="cb6-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> outer=4cm</span></span>
<span id="cb6-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> top=3cm</span></span>
<span id="cb6-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> bottom=4cm</span></span>
<span id="cb6-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> headsep=22pt</span></span>
<span id="cb6-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> headheight=11pt</span></span>
<span id="cb6-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> footskip=33pt</span></span>
<span id="cb6-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ignorehead</span></span>
<span id="cb6-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ignorefoot</span></span>
<span id="cb6-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> heightrounded</span></span></code></pre></div>
<ul>
<li>Indented paragraphs vs space between paragraphs: <code>indent: true</code> or <code>indent: false</code>. You can use KOMA Script options for greater control over the indent or skip distances but the defaults look fine to me</li>
<li>Spacing between lines: you can use e.g.&nbsp;<code>linestretch: 1.25</code> or <code>linestretch: 1.5</code> to get increased line spacing</li>
<li>As far as I can tell, you can’t choose between full justified and ragged right (left justified) in the YAML, you’ll need to add LaTeX commands to the preamble (see below)</li>
<li>Font size: set the base font size used for body text, e.g.&nbsp;<code>fontsize: 11pt</code></li>
<li>I prefer the XeLaTeX engine: <code>pdfengine: xelatex</code> because…</li>
<li>If you’re using the XeLaTeX engine, you can specify any (Unicode, TrueType/OpenType) system font if you don’t like the standard Computer Modern Roman look that screams “my document was made with TeX”. The <a href="https://www.gust.org.pl/projects/e-foundry/tg-math">TeX Gyre Math</a> font families provide OpenType math fonts compatible with XeLaTeX that fit well with Times and Palatino, amongst others. Here’s an example of using Times New Roman and other common Microsoft fonts, alongside TeX Gyre Termes Math which provides mathematical symbols which blend in nicely with these fonts:</li>
</ul>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb7-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mainfont</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Times New Roman"</span></span>
<span id="cb7-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sansfont</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Arial"</span></span>
<span id="cb7-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">monofont</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Courier New"</span></span>
<span id="cb7-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mathfont</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TeX Gyre Termes Math"</span></span></code></pre></div>
</section>
<section id="koma-script-options-fonts-headings-headers-and-footers" class="level2">
<h2 class="anchored" data-anchor-id="koma-script-options-fonts-headings-headers-and-footers">KOMA Script options: fonts, headings, headers, and footers</h2>
<p>The <a href="https://mirror.aarnet.edu.au/pub/CTAN/macros/latex/contrib/koma-script/doc/scrguide-en.pdf">KOMA Script manual</a> is comprehensive but inscrutable, and it takes a bit of messing around to find out where to put the options anyway.</p>
<p>To set these options, you’ll need to add them to what Quarto calls the LaTeX header (which I’ve always known as the LaTeX preamble). That means you need to add a line like <code>include-in-header: include-in-header.tex</code> to the PDF format options in your YAML, and then add the code here to a file called <code>include-in-header.tex</code>.</p>
<p>Here are a few things I did here:</p>
<ul>
<li>Make the headings the same font as the rest of the document, instead of sans serif: <code>\addtokomafont{disposition}{\rmfamily}</code></li>
<li>Restore the classic LaTeX chapter headings that are two lines, the first saying e.g.&nbsp;“Chapter 2” on a line before the chapter title: <code>\KOMAoptions{chapterprefix=true,appendixprefix=true}</code></li>
<li>Smaller fonts for headings: <code>\KOMAoptions{headings=small}</code></li>
<li>If you’re fussy about the size of the indent or spacing between paragraphs, you would do that here too</li>
<li>If you prefer left-justified (ragged right margin) instead of full-justified, you can do that here: <code>\raggedright</code></li>
<li>Header and footer fonts: normal upright font (instead of slanted, the KOMA Script default) and a smaller size. See <a href="https://www.sascha-frank.com/latex-font-size.html">this handy web site</a> for more info on LaTeX relative font size commands like <code>\footnotesize</code>.</li>
</ul>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode tex code-with-copy"><code class="sourceCode latex"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\setkomafont</span>{pageheadfoot}{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\normalfont\normalcolor\footnotesize</span>}</span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\setkomafont</span>{pagenumber}{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\normalfont\normalcolor\footnotesize</span>}</span></code></pre></div>
<ul>
<li>Headers and footers! For this we’ll need the <code>scrlayer-scrpage</code> package, and commands like <code>\lefoot[]{}</code> where “l” starts for left (there’s also “c” and “r”), “e” starts for even page (there’s also “o”), “foot” for footer (there’s also “head”). Inside the square brackets you put what you want on “plain” pages (start of chapter) and inside the curly braces you put what want on pages with a running-head (inside chapters). Here’s an example that gives output similar to many technical books: (1) centred page numbers (<code>\pagemark</code>) in the footer on the first page of a chapter; (2) page numbers on the outside edge of the header inside chapters; (3) chapter and section titles (“running heads”, <code>\leftmark</code> and <code>\rightmark</code>) on the inside margins:</li>
</ul>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode tex code-with-copy"><code class="sourceCode latex"><span id="cb9-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">\usepackage</span>{<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">scrlayer-scrpage</span>}</span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\lefoot</span>[]{}</span>
<span id="cb9-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\cefoot</span>[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\pagemark</span>]{}</span>
<span id="cb9-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\refoot</span>[]{}</span>
<span id="cb9-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\lofoot</span>[]{}</span>
<span id="cb9-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\cofoot</span>[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\pagemark</span>]{}</span>
<span id="cb9-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\rofoot</span>[]{}</span>
<span id="cb9-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\lehead</span>[]{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\pagemark</span>}</span>
<span id="cb9-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\cehead</span>[]{}</span>
<span id="cb9-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\rehead</span>[]{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\leftmark</span>}</span>
<span id="cb9-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\lohead</span>[]{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\rightmark</span>}</span>
<span id="cb9-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\cohead</span>[]{}</span>
<span id="cb9-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\rohead</span>[]{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\pagemark</span>}</span></code></pre></div>
<ul>
<li>Headers and footers! If you’re using single-sided output, beware: all of your pages will be considered “odd”, for some odd reason.</li>
</ul>
</section>
<section id="title-page" class="level2">
<h2 class="anchored" data-anchor-id="title-page">Title page</h2>
<p>My university has a specific requirement for the formatting of title pages, and even if it didn’t I’d still want to change the default Quarto title page because it’s kind of ugly.</p>
<p>To do this, we will once again need to write some LaTeX code. This time, rather than just adding extra code to the preamble, we’ll be replacing some of the built-in <a href="https://quarto.org/docs/journals/templates.html">Quarto Pandoc templates</a>. You can see <a href="https://github.com/quarto-dev/quarto-cli/tree/main/src/resources/formats/pdf/pandoc">what templates are available and what they contain</a> by looking at the Quarto source code (!). Ignore the seductively-named <code>title.tex</code> because to edit the title page you will need to replace <code>before-body.tex</code>. Start by adding <code>before-body.tex</code> to the <code>template-partials</code> list under <code>format: pdf:</code> in your YAML (yeesh).</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb10-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">template-partials</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb10-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> before-body.tex</span></span></code></pre></div>
<p>Then, in <code>before-body.tex</code>, we’ll add the code to create the title page. You’ll notice that this isn’t quite normal LaTeX, there’s some kind of crazy templating language going on, with directives inside pairs of <code>$</code> signs. I’m not aware of any documentation on this, I just pieced it together from reading other Quarto templates.</p>
<p>The first few lines (copied from the <a href="https://github.com/quarto-dev/quarto-cli/blob/main/src/resources/formats/pdf/pandoc/before-body.tex">standard Quarto template</a>) enable <em>front matter</em> mode in LaTeX, which causes pages to be numbered in roman numerals instead of normal (arabic) digits. Later on, <code>\mainmatter</code> will cause the page numbering to restart from 1. The remainder of the code is LaTeX code to generate the title page, with a bit of cleverness to pull the title and author information out of the YAML. Instead of just using <code>\maketitle</code> built into LaTeX, we’ll make our own title page from scratch.</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode tex code-with-copy"><code class="sourceCode latex"><span id="cb11-1"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$if(has-frontmatter)$</span></span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\frontmatter</span></span>
<span id="cb11-3"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$endif$</span></span>
<span id="cb11-4"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$if(title)$</span></span>
<span id="cb11-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\cleardoublepage</span></span>
<span id="cb11-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\thispagestyle</span>{empty}</span>
<span id="cb11-7">{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\centering</span></span>
<span id="cb11-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\hbox</span>{}<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\vskip</span> 0cm plus 1fill</span>
<span id="cb11-9">{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\Huge\bfseries</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$title$</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\par</span>}</span>
<span id="cb11-10"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$if(subtitle)$</span></span>
<span id="cb11-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\vspace</span>{3ex}</span>
<span id="cb11-12">{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\Large\bfseries</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$subtitle$</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\par</span>}</span>
<span id="cb11-13"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$endif$</span></span>
<span id="cb11-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\vspace</span>{12ex}</span>
<span id="cb11-15"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$for(by-author)$</span></span>
<span id="cb11-16">{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\Large\bfseries</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$by-author.name.literal$</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\par</span>}</span>
<span id="cb11-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\vspace</span>{3ex}</span>
<span id="cb11-18">{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\Large</span> ORCID: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$by-author.orcid$</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\par</span>}</span>
<span id="cb11-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\vskip</span> 0cm plus 2fill</span>
<span id="cb11-20">{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\bfseries\large</span> Doctor of Philosophy <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\par</span>}</span>
<span id="cb11-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\vspace</span>{3ex}</span>
<span id="cb11-22">{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\bfseries\large</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$date$</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\par</span>}</span>
<span id="cb11-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\vspace</span>{12ex}</span>
<span id="cb11-24"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$for(by-author.affiliations)$</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span></span>
<span id="cb11-25"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$if(it.department)$</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span></span>
<span id="cb11-26">{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\bfseries\large</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$it.department$</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\par</span>}</span>
<span id="cb11-27"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\vspace</span>{3ex}</span>
<span id="cb11-28"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$endif$</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span></span>
<span id="cb11-29">{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\bfseries\large</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$it.name$</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\par</span>}</span>
<span id="cb11-30"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$endfor$$endfor$</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span></span>
<span id="cb11-31"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\vspace</span>{12ex}</span>
<span id="cb11-32">{<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\small</span> Submitted in total fulfilment of the requirements</span>
<span id="cb11-33">of the degree of Doctor of Philosophy <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\par</span>}</span>
<span id="cb11-34">}</span>
<span id="cb11-35"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$endif$</span></span></code></pre></div>
<p>To go along with this, you’ll also need to provide appropriate information in the <code>book:</code> section of the YAML:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">book</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb12-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">title</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PhD thesis main title"</span></span>
<span id="cb12-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subtitle</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Clever subtitle probably with a pun"</span></span>
<span id="cb12-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">author</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb12-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cameron James Patrick"</span></span>
<span id="cb12-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">orcid</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0000-0002-4677-535X"</span></span>
<span id="cb12-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">affiliations</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb12-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The University of Melbourne"</span></span>
<span id="cb12-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">department</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Department of Paediatrics"</span></span>
<span id="cb12-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"01 June 2026"</span></span>
<span id="cb12-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date-format</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MMMM YYYY"</span></span></code></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://cameronpatrick.com/post/2023/07/quarto-thesis-formatting/title-page.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Here’s one I prepared earlier. Or will eventually have prepared, or something. Still have to write the damned thing.</figcaption>
</figure>
</div>
</section>
<section id="sec-additional-front-matter" class="level2">
<h2 class="anchored" data-anchor-id="sec-additional-front-matter">Additional front matter before and after the table of contents</h2>
<p>According to my university, a PhD thesis needs to contain the following items, in this order: title page, abstract, authorship declaration, preface, acknowledgements, table of contents, list of tables, list of figures, abbreviations; the body of the thesis; references; and finally appendices.</p>
<p>Unfortunately, the default Quarto template places the table of contents immediately after the title page. To change this, we’ll need to edit another “template partial”, this time <code>toc.tex</code>. In the YAML:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb13-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pdf</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb13-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">template-partials</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb13-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> before-body.tex</span></span>
<span id="cb13-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> toc.tex</span></span></code></pre></div>
<p>Then in <code>toc.tex</code>:</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode tex code-with-copy"><code class="sourceCode latex"><span id="cb14-1"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$if(toc)$</span></span>
<span id="cb14-2"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$if(toc-title)$</span></span>
<span id="cb14-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\renewcommand*\contentsname</span>{<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$toc-title$</span>}</span>
<span id="cb14-4"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$endif$</span></span>
<span id="cb14-5"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$if(colorlinks)$</span></span>
<span id="cb14-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\hypersetup</span>{linkcolor=<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$if(toccolor)$$toccolor$$else$$endif$</span>}</span>
<span id="cb14-7"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$endif$</span></span>
<span id="cb14-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\setcounter</span>{tocdepth}{<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$toc-depth$</span>}</span>
<span id="cb14-9"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$endif$</span></span>
<span id="cb14-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\renewcommand*\listfigurename</span>{List of figures}</span>
<span id="cb14-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\renewcommand*\listtablename</span>{List of tables}</span></code></pre></div>
<p>If you compare the above to the <a href="https://github.com/quarto-dev/quarto-cli/blob/main/src/resources/formats/pdf/pandoc/toc.tex">standard Quarto <code>toc.tex</code> template</a> you’ll see that I’ve removed a heap of code. Some of that code was for presentations but most importantly I removed the <code>\tableofcontents</code>, <code>\listoffigures</code> and <code>\listoftables</code> commands which actually produce the table of contents and lists of figures and tables. (I’ve also added some bonus code to make the “List of figures” and “List of tables” headings in sentence case instead of title case, all modern-like.)</p>
<p>We’ll also need to stop Quarto from switching from <code>\frontmatter</code> to <code>\mainmatter</code> at around this point. I couldn’t find the partial template that was responsible for this, so instead I added these two lines of LaTeX to the end of <code>before-body.tex</code>:</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode tex code-with-copy"><code class="sourceCode latex"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\let\mainmatterreal\mainmatter</span></span>
<span id="cb15-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\let\mainmatter\relax</span></span></code></pre></div>
<p>The above code effectively neuters the <code>\mainmatter</code> command, until we’re ready to bring it back to life.</p>
<p>Now we can write the ‘chapters’ that make our extra front matter. These can be written just like normal Quarto chapters, though I added <code>{.unnumbered .unlisted}</code> to the end of the chapter headings so they don’t get chapter numbers and aren’t included in the table of contents.</p>
<p>At the end of the last section before the table of contents should appear — <code>acknowledgements.qmd</code> in my case — add the following LaTeX code to generate table of contents (and list of tables and list of figures, if desired):</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode tex code-with-copy"><code class="sourceCode latex"><span id="cb16-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\tableofcontents</span></span>
<span id="cb16-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\listoftables</span></span>
<span id="cb16-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\listoffigures</span></span></code></pre></div>
<p>Finally, at the end of the last front matter section — <code>abbreviations.qmd</code> in my case — add this code to return the <code>\mainmatter</code> command to life and run it, causing the main section of the document to have ordinary page numbers, starting from 1 again:</p>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode tex code-with-copy"><code class="sourceCode latex"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\let\mainmatter\mainmatterreal</span></span>
<span id="cb17-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">\mainmatter</span></span></code></pre></div>
</section>
<section id="html-output" class="level2">
<h2 class="anchored" data-anchor-id="html-output">HTML output</h2>
<p>One nice thing about Quarto is that it can produce multiple output formats from the same input. I find the HTML output particularly convenient for on-screen previewing. I haven’t messed with the appearance of the HTML output much, but here’s the YAML chunk I’m using at the moment:</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb18-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb18-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb18-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> simplex</span></span>
<span id="cb18-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fontsize</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> 1.2em</span></span>
<span id="cb18-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">linestretch</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.7</span></span>
<span id="cb18-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mainfont</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Helvetica Neue, Helvetica, Arial, sans</span></span>
<span id="cb18-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">monofont</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Cascadia Mono, Menlo, Consolas, Courier New, Courier</span></span>
<span id="cb18-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">backgroundcolor</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span></span>
<span id="cb18-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fontcolor</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span></span>
<span id="cb18-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">knitr</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb18-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">opts_chunk</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb18-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dev</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ragg_png"</span></span></code></pre></div>
<p>I will probably end up writing a CSS stylesheet at some point as a form of procrastination.</p>
<section id="setting-the-output-directory" class="level3">
<h3 class="anchored" data-anchor-id="setting-the-output-directory">Setting the output directory</h3>
<p>You can change the directory that the HTML and other outputs are saved to. This may be useful if, for example, you want to use GitHub Pages to publish your document as a web site. GitHub Pages expects the HTML to either be in the repository root or a “docs” subdirectory:</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">project</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb19-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> book</span></span>
<span id="cb19-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">output-dir</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"docs"</span></span></code></pre></div>


</section>
</section>

 ]]></description>
  <category>quarto</category>
  <category>latex</category>
  <guid>https://cameronpatrick.com/post/2023/07/quarto-thesis-formatting/index.html</guid>
  <pubDate>Sun, 16 Jul 2023 14:00:00 GMT</pubDate>
</item>
<item>
  <title>You are what you ATE: Choosing an effect size measure for binary outcomes</title>
  <dc:creator>Cameron Patrick</dc:creator>
  <link>https://cameronpatrick.com/post/2023/07/logit-rd-rr/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>When summarising the effect of a treatment or intervention on an outcome measured on a continuous scale, it’s almost ubiquitous to represent the Average Treatment Effect (ATE) in the form of a difference of means between the treatment and control groups. When the outcome is binary (yes or no, event occurred or event did not occur), there are three commonly-used measures. The risk difference, also known as absolute risk reduction or difference of proportions, is an absolute measure of effect size: the proportion in one group minus the proportion in the other group. The relative risk, also known as the risk ratio, is a relative measure of effect size: the proportion in one group divided by the proportion in the other group. Finally, there is the odds ratio, another relative measure of effect: the odds in one group divided by the odds in the other group. The odds ratio is the odd one out in a few ways, and a bit more controversial.</p>
<p>In the first half of this post, I’ll dive into the controversy. In the middle, I’ll summarise the arguments using a meme. In the second half, I’ll work through an example of estimating odds ratios, risk differences, and relative risks in a simulated example, showing R code examples and hand-calculations. I’m taking a particular interest in the application to randomised controlled trials (RCTs) but most of the issues discussed here apply more broadly.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What’s an odds, anyway?
</div>
</div>
<div class="callout-body-container callout-body">
<p>An odds is the probability of an event occurring divided by the probability of it not occurring. For example, a 50% chance corresponds to an odds of 0.5/0.5 = 1; a 75% chance corresponds to an odds of 0.75/0.25 = 3; a 25% chance corresponds to an odds of 0.25/0.75 = 1/3. Odds are common in gambling and often expressed as ratios, e.g.&nbsp;1:1, 3:1 or 1:3. Odds ratios are ratios of oddses<sup>1</sup>. For example, a change from a 50% proportion to a 75% proportion would be a change from an odds of 1 to an odds of 3, representing an odds ratio of 3/1 = 3.</p>
</div>
</div>
</section>
<section id="the-great-odds-ratio-debate" class="level2">
<h2 class="anchored" data-anchor-id="the-great-odds-ratio-debate">The great odds ratio debate</h2>
<p>A lot of noise has been made about why an odds ratio may not be a desirable summary for a treatment effect on a binary variable<sup>2</sup>. One of the biggest practical problems is that normal humans are unable to correctly interpret an odds ratio <span class="citation" data-cites="altman1998oddsratiosshould">(Altman et al., 1998)</span>. But for statisticians, there are also deeper concerns to worry about.</p>
<p>In recent years, people<sup>3</sup> have become more aware of the mathematical fact of noncollapsibility <span class="citation" data-cites="greenland1999confoundingcollapsibilitycausal daniel2021makingapplesoranges morris2022planningmethodcovariate">(Daniel et al., 2021; Greenland et al., 1999; Morris et al., 2022)</span>: the marginal<sup>4</sup> odds ratio (population-level odds ratio) is not any kind of average of conditional odds ratios (individual-level odds ratios). Marginal odds ratios are the ones you might calculate directly from summary tables. Where do conditional odds ratios come from? They are artefacts of statistical models — logistic regression models, specifically. In the context of a randomised trial, these models predict the probability of an event occurring for each participant based on their treatment assignment and other variables measured prior to treatment (usually demographic characteristics, but could be any variable that is informative of the outcome)<sup>5</sup>. The second half of this post shows a worked example where every participant has the same conditional odds ratio of treatment, but the conditional odds ratio is not equal to the marginal odds ratio.</p>
<p>The problem of noncollapsibility is relevant to the analysis and reporting of randomised controlled trials. The <a href="https://database.ich.org/sites/default/files/E9-R1_Step4_Guideline_2019_1203.pdf">ICH E9(R1) estimand framework for clinical trials</a> requires a “population-level summary” be defined for each outcome without reference to method used to estimate it. In the language of causal inference, that’s describing an Average Treatment Effect (ATE), and the odds ratio isn’t one<sup>6</sup>.</p>
<p>Risk differences (the difference in probability attributable to a particular treatment) and relative risks (the ratio of probabilities due to a particular treatment) avoid both the interpretability and noncollapsibility problems of odds ratios. However, statisticians are usually taught to analyse binary outcomes using logistic regression, the direct output<sup>7</sup> of which is odds ratios, so odds ratios are ubiquitous in the research literature. Someone on Stats Twitter rediscovers all of this every few months and starts a heated argument where nobody goes away happy.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://cameronpatrick.com/post/2023/07/logit-rd-rr/building-collapse.jpg" class="img-fluid figure-img" alt="Picture of a collapsing building with the caption &quot;I'll take the non-collapsible one&quot;"></p>
<figcaption class="figure-caption">Surprisingly, many statisticians prefer collapsibility.</figcaption>
</figure>
</div>
<p>Personally, I’m a fan of risk differences for communicating potential risks to an individual, ideally presented alongside the baseline level of risk. There’s some evidence that patients and clinicians find these measures easier to interpret than relative measures <span class="citation" data-cites="zipkin2014evidencebasedriskcommunication">(Zipkin et al., 2014)</span>, especially when presented in the form of a natural frequency, like “6 in 1000 people” rather than “0.6%”.</p>
<p>So, with all those disadvantages, will anyone speak up in support of odds ratios? Should we all hang up our logistic regression hats for good?</p>
</section>
<section id="in-defense-of-logistic-regression" class="level2">
<h2 class="anchored" data-anchor-id="in-defense-of-logistic-regression">In defense of logistic regression</h2>
<p>Statistical analyses are often adjusted for covariates, either to reduce confounding (in observational studies) or improve power (in randomised trials). Adjusting for covariates requires specifying some kind of model. If we’re using a generalised linear model<sup>8</sup>, the mathematical form of covariate adjustment will depend on whether you are modelling log-odds (logistic regression model, where model parameters correspond to an odds ratio), probability (linear probability model, where model parameters correspond to a risk difference) or log-probability (quasi-Poisson or log-link binomial model, where model parameters correspond to a relative risk). When modelling risk differences or relative risks directly, it’s possible to end up with impossible predicted probabilities: “probabilities” which are less than zero or greater than one. Using logistic regression avoids this problem, because any real number on the log-odds scale translates to a probability between zero and one. Any odds ratio can be applied to any level of baseline risk without making mathematicians sad<sup>9</sup>.</p>
<p>There are also compelling — but not universally accepted — arguments that despite the difficulty in interpreting odds ratios, conditional odds ratios are more likely to be transportable between different levels of baseline risk than risk differences or relative risks <span class="citation" data-cites="doi2022controversydebatequestionable senn2011uneasereasonsmistrusting">(Doi et al., 2022; Senn, 2011)</span>. This is an empirical matter, not a mathematical one, and the evidence is not clear-cut. If we accept this, though, it is another reason to prefer logistic regression for statistical modelling. Effect size measures being “transportable” is another way of saying that the effects are closer to being additive on the scale that effect measure lives on (probability, log-probability, or log-odds). In the context of regression models, using a scale where the effect size is more transportable reduces the need for interaction terms, which can only be estimated well in large samples.</p>
<p>It’s possible to model the data using logistic regression, and then use that model to produce other quantities of interest, such as average risk differences. This approach is described in <span class="citation" data-cites="permutt2020covariateschangeestimand">Permutt (2020)</span>, which has some of the best writing I’ve encountered in a statistics paper — being written in the form of a dialogue between a randomiser (the “causal inference” perspective) and a parameteriser (the “statistical modelling” perspective) walking through the Garden of Eden, planning to conduct and analyse a clinical trial. Does this method give us the best of both worlds: the modelling advantages of logistic regression and the interpretability advantages of risk differences and relative risks?</p>
<p><span class="citation" data-cites="permutt2020covariateschangeestimand">Permutt (2020)</span> also considered what information different audiences might want from the results of a clinical trial: regulator, patient, and scientist. There’s a fourth audience which I think is worth considering, only very briefly mentioned by Permutt: the meta-analyst, trying to aggregate information from multiple trials.</p>
<p>Permutt argues in favour of the ATE being the main quantity of regulatory interest:</p>
<blockquote class="blockquote">
<p>The average treatment effect should be of regulatory interest, however. The primary analysis of outcome should be of a variable that is reasonably linear in utility to the patient. Then, if and only if the average effect is positive, the ensemble of patients can be said to be better off under the test condition than under the control. This is perhaps the weakest imaginable statistical condition for approval of a drug product, but it is surely a necessary condition.</p>
</blockquote>
<p>Permutt notes that studies designed to be able to detect average treatment effects are unlikely to be adequate for patient-specific decision making or providing a more detailed scientific understanding.</p>
<p>The most clearly expressed counter-argument to this comes from <a href="https://www.fharrell.com/post/rdist/">a blog post by Frank Harrell arguing against single-number summaries for treatment effects on binary outcomes</a>:</p>
<blockquote class="blockquote">
<p>Marginal adjusted estimates may be robust, but may not accurately estimate RD for either any patient in the RCT or for the clinical population to which RCT results are to be applied, because in effect they assume that the RCT sample is a random sample from the clinical population, something not required and never realized for RCTs.</p>
</blockquote>
<p>This refers to the distinction between the population average treatment effect (PATE) and the sample average treatment effect (SATE). RCT participants are not random samples from any population, not even from the eligible pool of participants for a particular study. But the regulator’s decision that Permutt described earlier is motivated by generalising to a broader population, implicitly relying on properties of the PATE. It’s not clear to me whether there are likely to be any real-world scenarios where both (1) the practical conclusions drawn from the SATE and PATE would be different; and (2) the conditional odds ratio derived from the RCT sample is in agreement with the PATE but the risk difference SATE is not.</p>
<p>I am a coward and not (yet?) willing to take a strong position in this fight, but am always sympathetic to the idea that a single number is rarely sufficient to describe scientific evidence (see also: p-values). At some point I might write another blog about Harrell’s idea of plotting the distribution of estimated patient-level treatment effects, which is intriguing, although I struggle to see the practical purpose of it. Harrell’s other writing on this topic is also worth reading:</p>
<ul>
<li><a href="https://www.fharrell.com/post/robcov/">Incorrect Covariate Adjustment May Be More Correct than Adjusted Marginal Estimates</a> makes a similar point to <span class="citation" data-cites="white2021covariateadjustmentrandomised">White et al. (2021)</span> with a detailed simulated example;</li>
<li><a href="https://www.fharrell.com/post/varyor/">Assessing Heterogeneity of Treatment Effect, Estimating Patient-Specific Efficacy, and Studying Variation in Odds ratios, Risk Ratios, and Risk Differences</a> argues in favour of the use of odds ratios for modelling, and points out the extreme difficulty of identifying heterogeneous treatment effects even in very large studies; and</li>
<li><a href="https://www.fharrell.com/post/marg/">Unadjusted Odds Ratios are Conditional</a> demonstrates noncollapsibility and argues that conditional odds ratios are more useful than marginal odds ratios.</li>
</ul>
<p>One issue which I remain unclear about is whether randomised trials powered to detect main treatment effects are likely to provide reasonable estimates of patient-specific baseline risk — a simpler task than patient-specific treatment effects, but still outside of the usual design remit for an efficacy trial. Common analytical approaches for clinical trials have good properties for estimating average treatment effects when the covariates are regarded as nuisance parameters <span class="citation" data-cites="white2021covariateadjustmentrandomised">(White et al., 2021)</span>, but are not guaranteed to perform so well if the effects of the covariates are themselves of interest.</p>
<p>Finally, there is the meta-analytic perspective to consider. An effect size which is less heterogeneous between studies is once again desirable. If arguments about the transportability of odds ratios by the Harrell, Senn, Doi, and others are to be believed, we should report conditional odds ratios, as those are likely to be the most useful for meta-analysts. The CONSORT guidelines for reporting randomised trials <span class="citation" data-cites="moher2010consort2010explanation">(Moher et al., 2010)</span> state that both absolute and relative effect sizes should be reported for binary outcomes. I think there is merit in reporting all commonly-used effect size measures: risk difference, relative risk, and odds ratio. This provides the most flexibility for future meta-analysts.</p>
</section>
<section id="summary-in-meme-format" class="level2">
<h2 class="anchored" data-anchor-id="summary-in-meme-format">Summary, in meme format</h2>
<p>If all of that was a bit much to take in, maybe this will help:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://cameronpatrick.com/post/2023/07/logit-rd-rr/american-chopper-argument.jpeg" class="img-fluid figure-img" alt="American Chopper argument meme: risk differences aren't transportable / nobody understands odds ratios / clinical trials aren't random samples from the population / marginal odds ratios aren't the average of conditional odds ratios / conditional odds ratios still tell us if an intervention works"></p>
<figcaption class="figure-caption">True facts on both sides.</figcaption>
</figure>
</div>
<p>In the rest of this post I’ll demonstrate how odds ratios are noncollapsible and show how to calculate risk differences and relative risks from logistic regression models using R and the <code>marginaleffects</code> package.</p>
</section>
<section id="an-example" class="level2">
<h2 class="anchored" data-anchor-id="an-example">An example</h2>
<p>This is the story of some hypothetical researchers who did a randomised controlled trial (RCT) where 560 patients were randomly assigned to either a treatment or control condition. The primary outcome of the trial was a binary measure, indicating whether a patient’s condition had worsened after 6 weeks. The scenario is based on <a href="https://www.fharrell.com/post/marg/">one from Frank Harrell’s blog</a>, with the details changed and embellished.</p>
<p>The hidden R code block below loads some R packages and sets up some simulated data for this trial.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gt)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gtsummary)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(broom)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(cowplot)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(marginaleffects)</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(</span>
<span id="cb1-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_cowplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">font_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rel_large =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rel_small =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rel_tiny =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-10">)</span>
<span id="cb1-11"></span>
<span id="cb1-12">rct_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb1-13">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>treatment, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>risk, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>outcome_prob,</span>
<span id="cb1-14">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Control"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Low risk"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,</span>
<span id="cb1-15">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Control"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"High risk"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb1-16">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Treatment"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Low risk"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb1-17">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Treatment"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"High risk"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb1-18">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb1-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(treatment, risk), fct_inorder)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb1-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb1-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reframe</span>(</span>
<span id="cb1-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(outcome_prob, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> outcome_prob)))</span>
<span id="cb1-23">  )</span></code></pre></div>
</details>
</div>
<p>Looking at a 2-way table of our hypothetical trial, we can see that the worse outcome (“1”) is more common in the control group (37%) than the treatment group (30%). This is an absolute risk reduction of 7%, a promising sign that our treatment may be beneficial.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tbl_cross</span>(rct_data, outcome, treatment, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">percent =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"column"</span>)</span></code></pre></div>
<div class="cell-output-display">

<div id="zgyfeqjfuq" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#zgyfeqjfuq table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#zgyfeqjfuq thead, #zgyfeqjfuq tbody, #zgyfeqjfuq tfoot, #zgyfeqjfuq tr, #zgyfeqjfuq td, #zgyfeqjfuq th {
  border-style: none;
}

#zgyfeqjfuq p {
  margin: 0;
  padding: 0;
}

#zgyfeqjfuq .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#zgyfeqjfuq .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#zgyfeqjfuq .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#zgyfeqjfuq .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#zgyfeqjfuq .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zgyfeqjfuq .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zgyfeqjfuq .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zgyfeqjfuq .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#zgyfeqjfuq .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#zgyfeqjfuq .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#zgyfeqjfuq .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#zgyfeqjfuq .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#zgyfeqjfuq .gt_spanner_row {
  border-bottom-style: hidden;
}

#zgyfeqjfuq .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#zgyfeqjfuq .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#zgyfeqjfuq .gt_from_md > :first-child {
  margin-top: 0;
}

#zgyfeqjfuq .gt_from_md > :last-child {
  margin-bottom: 0;
}

#zgyfeqjfuq .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#zgyfeqjfuq .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#zgyfeqjfuq .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#zgyfeqjfuq .gt_row_group_first td {
  border-top-width: 2px;
}

#zgyfeqjfuq .gt_row_group_first th {
  border-top-width: 2px;
}

#zgyfeqjfuq .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zgyfeqjfuq .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#zgyfeqjfuq .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#zgyfeqjfuq .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zgyfeqjfuq .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zgyfeqjfuq .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#zgyfeqjfuq .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#zgyfeqjfuq .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#zgyfeqjfuq .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zgyfeqjfuq .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zgyfeqjfuq .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zgyfeqjfuq .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zgyfeqjfuq .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zgyfeqjfuq .gt_left {
  text-align: left;
}

#zgyfeqjfuq .gt_center {
  text-align: center;
}

#zgyfeqjfuq .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#zgyfeqjfuq .gt_font_normal {
  font-weight: normal;
}

#zgyfeqjfuq .gt_font_bold {
  font-weight: bold;
}

#zgyfeqjfuq .gt_font_italic {
  font-style: italic;
}

#zgyfeqjfuq .gt_super {
  font-size: 65%;
}

#zgyfeqjfuq .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#zgyfeqjfuq .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#zgyfeqjfuq .gt_indent_1 {
  text-indent: 5px;
}

#zgyfeqjfuq .gt_indent_2 {
  text-indent: 10px;
}

#zgyfeqjfuq .gt_indent_3 {
  text-indent: 15px;
}

#zgyfeqjfuq .gt_indent_4 {
  text-indent: 20px;
}

#zgyfeqjfuq .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings gt_spanner_row">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="2" colspan="1" scope="col" id=""></th>
      <th class="gt_center gt_columns_top_border gt_column_spanner_outer" rowspan="1" colspan="2" scope="colgroup" id="treatment">
        <span class="gt_column_spanner">treatment</span>
      </th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="2" colspan="1" scope="col" id="Total">Total</th>
    </tr>
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Control">Control</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Treatment">Treatment</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="label" class="gt_row gt_left">outcome</td>
<td headers="stat_1" class="gt_row gt_center"></td>
<td headers="stat_2" class="gt_row gt_center"></td>
<td headers="stat_0" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;0</td>
<td headers="stat_1" class="gt_row gt_center">176 (63%)</td>
<td headers="stat_2" class="gt_row gt_center">196 (70%)</td>
<td headers="stat_0" class="gt_row gt_center">372 (66%)</td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;1</td>
<td headers="stat_1" class="gt_row gt_center">104 (37%)</td>
<td headers="stat_2" class="gt_row gt_center">84 (30%)</td>
<td headers="stat_0" class="gt_row gt_center">188 (34%)</td></tr>
    <tr><td headers="label" class="gt_row gt_left">Total</td>
<td headers="stat_1" class="gt_row gt_center">280 (100%)</td>
<td headers="stat_2" class="gt_row gt_center">280 (100%)</td>
<td headers="stat_0" class="gt_row gt_center">560 (100%)</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>Just looking at a table won’t convince anybody, though. At this point, our hypothetical researchers asked a statistician to help out<sup>10</sup>. The hypothetical statistician immediately realised the need to estimate the treatment effect in some way that also quantified its uncertainty. A binary logistic regression model seemed like a suitable way to examine the effect of the treatment on the outcome.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">lrm_unadj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(</span>
<span id="cb3-2">  outcome <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> treatment,</span>
<span id="cb3-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> binomial,</span>
<span id="cb3-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rct_data</span>
<span id="cb3-5">)</span></code></pre></div>
</div>
<p>The table below shows the results of this logistic regression: an odds ratio of 0.73 (95% CI: 0.51 to 1.03). The odds ratio being less than 1 indicates that the treatment was beneficial (since the outcome occurring was bad, in this case) but the p-value of 0.074 indicates this effect is not statistically significant. The researchers were sad, their dreams of publishing in the British Medical Journal scuppered.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tbl_regression</span>(lrm_unadj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exponentiate =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
<div class="cell-output-display">

<div id="tejhapztto" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#tejhapztto table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#tejhapztto thead, #tejhapztto tbody, #tejhapztto tfoot, #tejhapztto tr, #tejhapztto td, #tejhapztto th {
  border-style: none;
}

#tejhapztto p {
  margin: 0;
  padding: 0;
}

#tejhapztto .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#tejhapztto .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#tejhapztto .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#tejhapztto .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#tejhapztto .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#tejhapztto .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#tejhapztto .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#tejhapztto .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#tejhapztto .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#tejhapztto .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#tejhapztto .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#tejhapztto .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#tejhapztto .gt_spanner_row {
  border-bottom-style: hidden;
}

#tejhapztto .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#tejhapztto .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#tejhapztto .gt_from_md > :first-child {
  margin-top: 0;
}

#tejhapztto .gt_from_md > :last-child {
  margin-bottom: 0;
}

#tejhapztto .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#tejhapztto .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#tejhapztto .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#tejhapztto .gt_row_group_first td {
  border-top-width: 2px;
}

#tejhapztto .gt_row_group_first th {
  border-top-width: 2px;
}

#tejhapztto .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#tejhapztto .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#tejhapztto .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#tejhapztto .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#tejhapztto .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#tejhapztto .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#tejhapztto .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#tejhapztto .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#tejhapztto .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#tejhapztto .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#tejhapztto .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#tejhapztto .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#tejhapztto .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#tejhapztto .gt_left {
  text-align: left;
}

#tejhapztto .gt_center {
  text-align: center;
}

#tejhapztto .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#tejhapztto .gt_font_normal {
  font-weight: normal;
}

#tejhapztto .gt_font_bold {
  font-weight: bold;
}

#tejhapztto .gt_font_italic {
  font-style: italic;
}

#tejhapztto .gt_super {
  font-size: 65%;
}

#tejhapztto .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#tejhapztto .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#tejhapztto .gt_indent_1 {
  text-indent: 5px;
}

#tejhapztto .gt_indent_2 {
  text-indent: 10px;
}

#tejhapztto .gt_indent_3 {
  text-indent: 15px;
}

#tejhapztto .gt_indent_4 {
  text-indent: 20px;
}

#tejhapztto .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="<strong>Characteristic</strong>"><strong>Characteristic</strong></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>OR</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>"><strong>OR</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>95% CI</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>"><strong>95% CI</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>p-value</strong>"><strong>p-value</strong></th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="label" class="gt_row gt_left">treatment</td>
<td headers="estimate" class="gt_row gt_center"></td>
<td headers="ci" class="gt_row gt_center"></td>
<td headers="p.value" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;Control</td>
<td headers="estimate" class="gt_row gt_center">—</td>
<td headers="ci" class="gt_row gt_center">—</td>
<td headers="p.value" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;Treatment</td>
<td headers="estimate" class="gt_row gt_center">0.73</td>
<td headers="ci" class="gt_row gt_center">0.51, 1.03</td>
<td headers="p.value" class="gt_row gt_center">0.074</td></tr>
  </tbody>
  
  <tfoot class="gt_footnotes">
    <tr>
      <td class="gt_footnote" colspan="4"><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span> OR = Odds Ratio, CI = Confidence Interval</td>
    </tr>
  </tfoot>
</table>
</div>
</div>
</div>
</section>
<section id="adding-a-covariate" class="level2">
<h2 class="anchored" data-anchor-id="adding-a-covariate">Adding a covariate</h2>
<p>Just as the statistician was finishing writing up the results, the researchers mentioned that the patients they recruited came from two different groups, one of which was known to have much worse outcomes than the other.</p>
<p>“Does that matter?” they asked.</p>
<p>“Well, using this information could improve your statistical power” said the statistician.</p>
<p>The statistician made another 2-way table, stratified by the risk group. Through some fluke, exactly half of the trial sample was low risk and the other half high risk, perfectly balanced across treatment arms. It turned out that while only 14% of the low risk patients in the control arm experienced the worse outcome, 60% of the high risk patients in the control arm experienced that outcome.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tbl_strata</span>(rct_data, risk, tbl_cross, outcome, treatment, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">percent =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"column"</span>)</span></code></pre></div>
<div class="cell-output-display">

<div id="eaksmevbjq" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#eaksmevbjq table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#eaksmevbjq thead, #eaksmevbjq tbody, #eaksmevbjq tfoot, #eaksmevbjq tr, #eaksmevbjq td, #eaksmevbjq th {
  border-style: none;
}

#eaksmevbjq p {
  margin: 0;
  padding: 0;
}

#eaksmevbjq .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#eaksmevbjq .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#eaksmevbjq .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#eaksmevbjq .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#eaksmevbjq .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#eaksmevbjq .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#eaksmevbjq .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#eaksmevbjq .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#eaksmevbjq .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#eaksmevbjq .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#eaksmevbjq .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#eaksmevbjq .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#eaksmevbjq .gt_spanner_row {
  border-bottom-style: hidden;
}

#eaksmevbjq .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#eaksmevbjq .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#eaksmevbjq .gt_from_md > :first-child {
  margin-top: 0;
}

#eaksmevbjq .gt_from_md > :last-child {
  margin-bottom: 0;
}

#eaksmevbjq .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#eaksmevbjq .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#eaksmevbjq .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#eaksmevbjq .gt_row_group_first td {
  border-top-width: 2px;
}

#eaksmevbjq .gt_row_group_first th {
  border-top-width: 2px;
}

#eaksmevbjq .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#eaksmevbjq .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#eaksmevbjq .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#eaksmevbjq .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#eaksmevbjq .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#eaksmevbjq .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#eaksmevbjq .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#eaksmevbjq .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#eaksmevbjq .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#eaksmevbjq .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#eaksmevbjq .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#eaksmevbjq .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#eaksmevbjq .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#eaksmevbjq .gt_left {
  text-align: left;
}

#eaksmevbjq .gt_center {
  text-align: center;
}

#eaksmevbjq .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#eaksmevbjq .gt_font_normal {
  font-weight: normal;
}

#eaksmevbjq .gt_font_bold {
  font-weight: bold;
}

#eaksmevbjq .gt_font_italic {
  font-style: italic;
}

#eaksmevbjq .gt_super {
  font-size: 65%;
}

#eaksmevbjq .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#eaksmevbjq .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#eaksmevbjq .gt_indent_1 {
  text-indent: 5px;
}

#eaksmevbjq .gt_indent_2 {
  text-indent: 10px;
}

#eaksmevbjq .gt_indent_3 {
  text-indent: 15px;
}

#eaksmevbjq .gt_indent_4 {
  text-indent: 20px;
}

#eaksmevbjq .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings gt_spanner_row">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="2" colspan="1" scope="col" id=""></th>
      <th class="gt_center gt_columns_top_border gt_column_spanner_outer" rowspan="1" colspan="3" scope="colgroup" id="<strong>Low risk</strong>">
        <span class="gt_column_spanner"><strong>Low risk</strong></span>
      </th>
      <th class="gt_center gt_columns_top_border gt_column_spanner_outer" rowspan="1" colspan="3" scope="colgroup" id="<strong>High risk</strong>">
        <span class="gt_column_spanner"><strong>High risk</strong></span>
      </th>
    </tr>
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Control">Control</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Treatment">Treatment</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Total">Total</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Control">Control</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Treatment">Treatment</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Total">Total</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="label" class="gt_row gt_left">outcome</td>
<td headers="stat_1_1" class="gt_row gt_center"></td>
<td headers="stat_2_1" class="gt_row gt_center"></td>
<td headers="stat_0_1" class="gt_row gt_center"></td>
<td headers="stat_1_2" class="gt_row gt_center"></td>
<td headers="stat_2_2" class="gt_row gt_center"></td>
<td headers="stat_0_2" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;0</td>
<td headers="stat_1_1" class="gt_row gt_center">120 (86%)</td>
<td headers="stat_2_1" class="gt_row gt_center">126 (90%)</td>
<td headers="stat_0_1" class="gt_row gt_center">246 (88%)</td>
<td headers="stat_1_2" class="gt_row gt_center">56 (40%)</td>
<td headers="stat_2_2" class="gt_row gt_center">70 (50%)</td>
<td headers="stat_0_2" class="gt_row gt_center">126 (45%)</td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;1</td>
<td headers="stat_1_1" class="gt_row gt_center">20 (14%)</td>
<td headers="stat_2_1" class="gt_row gt_center">14 (10%)</td>
<td headers="stat_0_1" class="gt_row gt_center">34 (12%)</td>
<td headers="stat_1_2" class="gt_row gt_center">84 (60%)</td>
<td headers="stat_2_2" class="gt_row gt_center">70 (50%)</td>
<td headers="stat_0_2" class="gt_row gt_center">154 (55%)</td></tr>
    <tr><td headers="label" class="gt_row gt_left">Total</td>
<td headers="stat_1_1" class="gt_row gt_center">140 (100%)</td>
<td headers="stat_2_1" class="gt_row gt_center">140 (100%)</td>
<td headers="stat_0_1" class="gt_row gt_center">280 (100%)</td>
<td headers="stat_1_2" class="gt_row gt_center">140 (100%)</td>
<td headers="stat_2_2" class="gt_row gt_center">140 (100%)</td>
<td headers="stat_0_2" class="gt_row gt_center">280 (100%)</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>The statistician decided to fit another logistic regression model, this time including risk as an additional variable in the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">lrm_adj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(</span>
<span id="cb6-2">  outcome <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> treatment <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> risk,</span>
<span id="cb6-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> binomial,</span>
<span id="cb6-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rct_data</span>
<span id="cb6-5">)</span></code></pre></div>
</div>
<p>Looking at the coefficients in this model, we can see that the estimated effect of treatment has increased: the odds ratio is further away from 1, now being 0.67 (95% CI: 0.45 to 0.99) instead of 0.73 (95% CI: 0.51 to 1.03). The p-value has decreased from 0.074 to 0.045, meaning that the treatment effect is now statistically significant.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tbl_regression</span>(lrm_adj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exponentiate =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
<div class="cell-output-display">

<div id="fplgmwuluz" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#fplgmwuluz table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#fplgmwuluz thead, #fplgmwuluz tbody, #fplgmwuluz tfoot, #fplgmwuluz tr, #fplgmwuluz td, #fplgmwuluz th {
  border-style: none;
}

#fplgmwuluz p {
  margin: 0;
  padding: 0;
}

#fplgmwuluz .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#fplgmwuluz .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#fplgmwuluz .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#fplgmwuluz .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#fplgmwuluz .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#fplgmwuluz .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fplgmwuluz .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#fplgmwuluz .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#fplgmwuluz .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#fplgmwuluz .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#fplgmwuluz .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#fplgmwuluz .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#fplgmwuluz .gt_spanner_row {
  border-bottom-style: hidden;
}

#fplgmwuluz .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#fplgmwuluz .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#fplgmwuluz .gt_from_md > :first-child {
  margin-top: 0;
}

#fplgmwuluz .gt_from_md > :last-child {
  margin-bottom: 0;
}

#fplgmwuluz .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#fplgmwuluz .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#fplgmwuluz .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#fplgmwuluz .gt_row_group_first td {
  border-top-width: 2px;
}

#fplgmwuluz .gt_row_group_first th {
  border-top-width: 2px;
}

#fplgmwuluz .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#fplgmwuluz .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#fplgmwuluz .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#fplgmwuluz .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fplgmwuluz .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#fplgmwuluz .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#fplgmwuluz .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#fplgmwuluz .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#fplgmwuluz .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fplgmwuluz .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#fplgmwuluz .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#fplgmwuluz .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#fplgmwuluz .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#fplgmwuluz .gt_left {
  text-align: left;
}

#fplgmwuluz .gt_center {
  text-align: center;
}

#fplgmwuluz .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#fplgmwuluz .gt_font_normal {
  font-weight: normal;
}

#fplgmwuluz .gt_font_bold {
  font-weight: bold;
}

#fplgmwuluz .gt_font_italic {
  font-style: italic;
}

#fplgmwuluz .gt_super {
  font-size: 65%;
}

#fplgmwuluz .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#fplgmwuluz .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#fplgmwuluz .gt_indent_1 {
  text-indent: 5px;
}

#fplgmwuluz .gt_indent_2 {
  text-indent: 10px;
}

#fplgmwuluz .gt_indent_3 {
  text-indent: 15px;
}

#fplgmwuluz .gt_indent_4 {
  text-indent: 20px;
}

#fplgmwuluz .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="<strong>Characteristic</strong>"><strong>Characteristic</strong></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>OR</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>"><strong>OR</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>95% CI</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>"><strong>95% CI</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>p-value</strong>"><strong>p-value</strong></th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="label" class="gt_row gt_left">treatment</td>
<td headers="estimate" class="gt_row gt_center"></td>
<td headers="ci" class="gt_row gt_center"></td>
<td headers="p.value" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;Control</td>
<td headers="estimate" class="gt_row gt_center">—</td>
<td headers="ci" class="gt_row gt_center">—</td>
<td headers="p.value" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;Treatment</td>
<td headers="estimate" class="gt_row gt_center">0.67</td>
<td headers="ci" class="gt_row gt_center">0.45, 0.99</td>
<td headers="p.value" class="gt_row gt_center">0.045</td></tr>
    <tr><td headers="label" class="gt_row gt_left">risk</td>
<td headers="estimate" class="gt_row gt_center"></td>
<td headers="ci" class="gt_row gt_center"></td>
<td headers="p.value" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;Low risk</td>
<td headers="estimate" class="gt_row gt_center">—</td>
<td headers="ci" class="gt_row gt_center">—</td>
<td headers="p.value" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;High risk</td>
<td headers="estimate" class="gt_row gt_center">9.00</td>
<td headers="ci" class="gt_row gt_center">5.91, 14.0</td>
<td headers="p.value" class="gt_row gt_center">&lt;0.001</td></tr>
  </tbody>
  
  <tfoot class="gt_footnotes">
    <tr>
      <td class="gt_footnote" colspan="4"><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span> OR = Odds Ratio, CI = Confidence Interval</td>
    </tr>
  </tfoot>
</table>
</div>
</div>
</div>
<p>The researchers went home happy, dreaming once again of publishing in a high impact factor journal, but the statistician was left with a nagging feeling that something was not quite right. The covariate was balanced between treatment groups, with equal numbers of low risk and high risk assigned to each treatment. Undergraduate linear models courses taught that adding a covariate to the model which is balanced between treatment groups shouldn’t change the coefficient for treatment, only the standard error. Why, then, did the estimates change like that? Is logistic regression different from linear regression in this regard?</p>
</section>
<section id="hand-calculations-back-to-the-2-way-table" class="level2">
<h2 class="anchored" data-anchor-id="hand-calculations-back-to-the-2-way-table">Hand calculations: back to the 2-way table</h2>
<p>Let’s take another look at the 2-way table and do some hand calculations.</p>
<div class="cell">
<div class="cell-output-display">

<div id="hslakvvldg" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#hslakvvldg table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#hslakvvldg thead, #hslakvvldg tbody, #hslakvvldg tfoot, #hslakvvldg tr, #hslakvvldg td, #hslakvvldg th {
  border-style: none;
}

#hslakvvldg p {
  margin: 0;
  padding: 0;
}

#hslakvvldg .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#hslakvvldg .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#hslakvvldg .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#hslakvvldg .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#hslakvvldg .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hslakvvldg .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hslakvvldg .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hslakvvldg .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#hslakvvldg .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#hslakvvldg .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#hslakvvldg .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#hslakvvldg .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#hslakvvldg .gt_spanner_row {
  border-bottom-style: hidden;
}

#hslakvvldg .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#hslakvvldg .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#hslakvvldg .gt_from_md > :first-child {
  margin-top: 0;
}

#hslakvvldg .gt_from_md > :last-child {
  margin-bottom: 0;
}

#hslakvvldg .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#hslakvvldg .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#hslakvvldg .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#hslakvvldg .gt_row_group_first td {
  border-top-width: 2px;
}

#hslakvvldg .gt_row_group_first th {
  border-top-width: 2px;
}

#hslakvvldg .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#hslakvvldg .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#hslakvvldg .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#hslakvvldg .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hslakvvldg .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#hslakvvldg .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#hslakvvldg .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#hslakvvldg .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#hslakvvldg .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hslakvvldg .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hslakvvldg .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#hslakvvldg .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hslakvvldg .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#hslakvvldg .gt_left {
  text-align: left;
}

#hslakvvldg .gt_center {
  text-align: center;
}

#hslakvvldg .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#hslakvvldg .gt_font_normal {
  font-weight: normal;
}

#hslakvvldg .gt_font_bold {
  font-weight: bold;
}

#hslakvvldg .gt_font_italic {
  font-style: italic;
}

#hslakvvldg .gt_super {
  font-size: 65%;
}

#hslakvvldg .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#hslakvvldg .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#hslakvvldg .gt_indent_1 {
  text-indent: 5px;
}

#hslakvvldg .gt_indent_2 {
  text-indent: 10px;
}

#hslakvvldg .gt_indent_3 {
  text-indent: 15px;
}

#hslakvvldg .gt_indent_4 {
  text-indent: 20px;
}

#hslakvvldg .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings gt_spanner_row">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="2" colspan="1" scope="col" id=""></th>
      <th class="gt_center gt_columns_top_border gt_column_spanner_outer" rowspan="1" colspan="2" scope="colgroup" id="treatment">
        <span class="gt_column_spanner">treatment</span>
      </th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="2" colspan="1" scope="col" id="Total">Total</th>
    </tr>
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Control">Control</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Treatment">Treatment</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="label" class="gt_row gt_left">outcome</td>
<td headers="stat_1" class="gt_row gt_center"></td>
<td headers="stat_2" class="gt_row gt_center"></td>
<td headers="stat_0" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;0</td>
<td headers="stat_1" class="gt_row gt_center">176 (63%)</td>
<td headers="stat_2" class="gt_row gt_center">196 (70%)</td>
<td headers="stat_0" class="gt_row gt_center">372 (66%)</td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;1</td>
<td headers="stat_1" class="gt_row gt_center">104 (37%)</td>
<td headers="stat_2" class="gt_row gt_center">84 (30%)</td>
<td headers="stat_0" class="gt_row gt_center">188 (34%)</td></tr>
    <tr><td headers="label" class="gt_row gt_left">Total</td>
<td headers="stat_1" class="gt_row gt_center">280 (100%)</td>
<td headers="stat_2" class="gt_row gt_center">280 (100%)</td>
<td headers="stat_0" class="gt_row gt_center">560 (100%)</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>The marginal risk difference is the difference between treatment and control groups in the proportion of patients experiencing the outcome event. From the table above, ignoring the covariate, we can calculate a risk reduction of 0.071:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">104</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">280</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">84</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">280</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.07142857</code></pre>
</div>
</div>
<p>The marginal odds ratio is the ratio of the oddses for treatment and the control group, where the odds is itself the number who experience the outcome event divided by the number who do not<sup>11</sup>. We can calculate the marginal odds ratio here as 0.73, the same as the unadjusted logistic regression:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">84</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">196</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">104</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">176</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7252747</code></pre>
</div>
</div>
<p>Now let’s look at the table stratified by risk, and see how that affects our calculations.</p>
<div class="cell">
<div class="cell-output-display">

<div id="xhgcwqpznm" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#xhgcwqpznm table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#xhgcwqpznm thead, #xhgcwqpznm tbody, #xhgcwqpznm tfoot, #xhgcwqpznm tr, #xhgcwqpznm td, #xhgcwqpznm th {
  border-style: none;
}

#xhgcwqpznm p {
  margin: 0;
  padding: 0;
}

#xhgcwqpznm .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#xhgcwqpznm .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#xhgcwqpznm .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#xhgcwqpznm .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#xhgcwqpznm .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#xhgcwqpznm .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#xhgcwqpznm .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#xhgcwqpznm .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#xhgcwqpznm .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#xhgcwqpznm .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#xhgcwqpznm .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#xhgcwqpznm .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#xhgcwqpznm .gt_spanner_row {
  border-bottom-style: hidden;
}

#xhgcwqpznm .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#xhgcwqpznm .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#xhgcwqpznm .gt_from_md > :first-child {
  margin-top: 0;
}

#xhgcwqpznm .gt_from_md > :last-child {
  margin-bottom: 0;
}

#xhgcwqpznm .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#xhgcwqpznm .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#xhgcwqpznm .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#xhgcwqpznm .gt_row_group_first td {
  border-top-width: 2px;
}

#xhgcwqpznm .gt_row_group_first th {
  border-top-width: 2px;
}

#xhgcwqpznm .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#xhgcwqpznm .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#xhgcwqpznm .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#xhgcwqpznm .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#xhgcwqpznm .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#xhgcwqpznm .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#xhgcwqpznm .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#xhgcwqpznm .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#xhgcwqpznm .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#xhgcwqpznm .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#xhgcwqpznm .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#xhgcwqpznm .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#xhgcwqpznm .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#xhgcwqpznm .gt_left {
  text-align: left;
}

#xhgcwqpznm .gt_center {
  text-align: center;
}

#xhgcwqpznm .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#xhgcwqpznm .gt_font_normal {
  font-weight: normal;
}

#xhgcwqpznm .gt_font_bold {
  font-weight: bold;
}

#xhgcwqpznm .gt_font_italic {
  font-style: italic;
}

#xhgcwqpznm .gt_super {
  font-size: 65%;
}

#xhgcwqpznm .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#xhgcwqpznm .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#xhgcwqpznm .gt_indent_1 {
  text-indent: 5px;
}

#xhgcwqpznm .gt_indent_2 {
  text-indent: 10px;
}

#xhgcwqpznm .gt_indent_3 {
  text-indent: 15px;
}

#xhgcwqpznm .gt_indent_4 {
  text-indent: 20px;
}

#xhgcwqpznm .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings gt_spanner_row">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="2" colspan="1" scope="col" id=""></th>
      <th class="gt_center gt_columns_top_border gt_column_spanner_outer" rowspan="1" colspan="3" scope="colgroup" id="<strong>Low risk</strong>">
        <span class="gt_column_spanner"><strong>Low risk</strong></span>
      </th>
      <th class="gt_center gt_columns_top_border gt_column_spanner_outer" rowspan="1" colspan="3" scope="colgroup" id="<strong>High risk</strong>">
        <span class="gt_column_spanner"><strong>High risk</strong></span>
      </th>
    </tr>
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Control">Control</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Treatment">Treatment</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Total">Total</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Control">Control</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Treatment">Treatment</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Total">Total</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="label" class="gt_row gt_left">outcome</td>
<td headers="stat_1_1" class="gt_row gt_center"></td>
<td headers="stat_2_1" class="gt_row gt_center"></td>
<td headers="stat_0_1" class="gt_row gt_center"></td>
<td headers="stat_1_2" class="gt_row gt_center"></td>
<td headers="stat_2_2" class="gt_row gt_center"></td>
<td headers="stat_0_2" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;0</td>
<td headers="stat_1_1" class="gt_row gt_center">120 (86%)</td>
<td headers="stat_2_1" class="gt_row gt_center">126 (90%)</td>
<td headers="stat_0_1" class="gt_row gt_center">246 (88%)</td>
<td headers="stat_1_2" class="gt_row gt_center">56 (40%)</td>
<td headers="stat_2_2" class="gt_row gt_center">70 (50%)</td>
<td headers="stat_0_2" class="gt_row gt_center">126 (45%)</td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;1</td>
<td headers="stat_1_1" class="gt_row gt_center">20 (14%)</td>
<td headers="stat_2_1" class="gt_row gt_center">14 (10%)</td>
<td headers="stat_0_1" class="gt_row gt_center">34 (12%)</td>
<td headers="stat_1_2" class="gt_row gt_center">84 (60%)</td>
<td headers="stat_2_2" class="gt_row gt_center">70 (50%)</td>
<td headers="stat_0_2" class="gt_row gt_center">154 (55%)</td></tr>
    <tr><td headers="label" class="gt_row gt_left">Total</td>
<td headers="stat_1_1" class="gt_row gt_center">140 (100%)</td>
<td headers="stat_2_1" class="gt_row gt_center">140 (100%)</td>
<td headers="stat_0_1" class="gt_row gt_center">280 (100%)</td>
<td headers="stat_1_2" class="gt_row gt_center">140 (100%)</td>
<td headers="stat_2_2" class="gt_row gt_center">140 (100%)</td>
<td headers="stat_0_2" class="gt_row gt_center">280 (100%)</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>Using the same formula as before, we can calculate a risk difference of 0.043 in the low risk group, 0.100 in the high risk group, and the equally-weighted average of those two (because the two risk groups are equally common in this example) is 0.071, same as the marginal risk difference calculated above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># conditional risk difference in the low risk group</span></span>
<span id="cb12-2"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.04285714</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># conditional risk difference in the high risk group</span></span>
<span id="cb14-2"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">84</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># average of conditional risk differences is the marginal risk difference</span></span>
<span id="cb16-2"><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">84</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.07142857</code></pre>
</div>
</div>
<p>Using the formula for odds ratios, we can calculate an odds ratio of 0.67 in the low risk group and 0.67 in the high risk group. The conditional odds ratios in both groups are equal, and equal to the conditional odds ratio from the adjusted logistic regression, but are different from the marginal odds ratio. This is noncollapsibility in action.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># conditional odds ratio in the low risk group</span></span>
<span id="cb18-2">(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">126</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6666667</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># conditional odds ratio in the high risk group</span></span>
<span id="cb20-2">(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">84</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">56</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6666667</code></pre>
</div>
</div>
<p>In this example, we observed a treatment-by-risk-group interaction on the risk difference scale (absolute risk reduction of 0.041 in the low-risk group, absolute risk reduction of 0.100 in the high-risk group) but not on the odds ratio scale (conditional odds ratio of 0.67 in both groups). There is no mathematical requirement for the odds ratio scale to have a smaller interaction than other scales, but it is mathematically impossible for there to be no interaction on <em>any</em> scale unless the effect size is zero. This issue is discussed in detail from the perspective of psychological research in <span class="citation" data-cites="rohrer2021preciseanswersvague">Rohrer &amp; Arslan (2021)</span>.</p>
</section>
<section id="calculating-risk-difference-and-relative-risks-using-the-marginaleffects-package" class="level2">
<h2 class="anchored" data-anchor-id="calculating-risk-difference-and-relative-risks-using-the-marginaleffects-package">Calculating risk difference and relative risks using the marginaleffects package</h2>
<p>The researchers returned to the statistician, requesting adjusted and unadjusted risk differences and relative risks to report in their paper. Fortunately, the statistician was familiar with the <code>marginaleffects</code> package, which makes it fairly easy to calculate risk differences from logistic regression models<sup>12</sup>.</p>
<section id="risk-differences" class="level3">
<h3 class="anchored" data-anchor-id="risk-differences">Risk differences</h3>
<p>The <code>avg_comparisons()</code> function calculates differences in one variable, averaged across the observed distribution of the other variables. By default it does this calculation on the response scale, i.e.&nbsp;predicted probability, which is what we want for a risk difference. For the unadjusted model, we get an average risk reduction of 7.1% (95% CI: -0.1% to 14.9%).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>(lrm_unadj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"treatment"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
      Term Contrast Estimate Std. Error     z Pr(&gt;|z|)   S  2.5 %  97.5 %
 treatment    T - C  -0.0714     0.0398 -1.79   0.0727 3.8 -0.149 0.00657

Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </code></pre>
</div>
</div>
<p>For the adjusted model, we get an average risk reduction of 7.1% (95% CI: 0.0% to 14.1%).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>(lrm_adj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"treatment"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
      Term Contrast Estimate Std. Error     z Pr(&gt;|z|)   S  2.5 %   97.5 %
 treatment    T - C  -0.0714     0.0354 -2.02   0.0437 4.5 -0.141 -0.00201

Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </code></pre>
</div>
</div>
<p>Unlike the odds ratio, the point estimate of the risk difference didn’t change when we added the covariate, but its estimate got more precise: the confidence interval shrank.</p>
</section>
<section id="relative-risks" class="level3">
<h3 class="anchored" data-anchor-id="relative-risks">Relative risks</h3>
<p>To get relative risks using <code>avg_comparisons()</code>, we need to ask for the average of the log of the ratio between treatment conditions (<code>lnratioavg</code> in the code below), and then exponentiate that.</p>
<p>For the unadjusted model, the relative risk is 0.81 (95% CI: 0.64 to 1.02).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>(lrm_unadj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"treatment"</span>,</span>
<span id="cb26-2">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lnratioavg"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">transform =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exp"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
      Term              Contrast Estimate Pr(&gt;|z|)   S 2.5 % 97.5 %
 treatment ln(mean(T) / mean(C))    0.808   0.0749 3.7 0.639   1.02

Columns: term, contrast, estimate, p.value, s.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo </code></pre>
</div>
</div>
<p>For the adjusted model, the relative risk is 0.81 (95% CI: 0.65 to 1.00).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>(lrm_adj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"treatment"</span>,</span>
<span id="cb28-2">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lnratioavg"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">transform =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exp"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
      Term              Contrast Estimate Pr(&gt;|z|)   S 2.5 % 97.5 %
 treatment ln(mean(T) / mean(C))    0.808   0.0458 4.4 0.655  0.996

Columns: term, contrast, estimate, p.value, s.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo </code></pre>
</div>
</div>
<p>Compared to the unadjusted model, the point estimate hasn’t changed but the confidence interval shrank. Like risk differences, and unlike odds ratios, relative risks are collapsible.</p>
</section>
</section>
<section id="in-pictures" class="level2">
<h2 class="anchored" data-anchor-id="in-pictures">In pictures</h2>
<p>One last way of showing the same thing: below is a plot of unadjusted and adjusted odds ratios, risk differences, and relative risks. You can see that for the odds ratio, the adjustment has moved the point estimate but not made the confidence interval narrower, whereas for the other measures, the point estimate has not changed but the confidence intervals are narrower for the adjusted estimate.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># odds ratio estimates</span></span>
<span id="cb30-2">or_estimates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb30-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Unadjusted"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> </span>
<span id="cb30-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(lrm_unadj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conf.int =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exponentiate =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"treatmentT"</span>),</span>
<span id="cb30-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Adjusted"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> </span>
<span id="cb30-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(lrm_adj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conf.int =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exponentiate =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"treatmentT"</span>),</span>
<span id="cb30-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model"</span></span>
<span id="cb30-10">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(model, estimate, conf.low, conf.high)</span>
<span id="cb30-12"></span>
<span id="cb30-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># risk difference estimates</span></span>
<span id="cb30-14">rd_estimates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb30-15">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Unadjusted"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb30-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>(lrm_unadj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"treatment"</span>),</span>
<span id="cb30-17">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Adjusted"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb30-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>(lrm_adj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"treatment"</span>),</span>
<span id="cb30-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model"</span></span>
<span id="cb30-20">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(model, estimate, conf.low, conf.high)</span>
<span id="cb30-22"></span>
<span id="cb30-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># relative risk estimates</span></span>
<span id="cb30-24">rr_estimates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb30-25">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Unadjusted"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb30-26">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>(lrm_unadj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"treatment"</span>,</span>
<span id="cb30-27">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lnratioavg"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">transform =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exp"</span>),</span>
<span id="cb30-28">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Adjusted"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb30-29">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>(lrm_adj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"treatment"</span>,</span>
<span id="cb30-30">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">comparison =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lnratioavg"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">transform =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exp"</span>),</span>
<span id="cb30-31">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model"</span></span>
<span id="cb30-32">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(model, estimate, conf.low, conf.high)</span>
<span id="cb30-34"></span>
<span id="cb30-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># combine all estimands into a single data frame</span></span>
<span id="cb30-36">all_estimates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb30-37">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Odds ratio"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> or_estimates,</span>
<span id="cb30-38">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Risk difference"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> rd_estimates,</span>
<span id="cb30-39">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Relative risk"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> rr_estimates,</span>
<span id="cb30-40">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"estimand"</span></span>
<span id="cb30-41">)</span>
<span id="cb30-42"></span>
<span id="cb30-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot!</span></span>
<span id="cb30-44">all_estimates <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(model), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(estimand)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-46">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> conf.low, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> conf.high,</span>
<span id="cb30-47">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> model)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-48">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_pointrange</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-49">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> rev) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-50">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(estimand), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-51">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">panel_border</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-52">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Estimate (95% CI)"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2023/07/logit-rd-rr/index_files/figure-html/coef-plot-1.png" class="img-fluid" width="780"></p>
</div>
</div>
</section>
<section id="acknowledgements" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h2>
<p>Thanks to those who provided feedback on earlier versions of this post, some which resulted in substantial revisions and improvements:</p>
<ul>
<li>Isabella Ghement</li>
<li>Lachlan Cribb</li>
<li>Solomon Kurz</li>
</ul>
<p>This does not represent an endorsement of this post by any of the above. Mistakes and opinions are entirely my own.</p>
<p>Feedback welcome, especially any corrections in cases where I may have misunderstood or misattributed arguments, or made clear factual errors.</p>
</section>
<section id="references" class="level2">




</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-line-spacing="2">
<div id="ref-altman1998oddsratiosshould" class="csl-entry">
Altman, D. G., Deeks, J. J., &amp; Sackett, D. L. (1998). Odds ratios should be avoided when events are common. <em>BMJ</em>, <em>317</em>(7168), 1318–1318. <a href="https://doi.org/10.1136/bmj.317.7168.1318">https://doi.org/10.1136/bmj.317.7168.1318</a>
</div>
<div id="ref-daniel2021makingapplesoranges" class="csl-entry">
Daniel, R., Zhang, J., &amp; Farewell, D. (2021). Making apples from oranges: Comparing noncollapsible effect estimators and their standard errors after adjustment for different covariate sets. <em>Biometrical Journal</em>, <em>63</em>(3), 528–557. <a href="https://doi.org/10.1002/bimj.201900297">https://doi.org/10.1002/bimj.201900297</a>
</div>
<div id="ref-doi2022controversydebatequestionable" class="csl-entry">
Doi, S. A., Furuya-Kanamori, L., Xu, C., Lin, L., Chivese, T., &amp; Thalib, L. (2022). Controversy and Debate: Questionable utility of the relative risk in clinical research: Paper 1: A call for change to practice. <em>Journal of Clinical Epidemiology</em>, <em>142</em>, 271–279. <a href="https://doi.org/10.1016/j.jclinepi.2020.08.019">https://doi.org/10.1016/j.jclinepi.2020.08.019</a>
</div>
<div id="ref-greenland1999confoundingcollapsibilitycausal" class="csl-entry">
Greenland, S., Pearl, J., &amp; Robins, J. M. (1999). Confounding and Collapsibility in Causal Inference. <em>Statistical Science</em>, <em>14</em>(1). <a href="https://doi.org/10.1214/ss/1009211805">https://doi.org/10.1214/ss/1009211805</a>
</div>
<div id="ref-moher2010consort2010explanation" class="csl-entry">
Moher, D., Hopewell, S., Schulz, K. F., Montori, V., Gotzsche, P. C., Devereaux, P. J., Elbourne, D., Egger, M., &amp; Altman, D. G. (2010). CONSORT 2010 Explanation and Elaboration: updated guidelines for reporting parallel group randomised trials. <em>BMJ</em>, <em>340</em>(mar23 1), c869–c869. <a href="https://doi.org/10.1136/bmj.c869">https://doi.org/10.1136/bmj.c869</a>
</div>
<div id="ref-morris2022planningmethodcovariate" class="csl-entry">
Morris, T. P., Walker, A. S., Williamson, E. J., &amp; White, I. R. (2022). Planning a method for covariate adjustment in individually randomised trials: a practical guide. <em>Trials</em>, <em>23</em>(1), 328. <a href="https://doi.org/10.1186/s13063-022-06097-z">https://doi.org/10.1186/s13063-022-06097-z</a>
</div>
<div id="ref-permutt2020covariateschangeestimand" class="csl-entry">
Permutt, T. (2020). Do Covariates Change the Estimand? <em>Statistics in Biopharmaceutical Research</em>, <em>12</em>(1), 45–53. <a href="https://doi.org/10.1080/19466315.2019.1647874">https://doi.org/10.1080/19466315.2019.1647874</a>
</div>
<div id="ref-rohrer2021preciseanswersvague" class="csl-entry">
Rohrer, J. M., &amp; Arslan, R. C. (2021). Precise Answers to Vague Questions: Issues With Interactions. <em>Advances in Methods and Practices in Psychological Science</em>, <em>4</em>(2), 251524592110073. <a href="https://doi.org/10.1177/25152459211007368">https://doi.org/10.1177/25152459211007368</a>
</div>
<div id="ref-senn2011uneasereasonsmistrusting" class="csl-entry">
Senn, S. (2011). U is for Unease: Reasons for Mistrusting Overlap Measures for Reporting Clinical Trials. <em>Statistics in Biopharmaceutical Research</em>, <em>3</em>(2), 302–309. <a href="https://doi.org/10.1198/sbr.2010.10024">https://doi.org/10.1198/sbr.2010.10024</a>
</div>
<div id="ref-white2021covariateadjustmentrandomised" class="csl-entry">
White, I. R., Morris, T. P., &amp; Williamson, E. (2021). <em>Covariate adjustment in randomised trials: canonical link functions protect against model mis-specification</em>. <a href="https://doi.org/10.48550/ARXIV.2107.07278">https://doi.org/10.48550/ARXIV.2107.07278</a>
</div>
<div id="ref-zipkin2014evidencebasedriskcommunication" class="csl-entry">
Zipkin, D. A., Umscheid, C. A., Keating, N. L., Allen, E., Aung, K., Beyth, R., Kaatz, S., Mann, D. M., Sussman, J. B., Korenstein, D., Schardt, C., Nagi, A., Sloane, R., &amp; Feldstein, D. A. (2014). Evidence-Based Risk Communication: A Systematic Review. <em>Annals of Internal Medicine</em>, <em>161</em>(4), 270. <a href="https://doi.org/10.7326/M14-0295">https://doi.org/10.7326/M14-0295</a>
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This plural form is non-standard but I’m trying to make it happen.↩︎</p></li>
<li id="fn2"><p>For a recent example, see <a href="https://thestatsgeek.com/2023/06/23/is-the-ich-e9-estimand-addendum-compatible-with-model-based-estimands/">this talk by Jonathan Bartlett</a>.↩︎</p></li>
<li id="fn3"><p>Statisticians.↩︎</p></li>
<li id="fn4"><p>Statisticians use the word “marginal” to refer to a population-level average, or an integral. Economists, on the other hand, use the word “marginal” to refer to a change in a quantity, or a derivative. These opposite meanings can potentially cause a lot of confusion.↩︎</p></li>
<li id="fn5"><p>This issue is also sometimes raised in longitudinal studies, where it is said that generalised linear mixed models (GLMMs) target conditional odds ratios while generalised estimating equations (GEEs) target marginal odds ratios. This has led to an epidemic of epidemiologists applying GEEs to their data. As far as I understand it, this claim is only half true: odds ratios from GEEs target what you’d get from a GLMM after marginalising over random effects, but are still conditional on other covariates in the model (fixed effects in a GLMM). Confused yet? Probably not nearly as confused as you should be.↩︎</p></li>
<li id="fn6"><p>Neither is the hazard ratio, which means — despite its ubiquity — Cox regression for survival analysis is technically not allowed by the estimand framework.↩︎</p></li>
<li id="fn7"><p>Technically, logistic regression directly estimates a conditional difference of log-odds. The difference on the log scale is usually exponentiated and reported as an odds ratio.↩︎</p></li>
<li id="fn8"><p>Or even an additive model — exactly the same point applies to Generalised Additive Models (GAMs).↩︎</p></li>
<li id="fn9"><p>At this point you may find yourself inclined to avoid logistic regression purely to spite the mathematicians. I don’t blame you.↩︎</p></li>
<li id="fn10"><p>Statisticians love being asked to help at the last minute.↩︎</p></li>
<li id="fn11"><p>The odds ratio is a ratio of ratios, no wonder nobody understands them.↩︎</p></li>
<li id="fn12"><p>One thing to be aware of is that the standard errors are derived using the delta method, which is a large-sample approximation. There is experimental support for bootstrapping and simulation-based inference in the <code>marginaleffects</code> package to get more accurate estimates in small samples, but this blog post isn’t going there.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>statistics</category>
  <guid>https://cameronpatrick.com/post/2023/07/logit-rd-rr/index.html</guid>
  <pubDate>Thu, 13 Jul 2023 14:00:00 GMT</pubDate>
</item>
<item>
  <title>Understanding missing data mechanisms using causal DAGs</title>
  <dc:creator>Cameron Patrick</dc:creator>
  <link>https://cameronpatrick.com/post/2023/06/untangling-mar-mcar-mnar/index.html</link>
  <description><![CDATA[ 




<p>Missing data refers to data which was intended to have been collected but was not, and is a common scenario in biomedical and social science research. Analysing datasets that have missing data requires extra care and consideration to produce correct results.</p>
<p>The best method for dealing with missing data depends on the underlying process causing the missingness. There is no single approach that is always the best, and the terminology commonly used to describe missingness doesn’t directly relate to what analysis methods perform best. In this blog post I’ll begin by defining the commonly used but sometimes unhelpful classifications for missing data mechanisms (you’ll see them everywhere, so you might as well know what they mean) and then explain how to describe missing data processes using causal diagrams (DAGs) and provide some references to help choose an analysis based on that.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://cameronpatrick.com/post/2023/06/untangling-mar-mcar-mnar/dont_fight_a_cat_MI.jpeg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">(original image via <a href="https://twitter.com/marginoferror/status/935937659888836609">@marginoferror on Twitter</a>, adapted by me for missing data purposes.)</figcaption>
</figure>
</div>
<section id="mcar-mar-mnar-or-nah" class="level2">
<h2 class="anchored" data-anchor-id="mcar-mar-mnar-or-nah">MCAR, MAR, MNAR or nah?</h2>
<p>The most common classification for missing data mechanisms is that data is either Missing Completely at Random (MCAR), Missing at Random (MAR), or Missing Not at Random (MNAR). This classification is based on concepts first introduced in <span class="citation" data-cites="rubin_inference_1976">Rubin (1976)</span>. These terms are widespread, but can be confusing when first encountered because they do not mean quite what you might expect them to mean. I’ll define them briefly here, but the goal is to not have to focus specifically about which of these mechanisms apply to your data, or use this classification to guide your analytical choices.</p>
<p>Data is considered to be <strong>Missing Completely at Random (MCAR)</strong> if the probability of being missing does not depend on the values of any of the variables in the data, whether those values are missing or observed <span class="citation" data-cites="little_statistical_2014">(Little &amp; Rubin, 2014, p. 12)</span>. In other words, the missingness cannot be related to the research question of interest <span class="citation" data-cites="lee_framework_2021">(Lee et al., 2021)</span>.</p>
<p>Data is <strong>Missing at Random (MAR)</strong> if the probability of being missing depends only on data that was observed <span class="citation" data-cites="little_statistical_2014">(Little &amp; Rubin, 2014, p. 12)</span>. Most commonly this refers to a situation where a variable with incomplete data has probability of being missing which relates to completely-observed variables, but there are other possibilities which fit this definition too<sup>1</sup>. This term is misleading if encountered without context, as a plain-language interpretation suggests it may mean something more like MCAR. However, MCAR is a stricter requirement than MAR. If data is MCAR, it is also considered MAR.</p>
<p>Data is <strong>Missing Not at Random (MNAR)</strong> if it’s not Missing at Random <span class="citation" data-cites="little_statistical_2014">(Little &amp; Rubin, 2014, p. 12)</span>. At least that’s relatively straightforward. In other words, the probability of data being missing is related to what the missing values would have been, had we observed them. It is sometimes implied that MNAR data is a lost cause for statistical analysis, but later in this post we will see specific examples of MNAR mechanisms where common statistical procedures produce valid results for common questions.</p>
<p>Strictly speaking, these classifications refer to the entire dataset collectively, usually consisting of many variables, some of which may have missing values and some of which may not. When there are multiple variables with missing values — a common situation in real datasets — these classifications are sometimes informally applied to specific variables with missing data, but doing so doesn’t relate to any of the mathematical guarantees about which analysis methods are applicable.</p>
<p>These missing data classifications depend on the type of analysis and set of available variables. For example, if additional variables (sometimes called auxiliary variables) which relate to probability of partially-observed variables having missing values are added to the dataset, the missing data mechanism may change from being MNAR to being MAR.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Historical aside
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="citation" data-cites="rubin_inference_1976">Rubin (1976)</span> is often cited as the source of this classification system, but didn’t actually introduce the terms Missing Completely at Random or Missing Not at Random, only Missing at Random. Rubin originally defined an additional condition, Observed at Random. Data which is both Missing at Random and Observed at Random is what we would now commonly refer to as Missing Completely at Random. The term Missing Completely at Random came later, in <span class="citation" data-cites="marini_maximum-likelihood_1980">Marini et al. (1980)</span>. This history is given in <span class="citation" data-cites="little_missing_2021">Little (2021)</span> and was also confirmed <a href="https://twitter.com/rnishimura/status/1668824406766878721">in a Tweet by Raphael Nishimura</a>: ‘I was curious about that too and did some digging with the authors. Rod said that “Rubin’s 1976 Biometrika paper defines MAR and OAR (observed at random) but he may not have put the two together.” Don confirmed it and added that “MCAR was first formally defined in a joint paper with Marini and Olsen, I think in 1980, in a more applied paper.”’</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Ignorable and non-ignorable missingness
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sometimes you may hear missing data described as “ignorable” or “non-ignorable”. These terms are also potentially misleading. “Ignorable” missing data doesn’t mean that you can just ignore the fact that you have missing data when doing an analysis. This term was defined in <span class="citation" data-cites="rubin_inference_1976">Rubin (1976)</span> to mean that (1) the data is MAR; (2) the likelihood can be factorised into a part relating to the missingness probability and a part relating to the distribution of the underlying data. These provide a sufficient condition for missing data to be dealt with using likelihood-based methods.</p>
</div>
</div>
<section id="how-do-i-know-what-kind-of-missing-data-mechanism-i-have" class="level3">
<h3 class="anchored" data-anchor-id="how-do-i-know-what-kind-of-missing-data-mechanism-i-have">How do I know what kind of missing data mechanism I have?</h3>
<p>Unfortunately, there’s no way to determine the missing data mechanism purely by looking at the data — you need to think about the process generating the data and why some of it is missing. Often there will be different reasons for missing data in the same variable. A causal DAG is a good way to reason about the relationship between the variables and their reasons for being missing and can help you decide what analysis to use. Rather than using the DAG to determine whether your data is MCAR, MAR, or MNAR, and then use those classifications to choose an analysis, you can use the DAG directly to guide your choice of analysis method. I’ll have examples of this later in this blog.</p>
</section>
<section id="if-i-know-my-missing-data-mechanism-what-analysis-should-i-do" class="level3">
<h3 class="anchored" data-anchor-id="if-i-know-my-missing-data-mechanism-what-analysis-should-i-do">If I know my missing data mechanism, what analysis should I do?</h3>
<p>It depends! (I’m a statistician, you should have known I would say that.) These are the standard results about what missing data methods are appropriate under different processes:</p>
<p>Complete case analysis is unbiased if the data is MCAR. This is a sufficient condition, not a necessary condition <span class="citation" data-cites="little_missing_2021">(Little, 2021)</span>: there are situations where complete case analysis may be valid, or at least provide a valid estimate of a particular quantity of interest, under MAR or MNAR. Depending on the amount of missing data, complete case analysis may be inefficient (i.e., have lower power than other methods) because only cases where no variables have missing values are used in the analysis.</p>
<p>Multiple imputation, inverse probability weighting, likelihood-based methods and full Bayesian methods are unbiased if the data is MAR or MCAR <span class="citation" data-cites="little_missing_2021">(Little, 2021)</span>. Multiple imputation is approximately equivalent to a maximum-likelihood method if the underlying model is the same <span class="citation" data-cites="collins_comparison_2001">(Collins et al., 2001)</span>.</p>
<p>In some specific MNAR situations, some of the above methods may still be valid, depending on what you’re trying to estimate <span class="citation" data-cites="white_bias_2010">(White &amp; Carlin, 2010)</span>.</p>
</section>
</section>
<section id="some-examples-of-missing-data-mechanisms" class="level2">
<h2 class="anchored" data-anchor-id="some-examples-of-missing-data-mechanisms">Some examples of missing data mechanisms</h2>
<p>To make these definitions more concrete, here are some examples of missing data mechanisms that may occur in real studies.</p>
<section id="example-1-planned-missing-data" class="level3">
<h3 class="anchored" data-anchor-id="example-1-planned-missing-data">Example 1: Planned missing data</h3>
<p>Sometimes missing data arises from a study design where some data is not collected on some participants. For example, consider a psychometric instrument with a large number of items. The items could be split up into sets which are asked at different times; for example, half at baseline and half a follow-up. Ideally this process would be randomised so each participant receives a different random split. The items which were not asked at a particular time point are missing values, and because the missingness was deliberately introduced by the experimenter using randomisation, we know that the probability of a particular item being missing is unrelated to any other variable in the study.</p>
<p>This is one of the few cases where we can be sure the data is MCAR.</p>
</section>
<section id="example-2-missingness-related-to-confounders-only" class="level3">
<h3 class="anchored" data-anchor-id="example-2-missingness-related-to-confounders-only">Example 2: Missingness related to confounders only</h3>
<p>Consider a longitudinal study where participants need to regularly travel to a site, for example a hospital, in order for their data to be recorded. Participants living in rural or remote areas may find the travel more inconvenient if they need to visit a city to participate in the study, and thus be more likely to have missing values in many variables.</p>
<p>If we know the location of all of the participants, this missingness mechanism would be MAR.</p>
</section>
<section id="example-3-missingness-related-to-confounders-and-exposure" class="level3">
<h3 class="anchored" data-anchor-id="example-3-missingness-related-to-confounders-and-exposure">Example 3: Missingness related to confounders and exposure</h3>
<p>This example is drawn from <span class="citation" data-cites="moreno-betancur_canonical_2018">Moreno-Betancur et al. (2018)</span>. Suppose we want to investigate the relationship between childhood maternal mental illness (the exposure, in epidemiologist-speak) and child behaviour in subsequent years (the outcome). In order to provide a causal estimate of the effect of this exposure, we must control for confounding variables, such as maternal alcohol consumption, smoking, and other variables relating to the child’s behaviour.</p>
<p>It was considered likely that missingness in all variables was related to both maternal mental illness and the confounding variables. Since child behaviour was measured at a later time than the exposure and confounding variables, it was considered unlikely to have affected missingness in the confounders or exposure.</p>
<p>It was uncertain whether missingness in child behaviour could be related to the child behaviour itself — so there are two plausible missing data mechanisms to consider in this example. Both of those plausible mechanisms are MNAR, but we will see later than one possibility is amenable for analysis and the other is not.</p>
</section>
</section>
<section id="making-the-missing-data-process-explicit-using-causal-diagrams-dags" class="level2">
<h2 class="anchored" data-anchor-id="making-the-missing-data-process-explicit-using-causal-diagrams-dags">Making the missing data process explicit using causal diagrams (DAGs)</h2>
<p>Causal diagrams are used to represent causal relationships between variables in a study <span class="citation" data-cites="pearl_causal_1995">(Pearl, 1995)</span>. These relationships are shown visually using a directed acyclic graph (DAG), which is a mathematical term for a bunch of circles with arrows between them. The circles (nodes) represent variables and arrows (edges) between them represent direct causal pathways. The direction of the arrows represents the direction of causation, and a valid DAG never has a path leading from a particular point back to that same point<sup>2</sup>. If there is no path following the arrows between two variables in a DAG, there is no causal connection between them.</p>
<p>The structure of the DAG behind your data cannot be inferred just from looking at the data. It needs to come from substantive expertise about the underlying variables in the data, their relationship to each other, and how the data was collected.</p>
<p>The idea of using a DAG to represent missing data assumptions was first introduced in <span class="citation" data-cites="mohan_graphical_2014">Mohan &amp; Pearl (2014)</span>. To provide more practical advice for specific scenarios, <span class="citation" data-cites="moreno-betancur_canonical_2018">Moreno-Betancur et al. (2018)</span> introduces “canonical” causal diagrams for missing data in the setting where we want to estimate the relationship between an outcome <em>Y</em> and an exposure <em>X</em><sup>3</sup>, adjusting for some confounding variables which may influence both the outcome and the exposure. The confounding variables may be either completely observed (<em>Z1</em>) or have some missing data (<em>Z2</em>). There may also be some unknown, unmeasured factors <em>U</em> which affect the exposure and the confounders.</p>
<p>The DAG corresponding to the scenario above is shown below. If you click the “Code” button you can see how it was produced in R, using the packages <a href="http://www.dagitty.net/"><em>dagitty</em></a> <span class="citation" data-cites="textor_robust_2017">(Textor et al., 2017)</span> and <a href="https://CRAN.R-project.org/package=ggdag"><em>ggdag</em></a>. You don’t need to understand R code to use and apply DAGs but it is provided as an example for those who may want to make causal diagrams for their own studies. The first part of the code describes the underlying relationships between the variables, using the same syntax used to describe regression models in R. The second part of the code sets up the visual coordinates used for plotting the DAG — an aesthetic consideration only.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">dag_nomiss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dagify</span>(</span>
<span id="cb1-2">  Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2,</span>
<span id="cb1-3">  X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> U,</span>
<span id="cb1-4">  Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> U,</span>
<span id="cb1-5">  Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> U,</span>
<span id="cb1-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">coords =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb1-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">U =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z2 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),</span>
<span id="cb1-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">U =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z2 =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb1-9">  )</span>
<span id="cb1-10">)</span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggdag</span>(dag_nomiss) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_dag</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2023/06/untangling-mar-mcar-mnar/index_files/figure-html/dag-nomiss-1.png" class="img-fluid" width="1170"></p>
</div>
</div>
<p>This DAG is called a complete-data DAG, or <em>c-DAG</em>. It represents the causal relationships between the variables if all of them had been completely observed.</p>
<p>To represent possible causes of missing data, we can introduce three new variables in the DAG: <em>MX</em>, <em>MY</em> and <em>MZ2</em>, representing whether or not the exposure (<em>X</em>), outcome (<em>Y</em>), or partially-observed confounders (<em>Z2</em>) are missing. Think of them as binary indicator variables, where for example <em>MX</em> = 1 means that <em>X</em> wasn’t observed (for a particular case/participant/observation) and <em>MX</em> = 0 means that <em>X</em> was observed. Adding these variables produces a missingness DAG, or <em>m-DAG</em>. <span class="citation" data-cites="moreno-betancur_canonical_2018">Moreno-Betancur et al. (2018)</span> also considers unmeasured causes of missingness (<em>W</em>) which are not related to any of the substantive variables in the study but do affect the probability of missingness.</p>
<p>The variables in the DAG which aren’t prefixed with <em>M</em> still refer to values of the variables as if they had been completely observed — which we no longer have full access to in our real data since we only get to see the variables after the missingness mechanism has occurred. This ensures that the causal mechanism in the c-DAG still applies to the m-DAG, so the m-DAG can be produced by adding additional nodes and arrows to the c-DAG without changing any of the arrows between existing nodes.</p>
<p>If we turn the c-DAG above into an m-DAG by adding nodes for <em>MX</em>, <em>MY</em>, and <em>MZ2</em> but no additional arrows, the absence of arrows to <em>MX</em>, <em>MY</em> and <em>MZ2</em> would mean that there is no causal relationship between any of the variables and their missingness — in other words, the MCAR missingness mechanism. This scenario would be quite unusual in most real studies, unless the missing data was deliberately planned like our first example in the previous section.</p>
<p>This m-DAG is shown below, with an additional variable <em>W</em> representing unmeasured variables which affect the missing data process but are not related to any of the variables in the study. The new variables representing the missing data mechanism are shown in blue. In that MCAR scenario, the blue nodes (missing data mechanism) are completely disconnected from black nodes (relating to the main research question).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">dag_mcar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dagify</span>(</span>
<span id="cb2-2">  Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2,</span>
<span id="cb2-3">  X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> U,</span>
<span id="cb2-4">  Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> U,</span>
<span id="cb2-5">  Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> U,</span>
<span id="cb2-6">  MX <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> W,</span>
<span id="cb2-7">  MY <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> W,</span>
<span id="cb2-8">  MZ2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> W,</span>
<span id="cb2-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">coords =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb2-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">U =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z2 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb2-11">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MX =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MY =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MZ2 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb2-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">U =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z1 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z2 =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb2-13">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MX =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MY =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MZ2 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)</span>
<span id="cb2-14">  )</span>
<span id="cb2-15">)</span>
<span id="cb2-16">dag_mcar <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy_dagitty</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb2-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_colour =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb2-20">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_starts</span>(name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"W"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodgerblue3"</span>,</span>
<span id="cb2-21">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span></span>
<span id="cb2-22">    ),</span>
<span id="cb2-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">edge_colour =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb2-24">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_starts</span>(to, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodgerblue3"</span>,</span>
<span id="cb2-25">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span></span>
<span id="cb2-26">    )</span>
<span id="cb2-27">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> xend, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> yend)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_edges</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">edge_colour =</span> edge_colour)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> node_colour)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.88</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_dag</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_colour_identity</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2023/06/untangling-mar-mcar-mnar/index_files/figure-html/dag-mcar-1.png" class="img-fluid" width="1170"></p>
</div>
</div>
<p>Figure 2 in <span class="citation" data-cites="moreno-betancur_canonical_2018">Moreno-Betancur et al. (2018)</span> provides 10 examples of m-DAGs, with different combinations of the following features:</p>
<ul>
<li>incomplete confounders and exposure related to missingness of other variables;</li>
<li>incomplete confounders and exposure related to their own missingness;</li>
<li>outcome related to missingness of other variables; and</li>
<li>outcome related to its own missingness.</li>
</ul>
<p>The first of these canonical DAGs, m-DAG A, is an example of a MAR process, where the missingness is only related to completely-observed confounders (<em>Z1</em>) and unmeasured variables unrelated to other variables in the study (<em>W</em>). This DAG describes Example 2 in the previous section, with participant location (part of <em>Z1</em>) causing missingness in other variables (<em>MX</em>, <em>MY</em>, <em>MZ2</em>). This DAG is reproduced below, with the nodes and arrows related to the missing data mechanism shown in blue:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">dag_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dagify</span>(</span>
<span id="cb3-2">  Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2,</span>
<span id="cb3-3">  X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> U,</span>
<span id="cb3-4">  Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> U,</span>
<span id="cb3-5">  Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> U,</span>
<span id="cb3-6">  MX <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> W,</span>
<span id="cb3-7">  MY <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> W,</span>
<span id="cb3-8">  MZ2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> W,</span>
<span id="cb3-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">coords =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb3-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">U =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z2 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb3-11">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MX =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MY =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MZ2 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb3-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">U =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z1 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z2 =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-13">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MX =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MY =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MZ2 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)</span>
<span id="cb3-14">  )</span>
<span id="cb3-15">)</span>
<span id="cb3-16">dag_a <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy_dagitty</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb3-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_colour =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb3-20">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_starts</span>(name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"W"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodgerblue3"</span>,</span>
<span id="cb3-21">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span></span>
<span id="cb3-22">    ),</span>
<span id="cb3-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">edge_colour =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb3-24">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_starts</span>(to, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodgerblue3"</span>,</span>
<span id="cb3-25">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span></span>
<span id="cb3-26">    )</span>
<span id="cb3-27">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> xend, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> yend)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_edges</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">edge_colour =</span> edge_colour)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> node_colour)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.88</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_dag</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_colour_identity</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2023/06/untangling-mar-mcar-mnar/index_files/figure-html/dag-a-1.png" class="img-fluid" width="1170"></p>
</div>
</div>
<p>In this DAG, so long as the model’s adjustment for confounders is correctly specified (a big “if”!), both complete cases analysis and multiple imputation provide valid estimates of not just the relationship between the exposure and the outcome, but also the complete distribution of the outcome. This isn’t something that should be obvious just from looking at the DAG — there’s a derivation in the supplementary materials for <span class="citation" data-cites="moreno-betancur_canonical_2018">Moreno-Betancur et al. (2018)</span> for this and the other DAGs, with the results summarised in Tables 1 and 2 of that paper. Those who are familiar with causal DAGs may want to know that when there is missing data, this derivation is more complex than rules like “d-separation” and cannot be done algorithmically.</p>
<p>In other missing data situations, it may be possible to obtain a valid estimate of the effect of the exposure but not, for example, the population mean of the outcome. In some situations, it may not be possible to obtain a valid estimate of either.</p>
<p>The figure below shows m-DAG E, which is an example of an MNAR process. The arrows new to this DAG which weren’t in m-DAG A are shown in red. The probability of missingness in all variables is affected by both the exposure <em>X</em> (which may itself have missing values) and partially-observed confounders <em>Z2</em>. This DAG corresponds to Example 3 in the previous section, if we believe that missingness in child behaviour is not related to the missing values of child behaviour. Perhaps surprisingly, even though this missingness process is MNAR, it is possible to obtain a valid estimate of the relationship between the exposure and the outcome using either complete cases analysis or multiple imputation. However, it is not possible to recover the overall population mean of the outcome.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">dag_e <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dagify</span>(</span>
<span id="cb4-2">  Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2,</span>
<span id="cb4-3">  X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> U,</span>
<span id="cb4-4">  Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> U,</span>
<span id="cb4-5">  Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> U,</span>
<span id="cb4-6">  MX <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> W,</span>
<span id="cb4-7">  MY <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> W,</span>
<span id="cb4-8">  MZ2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> W,</span>
<span id="cb4-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">coords =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb4-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">U =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z2 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb4-11">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MX =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MY =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MZ2 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb4-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">U =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z1 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z2 =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-13">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MX =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MY =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MZ2 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)</span>
<span id="cb4-14">  )</span>
<span id="cb4-15">)</span>
<span id="cb4-16">dag_e <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy_dagitty</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb4-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_colour =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb4-20">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_starts</span>(name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"W"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodgerblue3"</span>,</span>
<span id="cb4-21">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span></span>
<span id="cb4-22">    ),</span>
<span id="cb4-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">edge_colour =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb4-24">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_starts</span>(to, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Z2"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick3"</span>,</span>
<span id="cb4-25">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_starts</span>(to, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodgerblue3"</span>,</span>
<span id="cb4-26">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span></span>
<span id="cb4-27">    )</span>
<span id="cb4-28">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> xend, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> yend)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_edges</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">edge_colour =</span> edge_colour)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> node_colour)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.88</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_dag</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_colour_identity</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2023/06/untangling-mar-mcar-mnar/index_files/figure-html/dag-e-1.png" class="img-fluid" width="1170"></p>
</div>
</div>
<p>The final example in this blog is m-DAG J, which is another MNAR process. The arrows new to this DAG are shown in purple. In this example, missingness is also affected by the value of the outcome <em>Y</em>. This DAG is similar to the one for Example 3 in the previous section, if we believe that missingness in the outcome (child behaviour) is related to its own unobserved values. For this m-DAG, it is not possible to recover the relationship between the outcome and the exposure.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">dag_j <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dagify</span>(</span>
<span id="cb5-2">  Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2,</span>
<span id="cb5-3">  X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> U,</span>
<span id="cb5-4">  Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> U,</span>
<span id="cb5-5">  Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> U,</span>
<span id="cb5-6">  MX <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> W,</span>
<span id="cb5-7">  MY <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> W,</span>
<span id="cb5-8">  MZ2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Z1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> W,</span>
<span id="cb5-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">coords =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb5-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">U =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z2 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb5-11">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MX =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MY =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MZ2 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb5-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">U =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z1 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Z2 =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb5-13">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MX =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MY =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MZ2 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)</span>
<span id="cb5-14">  )</span>
<span id="cb5-15">)</span>
<span id="cb5-16">dag_j <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy_dagitty</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb5-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_colour =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb5-20">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_starts</span>(name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"W"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodgerblue3"</span>,</span>
<span id="cb5-21">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span></span>
<span id="cb5-22">    ),</span>
<span id="cb5-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">edge_colour =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb5-24">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_starts</span>(to, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkorchid3"</span>,</span>
<span id="cb5-25">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_starts</span>(to, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Z2"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick3"</span>,</span>
<span id="cb5-26">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_starts</span>(to, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodgerblue3"</span>,</span>
<span id="cb5-27">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span></span>
<span id="cb5-28">    )</span>
<span id="cb5-29">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> xend, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> yend)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_edges</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">edge_colour =</span> edge_colour)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> node_colour)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.88</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_dag</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_colour_identity</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2023/06/untangling-mar-mcar-mnar/index_files/figure-html/dag-j-1.png" class="img-fluid" width="1170"></p>
</div>
</div>
<p>If you have an m-DAG where a quantity of interest cannot be recovered, you can consider doing a sensitivity analysis using a <img src="https://latex.codecogs.com/png.latex?%5Cdelta">-adjustment. This process is described in popular texts on missing data, e.g. <span class="citation" data-cites="van_buuren_flexible_2018">van Buuren (2018)</span> sec 9.2 (also <a href="https://stefvanbuuren.name/fimd/sec-sensitivity.html">available online</a>) or <span class="citation" data-cites="molenberghs_handbook_2015">Molenberghs et al. (2015)</span>.</p>
</section>
<section id="applying-dags-to-real-missing-data-problems" class="level2">
<h2 class="anchored" data-anchor-id="applying-dags-to-real-missing-data-problems">Applying DAGs to real missing data problems</h2>
<p>This section draws heavily from <span class="citation" data-cites="lee_assumptions_2023">Lee et al. (2023)</span> — especially Figure 1 of that paper — which provides practical guidance for data analysis using missingness DAGs.</p>
<p>Start by determining the estimand of interest: the scientific quantity you would like to estimate, if you had access to the complete data.</p>
<p>Next, draw a DAG representing the causal relationships between your variables and their possible reasons for being missing. This will require some thinking about which arrows are plausible and which are not, based on your understanding of the real-world relationships between variables and the way the data has been collected.</p>
<p>Before deciding on an analysis method, you must first determine whether the estimand is recoverable, i.e.&nbsp;whether it is possible to estimate it from the data<sup>4</sup>. One possibility is to compare your DAG to the canonical DAGs in <span class="citation" data-cites="moreno-betancur_canonical_2018">Moreno-Betancur et al. (2018)</span> and the recoverability results in Table 1 of that paper.</p>
<p>If your estimand is recoverable, you can proceed to deciding on an analysis method to handle the missing data. Again, the canonical DAGs are useful for this. For canonical DAGs A, B, D and E, complete cases analysis was shown to provide a valid estimate of the relationship between the outcome and the exposure. For canonical DAGs A, B, C, D and E, multiple imputation was shown to provide a valid estimate of the relationship between the outcome and the exposure.</p>
<p>Randomised clinical trials provide some additional guarantees about the nature of the missing data process which observational studies do not: the assigned intervention is completely observed and known to be unrelated to baseline covariates. While it doesn’t use the m-DAG framework, <span class="citation" data-cites="sullivan_should_2018">Sullivan et al. (2018)</span> considers several methods for dealing with missing data in randomised trials that may be useful for those working in that setting.</p>
<p>The papers above provide examples of situations where multiple imputation is not necessarily better than simpler methods, as well as situations where complete case analysis does not produce valid inference. The situations where particular missing data methods work do not neatly align with the definitions of MCAR/MAR/MNAR but by drawing a DAG and considering the results in the papers above you should be able to determine which popular methods are applicable to your data and research question.</p>
</section>
<section id="acknowledgements" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h2>
<p>Thanks to Isabella Ghement, Lachlan Cribb, and Tom Sullivan for providing valuable feedback which greatly improved this blog post. Last updated: 6 July 2023.</p>
</section>
<section id="references" class="level2">




</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-line-spacing="2">
<div id="ref-collins_comparison_2001" class="csl-entry">
Collins, L. M., Schafer, J. L., &amp; Kam, C.-M. (2001). A comparison of inclusive and restrictive strategies in modern missing data procedures. <em>Psychological Methods</em>, <em>6</em>(4), 330–351. <a href="https://doi.org/10.1037/1082-989X.6.4.330">https://doi.org/10.1037/1082-989X.6.4.330</a>
</div>
<div id="ref-lee_assumptions_2023" class="csl-entry">
Lee, K. J., Carlin, J. B., Simpson, J. A., &amp; Moreno-Betancur, M. (2023). Assumptions and analysis planning in studies with missing data in multiple variables: Moving beyond the <span>MCAR</span>/<span>MAR</span>/<span>MNAR</span> classification. <em>International Journal of Epidemiology</em>, dyad008. <a href="https://doi.org/10.1093/ije/dyad008">https://doi.org/10.1093/ije/dyad008</a>
</div>
<div id="ref-lee_framework_2021" class="csl-entry">
Lee, K. J., Tilling, K. M., Cornish, R. P., Little, R. J. A., Bell, M. L., Goetghebeur, E., Hogan, J. W., &amp; Carpenter, J. R. (2021). Framework for the treatment and reporting of missing data in observational studies: <span>The</span> <span>Treatment</span> <span>And</span> <span>Reporting</span> of <span>Missing</span> data in <span>Observational</span> <span>Studies</span> framework. <em>Journal of Clinical Epidemiology</em>, <em>134</em>, 79–88. <a href="https://doi.org/10.1016/j.jclinepi.2021.01.008">https://doi.org/10.1016/j.jclinepi.2021.01.008</a>
</div>
<div id="ref-little_missing_2021" class="csl-entry">
Little, R. J. A. (2021). Missing <span>Data</span> <span>Assumptions</span>. <em>Annual Review of Statistics and Its Application</em>, <em>8</em>(1), 89–107. <a href="https://doi.org/10.1146/annurev-statistics-040720-031104">https://doi.org/10.1146/annurev-statistics-040720-031104</a>
</div>
<div id="ref-little_statistical_2014" class="csl-entry">
Little, R. J. A., &amp; Rubin, D. B. (2014). <em>Statistical analysis with missing data</em> (Second edition). John Wiley &amp; Sons.
</div>
<div id="ref-marini_maximum-likelihood_1980" class="csl-entry">
Marini, M. M., Olsen, A. R., &amp; Rubin, D. B. (1980). Maximum-<span>Likelihood</span> <span>Estimation</span> in <span>Panel</span> <span>Studies</span> with <span>Missing</span> <span>Data</span>. <em>Sociological Methodology</em>, <em>11</em>, 314. <a href="https://doi.org/10.2307/270868">https://doi.org/10.2307/270868</a>
</div>
<div id="ref-mohan_graphical_2014" class="csl-entry">
Mohan, K., &amp; Pearl, J. (2014). Graphical <span>Models</span> for <span>Recovering</span> <span>Probabilistic</span> and <span>Causal</span> <span>Queries</span> from <span>Missing</span> <span>Data</span>. <em>Proceedings of the 27th <span>International</span> <span>Conference</span> on <span>Neural</span> <span>Information</span> <span>Processing</span> <span>Systems</span> - <span>Volume</span> 1</em>, 1520–1528.
</div>
<div id="ref-molenberghs_handbook_2015" class="csl-entry">
Molenberghs, G., Fitzmaurice, G. M., Kenward, M. G., Tsiatis, A. A., &amp; Verbeke, G. (Eds.). (2015). <em>Handbook of missing data methodology</em>. CRC Press, Taylor &amp; Francis Group.
</div>
<div id="ref-moreno-betancur_canonical_2018" class="csl-entry">
Moreno-Betancur, M., Lee, K. J., Leacy, F. P., White, I. R., Simpson, J. A., &amp; Carlin, J. B. (2018). Canonical <span>Causal</span> <span>Diagrams</span> to <span>Guide</span> the <span>Treatment</span> of <span>Missing</span> <span>Data</span> in <span>Epidemiologic</span> <span>Studies</span>. <em>American Journal of Epidemiology</em>, <em>187</em>(12), 2705–2715. <a href="https://doi.org/10.1093/aje/kwy173">https://doi.org/10.1093/aje/kwy173</a>
</div>
<div id="ref-pearl_causal_1995" class="csl-entry">
Pearl, J. (1995). Causal diagrams for empirical research. <em>Biometrika</em>, <em>82</em>(4), 669–688. <a href="https://doi.org/10.1093/biomet/82.4.669">https://doi.org/10.1093/biomet/82.4.669</a>
</div>
<div id="ref-rubin_inference_1976" class="csl-entry">
Rubin, D. B. (1976). Inference and missing data. <em>Biometrika</em>, <em>63</em>(3), 581–592. <a href="https://doi.org/10.1093/biomet/63.3.581">https://doi.org/10.1093/biomet/63.3.581</a>
</div>
<div id="ref-seaman_what_2013" class="csl-entry">
Seaman, S., Galati, J., Jackson, D., &amp; Carlin, J. (2013). What <span>Is</span> <span>Meant</span> by <span>“<span>Missing</span> at <span>Random</span>”</span>? <em>Statistical Science</em>, <em>28</em>(2). <a href="https://doi.org/10.1214/13-STS415">https://doi.org/10.1214/13-STS415</a>
</div>
<div id="ref-sullivan_should_2018" class="csl-entry">
Sullivan, T. R., White, I. R., Salter, A. B., Ryan, P., &amp; Lee, K. J. (2018). Should multiple imputation be the method of choice for handling missing data in randomized trials? <em>Statistical Methods in Medical Research</em>, <em>27</em>(9), 2610–2626. <a href="https://doi.org/10.1177/0962280216683570">https://doi.org/10.1177/0962280216683570</a>
</div>
<div id="ref-textor_robust_2017" class="csl-entry">
Textor, J., Van Der Zander, B., Gilthorpe, M. S., Liśkiewicz, M., &amp; Ellison, G. T. H. (2017). Robust causal inference using directed acyclic graphs: The <span>R</span> package <span>“dagitty.”</span> <em>International Journal of Epidemiology</em>, dyw341. <a href="https://doi.org/10.1093/ije/dyw341">https://doi.org/10.1093/ije/dyw341</a>
</div>
<div id="ref-van_buuren_flexible_2018" class="csl-entry">
van Buuren, S. (2018). <em>Flexible imputation of missing data</em> (Second edition). CRC Press, Taylor; Francis Group.
</div>
<div id="ref-white_bias_2010" class="csl-entry">
White, I. R., &amp; Carlin, J. B. (2010). Bias and efficiency of multiple imputation compared with complete-case analysis for missing covariate values. <em>Statistics in Medicine</em>, <em>29</em>(28), 2920–2931. <a href="https://doi.org/10.1002/sim.3944">https://doi.org/10.1002/sim.3944</a>
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>There are a few subtly different ways of defining this concept mathematically; <span class="citation" data-cites="seaman_what_2013">Seaman et al. (2013)</span> goes into the detail for those who are interested.↩︎</p></li>
<li id="fn2"><p>A “cycle” in mathematician-speak. Hence, directed (arrows have a direction) acyclic (can never get back to where you started) graph (set of nodes and edges).↩︎</p></li>
<li id="fn3"><p>That’s epidemiologist-speak for the main predictor of interest.↩︎</p></li>
<li id="fn4"><p>This step is analogous to determining identifiability in causal inference.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>missing-data</category>
  <category>statistics</category>
  <guid>https://cameronpatrick.com/post/2023/06/untangling-mar-mcar-mnar/index.html</guid>
  <pubDate>Tue, 27 Jun 2023 14:00:00 GMT</pubDate>
</item>
<item>
  <title>Fitting many statistical models at once using dplyr</title>
  <dc:creator>Cameron Patrick</dc:creator>
  <link>https://cameronpatrick.com/post/2023/06/dplyr-fitting-multiple-models-at-once/index.html</link>
  <description><![CDATA[ 




<p>One common task in applied statistics is to fit and interpret a number of statistical models at once. For example, fitting a model with the same structure to a number of different outcome or explanatory variables, or fitting several models with different structure to the same data. Here are some examples of how I usually do this, using features that were introduced with <code>dplyr</code> version 1.1.0.</p>
<p>For this demonstration, we’ll be using the R packages <code>dplyr</code>, <code>tidyr</code>, <code>ggplot2</code> (all of which are included in the <code>tidyverse</code>), as well as <code>gt</code> for making tables, <code>emmeans</code> for obtaining estimated means and comparisons, and <code>performance</code> for model-checking.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gt)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(emmeans)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(performance)</span></code></pre></div>
</div>
<p>We’ll be using the <a href="https://allisonhorst.github.io/palmerpenguins/">Palmer Penguins data</a> collected at Palmer Station, Antarctica, made available by Dr Kristen Gorman, and conveniently accessible in R using the <code>palmerpenguins</code> package. This dataset contains measurements on a number of penguins of different species on different islands.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(palmerpenguins)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(penguins)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(penguins)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 8
  species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g
  &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt;
1 Adelie  Torgersen           39.1          18.7               181        3750
2 Adelie  Torgersen           39.5          17.4               186        3800
3 Adelie  Torgersen           40.3          18                 195        3250
4 Adelie  Torgersen           NA            NA                  NA          NA
5 Adelie  Torgersen           36.7          19.3               193        3450
6 Adelie  Torgersen           39.3          20.6               190        3650
# ℹ 2 more variables: sex &lt;fct&gt;, year &lt;int&gt;</code></pre>
</div>
</div>
<p>Suppose we want to compare bill length, bill depth, flipper length, and body mass between species. We could manually run a separate model for each, but here’s a way to to automate the process. As with many things in R, the trick to doing this easily is to get the data in long form, with the outcomes stacked on top of each other, and a variable indicating which outcome is being measured.</p>
<p>The <code>pivot_longer()</code> function from <code>tidyr</code> gets the data into this format. I’ve also taken an extra step of recoding the “outcome” variable to give more descriptive labels. This isn’t required but it will make the tables and plots that we make later look nicer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">penguins_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> penguins <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(</span>
<span id="cb4-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bill_length_mm, bill_depth_mm, flipper_length_mm, body_mass_g),</span>
<span id="cb4-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"outcome"</span>,</span>
<span id="cb4-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span></span>
<span id="cb4-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb4-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_inorder</span>(outcome),</span>
<span id="cb4-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_recode</span>(</span>
<span id="cb4-10">      outcome,</span>
<span id="cb4-11">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bill length (mm)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bill_length_mm"</span>,</span>
<span id="cb4-12">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bill depth (mm)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bill_depth_mm"</span>,</span>
<span id="cb4-13">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Flipper length (mm)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flipper_length_mm"</span>,</span>
<span id="cb4-14">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Body mass (g)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"body_mass_g"</span></span>
<span id="cb4-15">    )</span>
<span id="cb4-16">  )</span></code></pre></div>
</div>
<p>Looking at the first few rows of this data frame, you can see we now have four rows for each penguin, one for each type of measurement:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(penguins_long)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  species island    sex     year outcome              value
  &lt;fct&gt;   &lt;fct&gt;     &lt;fct&gt;  &lt;int&gt; &lt;fct&gt;                &lt;dbl&gt;
1 Adelie  Torgersen male    2007 Bill length (mm)      39.1
2 Adelie  Torgersen male    2007 Bill depth (mm)       18.7
3 Adelie  Torgersen male    2007 Flipper length (mm)  181  
4 Adelie  Torgersen male    2007 Body mass (g)       3750  
5 Adelie  Torgersen female  2007 Bill length (mm)      39.5
6 Adelie  Torgersen female  2007 Bill depth (mm)       17.4</code></pre>
</div>
</div>
<p>We can use <code>group_by()</code> and <code>summarise()</code> from the <code>dplyr</code> package to group the rows by outcome, and then “summarise” these groups of rows down to a single row containing a statistical model for each outcome. This makes use of a couple of R tricks: ‘list columns’, a column in a data frame that contains a more complex object than the standard R data types (numeric, character, etc); and the new <code>pick()</code> verb which returns a data frame containing selected columns (in this case, all of them) within the group that’s being operated on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">penguin_models <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> penguins_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(outcome) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb7-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb7-5">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> species, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pick</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>()))</span>
<span id="cb7-6">    )</span>
<span id="cb7-7">  )</span></code></pre></div>
</div>
<p>You can see the resulting data from contains four rows, one for each outcome, and a statistical model (“lm”) for each:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(penguin_models)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  outcome             model 
  &lt;fct&gt;               &lt;list&gt;
1 Bill length (mm)    &lt;lm&gt;  
2 Bill depth (mm)     &lt;lm&gt;  
3 Flipper length (mm) &lt;lm&gt;  
4 Body mass (g)       &lt;lm&gt;  </code></pre>
</div>
</div>
<p>Ideally we would also do a visual check of model assumptions. One way to do this is something like the code below, which saves a residual plot for each model to an image file, which can be inspected later. It uses the <code>check_model()</code> function in the <code>performance</code> package to generate the plots. The generated residual plots aren’t shown here, but they all look fine.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">walk2</span>(</span>
<span id="cb10-2">  penguin_models<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>outcome, </span>
<span id="cb10-3">  penguin_models<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>model,</span>
<span id="cb10-4">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(</span>
<span id="cb10-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(.x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".png"</span>),</span>
<span id="cb10-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">check_model</span>(.y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">check =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pp_check"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"linearity"</span>,</span>
<span id="cb10-7">                                   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"homogeneity"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qq"</span>))),</span>
<span id="cb10-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,</span>
<span id="cb10-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span></span>
<span id="cb10-10">  )</span>
<span id="cb10-11">)</span></code></pre></div>
</div>
<p>Once we’ve fitted the models, we can obtain quantities of interest from them. In this example we’ll look at estimated means for each species, p-values testing the hypothesis that all species means are equal (against at least one pair of means being different), and comparisons (differences in means) between all pairs of species.</p>
<p>The <code>reframe()</code> function from <code>dplyr</code> allows us to run some code that produces a data frame on each model and stack the results on top of each other. We can use the <code>emmeans()</code> function from the <code>emmeans</code> package to obtain estimated marginal means and <code>as_tibble()</code> to convert the result into a data frame. The <code>rowwise(outcome)</code> at the start tells <code>reframe()</code> that we want to call <code>emmeans()</code> separately for each row of the data frame (i.e., each outcome model), and preserve the <code>outcome</code> variable in the result.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">penguin_means <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> penguin_models <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>(outcome) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reframe</span>(</span>
<span id="cb11-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">emmeans</span>(model, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"species"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-5">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span>
<span id="cb11-6">  )</span></code></pre></div>
</div>
<p>The first few rows of the resulting data frame are shown below. There is a row for each outcome for each species, containing the mean (<code>emmean</code>), standard error (<code>SE</code>), degrees of freedom (<code>df</code>) and lower and upper confidence limits (<code>lower.CL</code> and <code>upper.CL</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(penguin_means)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
  outcome          species   emmean     SE    df lower.CL upper.CL
  &lt;fct&gt;            &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 Bill length (mm) Adelie      38.8 0.241    339     38.3     39.3
2 Bill length (mm) Chinstrap   48.8 0.359    339     48.1     49.5
3 Bill length (mm) Gentoo      47.5 0.267    339     47.0     48.0
4 Bill depth (mm)  Adelie      18.3 0.0912   339     18.2     18.5
5 Bill depth (mm)  Chinstrap   18.4 0.136    339     18.2     18.7
6 Bill depth (mm)  Gentoo      15.0 0.101    339     14.8     15.2</code></pre>
</div>
</div>
<p>We can use <code>ggplot()</code> to present the results visually. The plot shows that there’s a substantial variation between species in means of all of these measurements, with little or no overlap between many of the confidence intervals. Gentoo penguins appear to be heavier, and have longer flippers but shorter and shallower bills, than the other species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">penguin_means <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb14-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> emmean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> species, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> lower.CL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> upper.CL)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> rev) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(outcome), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_x"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb14-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mean"</span>, </span>
<span id="cb14-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Species"</span>,</span>
<span id="cb14-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error bars show 95% confidence interval for mean."</span></span>
<span id="cb14-11">  )</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2023/06/dplyr-fitting-multiple-models-at-once/index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="1170"></p>
</div>
</div>
<p>The <code>gt()</code> function can be used to produce a nice table of results. The code shown below combines the <code>lower.CL</code> and <code>upper.CL</code> columns to produce a single column with the confidence interval, and separately specifies fewer decimal places for body mass than the other measures. The <code>group_by()</code> function before <code>gt()</code> results in a table sub-heading for each outcome. You could easily change this to <code>group_by(species)</code> to arrange the results by species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">penguin_means <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(outcome) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gt</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_number</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(emmean, SE, lower.CL, upper.CL),</span>
<span id="cb15-5">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decimals =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">use_seps =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_number</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(emmean, SE, lower.CL, upper.CL),</span>
<span id="cb15-7">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rows =</span> outcome <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Body mass (g)"</span>,</span>
<span id="cb15-8">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decimals =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">use_seps =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_number</span>(df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decimals =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cols_align</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>, species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cols_merge_range</span>(lower.CL, upper.CL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cols_label</span>(</span>
<span id="cb15-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">species =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Species"</span>,</span>
<span id="cb15-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">emmean =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mean"</span>,</span>
<span id="cb15-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower.CL =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"95% Confidence Interval"</span></span>
<span id="cb15-16">  )</span></code></pre></div>
<div class="cell-output-display">

<div id="rszjvtckrc" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#rszjvtckrc table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#rszjvtckrc thead, #rszjvtckrc tbody, #rszjvtckrc tfoot, #rszjvtckrc tr, #rszjvtckrc td, #rszjvtckrc th {
  border-style: none;
}

#rszjvtckrc p {
  margin: 0;
  padding: 0;
}

#rszjvtckrc .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#rszjvtckrc .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#rszjvtckrc .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#rszjvtckrc .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#rszjvtckrc .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#rszjvtckrc .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#rszjvtckrc .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#rszjvtckrc .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#rszjvtckrc .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#rszjvtckrc .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#rszjvtckrc .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#rszjvtckrc .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#rszjvtckrc .gt_spanner_row {
  border-bottom-style: hidden;
}

#rszjvtckrc .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#rszjvtckrc .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#rszjvtckrc .gt_from_md > :first-child {
  margin-top: 0;
}

#rszjvtckrc .gt_from_md > :last-child {
  margin-bottom: 0;
}

#rszjvtckrc .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#rszjvtckrc .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#rszjvtckrc .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#rszjvtckrc .gt_row_group_first td {
  border-top-width: 2px;
}

#rszjvtckrc .gt_row_group_first th {
  border-top-width: 2px;
}

#rszjvtckrc .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#rszjvtckrc .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#rszjvtckrc .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#rszjvtckrc .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#rszjvtckrc .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#rszjvtckrc .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#rszjvtckrc .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#rszjvtckrc .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#rszjvtckrc .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#rszjvtckrc .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#rszjvtckrc .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#rszjvtckrc .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#rszjvtckrc .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#rszjvtckrc .gt_left {
  text-align: left;
}

#rszjvtckrc .gt_center {
  text-align: center;
}

#rszjvtckrc .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#rszjvtckrc .gt_font_normal {
  font-weight: normal;
}

#rszjvtckrc .gt_font_bold {
  font-weight: bold;
}

#rszjvtckrc .gt_font_italic {
  font-style: italic;
}

#rszjvtckrc .gt_super {
  font-size: 65%;
}

#rszjvtckrc .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#rszjvtckrc .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#rszjvtckrc .gt_indent_1 {
  text-indent: 5px;
}

#rszjvtckrc .gt_indent_2 {
  text-indent: 10px;
}

#rszjvtckrc .gt_indent_3 {
  text-indent: 15px;
}

#rszjvtckrc .gt_indent_4 {
  text-indent: 20px;
}

#rszjvtckrc .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Species">Species</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Mean">Mean</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="SE">SE</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="df">df</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="95% Confidence Interval">95% Confidence Interval</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr class="gt_group_heading_row">
      <th colspan="5" class="gt_group_heading" scope="colgroup" id="Bill length (mm)">Bill length (mm)</th>
    </tr>
    <tr class="gt_row_group_first"><td headers="Bill length (mm)  species" class="gt_row gt_left">Adelie</td>
<td headers="Bill length (mm)  emmean" class="gt_row gt_right">38.8</td>
<td headers="Bill length (mm)  SE" class="gt_row gt_right">0.2</td>
<td headers="Bill length (mm)  df" class="gt_row gt_right">339</td>
<td headers="Bill length (mm)  lower.CL" class="gt_row gt_right">38.3, 39.3</td></tr>
    <tr><td headers="Bill length (mm)  species" class="gt_row gt_left">Chinstrap</td>
<td headers="Bill length (mm)  emmean" class="gt_row gt_right">48.8</td>
<td headers="Bill length (mm)  SE" class="gt_row gt_right">0.4</td>
<td headers="Bill length (mm)  df" class="gt_row gt_right">339</td>
<td headers="Bill length (mm)  lower.CL" class="gt_row gt_right">48.1, 49.5</td></tr>
    <tr><td headers="Bill length (mm)  species" class="gt_row gt_left">Gentoo</td>
<td headers="Bill length (mm)  emmean" class="gt_row gt_right">47.5</td>
<td headers="Bill length (mm)  SE" class="gt_row gt_right">0.3</td>
<td headers="Bill length (mm)  df" class="gt_row gt_right">339</td>
<td headers="Bill length (mm)  lower.CL" class="gt_row gt_right">47.0, 48.0</td></tr>
    <tr class="gt_group_heading_row">
      <th colspan="5" class="gt_group_heading" scope="colgroup" id="Bill depth (mm)">Bill depth (mm)</th>
    </tr>
    <tr class="gt_row_group_first"><td headers="Bill depth (mm)  species" class="gt_row gt_left">Adelie</td>
<td headers="Bill depth (mm)  emmean" class="gt_row gt_right">18.3</td>
<td headers="Bill depth (mm)  SE" class="gt_row gt_right">0.1</td>
<td headers="Bill depth (mm)  df" class="gt_row gt_right">339</td>
<td headers="Bill depth (mm)  lower.CL" class="gt_row gt_right">18.2, 18.5</td></tr>
    <tr><td headers="Bill depth (mm)  species" class="gt_row gt_left">Chinstrap</td>
<td headers="Bill depth (mm)  emmean" class="gt_row gt_right">18.4</td>
<td headers="Bill depth (mm)  SE" class="gt_row gt_right">0.1</td>
<td headers="Bill depth (mm)  df" class="gt_row gt_right">339</td>
<td headers="Bill depth (mm)  lower.CL" class="gt_row gt_right">18.2, 18.7</td></tr>
    <tr><td headers="Bill depth (mm)  species" class="gt_row gt_left">Gentoo</td>
<td headers="Bill depth (mm)  emmean" class="gt_row gt_right">15.0</td>
<td headers="Bill depth (mm)  SE" class="gt_row gt_right">0.1</td>
<td headers="Bill depth (mm)  df" class="gt_row gt_right">339</td>
<td headers="Bill depth (mm)  lower.CL" class="gt_row gt_right">14.8, 15.2</td></tr>
    <tr class="gt_group_heading_row">
      <th colspan="5" class="gt_group_heading" scope="colgroup" id="Flipper length (mm)">Flipper length (mm)</th>
    </tr>
    <tr class="gt_row_group_first"><td headers="Flipper length (mm)  species" class="gt_row gt_left">Adelie</td>
<td headers="Flipper length (mm)  emmean" class="gt_row gt_right">190.0</td>
<td headers="Flipper length (mm)  SE" class="gt_row gt_right">0.5</td>
<td headers="Flipper length (mm)  df" class="gt_row gt_right">339</td>
<td headers="Flipper length (mm)  lower.CL" class="gt_row gt_right">188.9, 191.0</td></tr>
    <tr><td headers="Flipper length (mm)  species" class="gt_row gt_left">Chinstrap</td>
<td headers="Flipper length (mm)  emmean" class="gt_row gt_right">195.8</td>
<td headers="Flipper length (mm)  SE" class="gt_row gt_right">0.8</td>
<td headers="Flipper length (mm)  df" class="gt_row gt_right">339</td>
<td headers="Flipper length (mm)  lower.CL" class="gt_row gt_right">194.2, 197.4</td></tr>
    <tr><td headers="Flipper length (mm)  species" class="gt_row gt_left">Gentoo</td>
<td headers="Flipper length (mm)  emmean" class="gt_row gt_right">217.2</td>
<td headers="Flipper length (mm)  SE" class="gt_row gt_right">0.6</td>
<td headers="Flipper length (mm)  df" class="gt_row gt_right">339</td>
<td headers="Flipper length (mm)  lower.CL" class="gt_row gt_right">216.0, 218.4</td></tr>
    <tr class="gt_group_heading_row">
      <th colspan="5" class="gt_group_heading" scope="colgroup" id="Body mass (g)">Body mass (g)</th>
    </tr>
    <tr class="gt_row_group_first"><td headers="Body mass (g)  species" class="gt_row gt_left">Adelie</td>
<td headers="Body mass (g)  emmean" class="gt_row gt_right">3701</td>
<td headers="Body mass (g)  SE" class="gt_row gt_right">38</td>
<td headers="Body mass (g)  df" class="gt_row gt_right">339</td>
<td headers="Body mass (g)  lower.CL" class="gt_row gt_right">3627, 3775</td></tr>
    <tr><td headers="Body mass (g)  species" class="gt_row gt_left">Chinstrap</td>
<td headers="Body mass (g)  emmean" class="gt_row gt_right">3733</td>
<td headers="Body mass (g)  SE" class="gt_row gt_right">56</td>
<td headers="Body mass (g)  df" class="gt_row gt_right">339</td>
<td headers="Body mass (g)  lower.CL" class="gt_row gt_right">3623, 3843</td></tr>
    <tr><td headers="Body mass (g)  species" class="gt_row gt_left">Gentoo</td>
<td headers="Body mass (g)  emmean" class="gt_row gt_right">5076</td>
<td headers="Body mass (g)  SE" class="gt_row gt_right">42</td>
<td headers="Body mass (g)  df" class="gt_row gt_right">339</td>
<td headers="Body mass (g)  lower.CL" class="gt_row gt_right">4994, 5158</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>We can do similar to produce an overall “F” test for each model, testing the hypothesis that all species have equal means for a particular measure against the hypothesis that at least one pair of means is different. The <code>joint_tests()</code> function in <code>emmeans</code> does this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">penguin_tests <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> penguin_models <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>(outcome) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb16-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reframe</span>(</span>
<span id="cb16-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">joint_tests</span>(model) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb16-5">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span>
<span id="cb16-6">  )</span></code></pre></div>
</div>
<p>The resulting data frame is shown below. This time there is one row per model, but if there had been multiple variables in the model, there would have been one row per variable or interaction term (distinguished by the <code>model term</code> column). Each row contains the results of a hypothesis test: numerator and denominator degrees of freedom (<code>df1</code> and <code>df2</code>), F-statistics (<code>F.ratio</code>) and p-value (<code>p.value</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(penguin_tests)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 6
  outcome             `model term`   df1   df2 F.ratio   p.value
  &lt;fct&gt;               &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;
1 Bill length (mm)    species          2   339    411. 2.69e- 91
2 Bill depth (mm)     species          2   339    360. 1.51e- 84
3 Flipper length (mm) species          2   339    595. 1.35e-111
4 Body mass (g)       species          2   339    344. 2.89e- 82</code></pre>
</div>
</div>
<p>Again, this can be presented in a table using <code>gt()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">penguin_tests <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb19-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gt</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb19-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_number</span>(F.ratio, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decimals =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb19-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmt_number</span>(p.value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decimals =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb19-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cols_merge_range</span>(df1, df2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb19-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sub_small_vals</span>(p.value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">threshold =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb19-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cols_label</span>(</span>
<span id="cb19-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Outcome"</span>,</span>
<span id="cb19-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model term</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predictor"</span>,</span>
<span id="cb19-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df1 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"df"</span>,</span>
<span id="cb19-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">F.ratio =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>,</span>
<span id="cb19-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p.value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p-value"</span></span>
<span id="cb19-13">  )</span></code></pre></div>
<div class="cell-output-display">

<div id="zdbfwnsyjv" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#zdbfwnsyjv table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#zdbfwnsyjv thead, #zdbfwnsyjv tbody, #zdbfwnsyjv tfoot, #zdbfwnsyjv tr, #zdbfwnsyjv td, #zdbfwnsyjv th {
  border-style: none;
}

#zdbfwnsyjv p {
  margin: 0;
  padding: 0;
}

#zdbfwnsyjv .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#zdbfwnsyjv .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#zdbfwnsyjv .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#zdbfwnsyjv .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#zdbfwnsyjv .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zdbfwnsyjv .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zdbfwnsyjv .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zdbfwnsyjv .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#zdbfwnsyjv .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#zdbfwnsyjv .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#zdbfwnsyjv .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#zdbfwnsyjv .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#zdbfwnsyjv .gt_spanner_row {
  border-bottom-style: hidden;
}

#zdbfwnsyjv .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#zdbfwnsyjv .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#zdbfwnsyjv .gt_from_md > :first-child {
  margin-top: 0;
}

#zdbfwnsyjv .gt_from_md > :last-child {
  margin-bottom: 0;
}

#zdbfwnsyjv .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#zdbfwnsyjv .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#zdbfwnsyjv .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#zdbfwnsyjv .gt_row_group_first td {
  border-top-width: 2px;
}

#zdbfwnsyjv .gt_row_group_first th {
  border-top-width: 2px;
}

#zdbfwnsyjv .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zdbfwnsyjv .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#zdbfwnsyjv .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#zdbfwnsyjv .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zdbfwnsyjv .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zdbfwnsyjv .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#zdbfwnsyjv .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#zdbfwnsyjv .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#zdbfwnsyjv .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zdbfwnsyjv .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zdbfwnsyjv .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zdbfwnsyjv .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zdbfwnsyjv .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zdbfwnsyjv .gt_left {
  text-align: left;
}

#zdbfwnsyjv .gt_center {
  text-align: center;
}

#zdbfwnsyjv .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#zdbfwnsyjv .gt_font_normal {
  font-weight: normal;
}

#zdbfwnsyjv .gt_font_bold {
  font-weight: bold;
}

#zdbfwnsyjv .gt_font_italic {
  font-style: italic;
}

#zdbfwnsyjv .gt_super {
  font-size: 65%;
}

#zdbfwnsyjv .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#zdbfwnsyjv .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#zdbfwnsyjv .gt_indent_1 {
  text-indent: 5px;
}

#zdbfwnsyjv .gt_indent_2 {
  text-indent: 10px;
}

#zdbfwnsyjv .gt_indent_3 {
  text-indent: 15px;
}

#zdbfwnsyjv .gt_indent_4 {
  text-indent: 20px;
}

#zdbfwnsyjv .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Outcome">Outcome</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Predictor">Predictor</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="df">df</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="F">F</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="p-value">p-value</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="outcome" class="gt_row gt_center">Bill length (mm)</td>
<td headers="model term" class="gt_row gt_left">species</td>
<td headers="df1" class="gt_row gt_right">2, 339</td>
<td headers="F.ratio" class="gt_row gt_right">410.6</td>
<td headers="p.value" class="gt_row gt_right">&lt;0.001</td></tr>
    <tr><td headers="outcome" class="gt_row gt_center">Bill depth (mm)</td>
<td headers="model term" class="gt_row gt_left">species</td>
<td headers="df1" class="gt_row gt_right">2, 339</td>
<td headers="F.ratio" class="gt_row gt_right">359.8</td>
<td headers="p.value" class="gt_row gt_right">&lt;0.001</td></tr>
    <tr><td headers="outcome" class="gt_row gt_center">Flipper length (mm)</td>
<td headers="model term" class="gt_row gt_left">species</td>
<td headers="df1" class="gt_row gt_right">2, 339</td>
<td headers="F.ratio" class="gt_row gt_right">594.8</td>
<td headers="p.value" class="gt_row gt_right">&lt;0.001</td></tr>
    <tr><td headers="outcome" class="gt_row gt_center">Body mass (g)</td>
<td headers="model term" class="gt_row gt_left">species</td>
<td headers="df1" class="gt_row gt_right">2, 339</td>
<td headers="F.ratio" class="gt_row gt_right">343.6</td>
<td headers="p.value" class="gt_row gt_right">&lt;0.001</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>Finally, we often want to obtain comparisons between particular estimated quantities. In this example we use the <code>emmeans</code> package again for this, this time using the <code>pairs()</code> function to produce comparisons between all pairs of species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">penguin_pairs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> penguin_models <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb20-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>(outcome) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb20-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reframe</span>(</span>
<span id="cb20-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">emmeans</span>(model, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"species"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb20-5">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pairs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">infer =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjust =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb20-6">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span>
<span id="cb20-7">  )</span></code></pre></div>
</div>
<p>The first few rows of the data frame are shown below. The contents are similar to what we saw earlier for the estimated means, but this time each row contains information on a difference between pairs of means (described in the <code>contrast</code> column), along with the estimated difference in means, standard error, degrees of freedom, confidence interval, t-statistic and p-value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(penguin_pairs)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
  outcome       contrast estimate    SE    df lower.CL upper.CL t.ratio  p.value
  &lt;fct&gt;         &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
1 Bill length … Chinstr…  10.0    0.432   339    9.19    10.9    23.2   4.23e-72
2 Bill length … Gentoo …   8.71   0.360   339    8.01     9.42   24.2   5.33e-76
3 Bill length … Gentoo …  -1.33   0.447   339   -2.21    -0.449  -2.97  3.18e- 3
4 Bill depth (… Chinstr…   0.0742 0.164   339   -0.248    0.396   0.453 6.50e- 1
5 Bill depth (… Gentoo …  -3.36   0.136   339   -3.63    -3.10  -24.7   7.93e-78
6 Bill depth (… Gentoo …  -3.44   0.169   339   -3.77    -3.11  -20.3   1.59e-60</code></pre>
</div>
</div>
<p>These comparisons can be plotted or presented in a table using code very similar to what we used for the estimated means. The plot below also includes a dotted line indicating zero difference, which can be used as a visual indicator for whether comparisons are statistically significant.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">penguin_pairs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb23-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> contrast, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> lower.CL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> upper.CL)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> rev) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(outcome), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_x"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb23-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Difference in means"</span>, </span>
<span id="cb23-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Contrast"</span>,</span>
<span id="cb23-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error bars show 95% confidence interval for difference in mean."</span></span>
<span id="cb23-12">  )</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2023/06/dplyr-fitting-multiple-models-at-once/index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="1170"></p>
</div>
</div>



 ]]></description>
  <category>r</category>
  <category>statistical-models</category>
  <guid>https://cameronpatrick.com/post/2023/06/dplyr-fitting-multiple-models-at-once/index.html</guid>
  <pubDate>Wed, 07 Jun 2023 14:00:00 GMT</pubDate>
</item>
<item>
  <title>Making beautiful bar charts with ggplot</title>
  <dc:creator>Cameron Patrick</dc:creator>
  <link>https://cameronpatrick.com/post/2020/03/beautiful-bar-charts-ggplot/index.html</link>
  <description><![CDATA[ 




<p>Bar charts (or bar graphs) are commonly used, but they’re also a simple type of graph where the defaults in ggplot leave a lot to be desired. This is a step-by-step description of how I’d go about improving them, describing the thought processess along the way. Every plot is different and the decisions you make need to reflect the message you’re trying to convey, so don’t treat this post as a recipe, treat it as some points to consider—and hopefully, a few tips that will help you achieve the look you want in your own plots.</p>
<p>For this blog post, I’m going to use the number of seats won by each political party in the 2018 Victorian state election as an example. This data was obtained from <a href="https://www.vec.vic.gov.au/Results/State2018/Summary.html">the Victorian Electoral Commission</a>. Victorians may remember this election being described as a “Danslide”, where Labor, led by Premier Daniel Andrews, won a clear majority of seats.</p>
<p>Here’s the data as an R command you can paste if you want to try making these plots yourself:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">election_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb1-2">                    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>party, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>seats_won,</span>
<span id="cb1-3">       <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Australian Greens"</span>,          <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb1-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Australian Labor Party"</span>,         <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>,</span>
<span id="cb1-5">                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Liberal"</span>,         <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span>,</span>
<span id="cb1-6">           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The Nationals"</span>,          <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,</span>
<span id="cb1-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Other Candidates"</span>,          <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb1-8">)</span></code></pre></div>
</div>
<p>The first decision to make when you’re thinking of making a bar chart is whether you’d be better off using a different type of plot entirely. Bar charts are most suitable for displaying counts, percentages or other quantities where zero has a special meaning. If you make a bar chart, your axis should always start at zero, or the area of the bar gives a misleading visual impression. Other ways of representing data, such as box plots or points with error bars, may be more appropriate for quantities where zero is not an important reference point. If you are representing time series data (repeated observations made over time), a continuous line (perhaps with points at the the times where observations were made) is almost always better than a sequence of bars.</p>
<p>The second decision to make is which axis to put the categorical variable and which axis to put the numerical variable. Having the categories on the <em>y</em> axis often works best. It gives you more space when you have either a large number of categories or categories with long labels.</p>
<p>A lot of software either makes it more difficult to put categories on the <em>y</em> axis, or requires you to change a setting away from the default. This used to be the case for ggplot, but as of version 3.3.0, you just need to tell it which variable goes on which axis, and it will figure out the rest:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(election_data,</span>
<span id="cb2-2">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> seats_won, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> party)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>()</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2020/03/beautiful-bar-charts-ggplot/index_files/figure-html/barchart1-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>The bar chart above is a good starting point, but quite a few things could be improved. The order of the categories is a bit odd: from top to bottom, it’s in reverse alphabetical order. This is the default in ggplot, but it is almost never what you want. The easiest way to change this is to give the option <code>limits = rev</code> to the <em>y</em> axis scale (this is also new in ggplot version 3.3.0):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(election_data,</span>
<span id="cb3-2">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> seats_won, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> party)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> rev)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2020/03/beautiful-bar-charts-ggplot/index_files/figure-html/barchart2-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>In this particular case, alphabetical ordering isn’t the best choice. It’s often best to order categories from most common to least common, or from most to least in the variable you’re displaying (e.g.&nbsp;most to least seats won). There are two functions in the <code>forcats</code> package which can help with this: <code>fct_infreq</code> orders the level of a factor by how frequently they occur in the data, and <code>fct_reorder</code> orders the level of a factor by the values of a different variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">election_data_sorted <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> election_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">party =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_reorder</span>(party, seats_won, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.desc =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(election_data_sorted,</span>
<span id="cb5-2">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> seats_won, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> party)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> rev)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2020/03/beautiful-bar-charts-ggplot/index_files/figure-html/barchart3-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>If I was doing exploratory data analysis, or making a quick plot to show a colleague, I might stop at this point. But there is still plenty of room for improvement. To start with, the axis labels are the variable names in our data frame, which is better than no labels at all, but are usually too brief or jargon-laden for a wider audience. A good plot can be interpreted clearly with as little supporting information as possible—remember that a reader’s eye will be drawn to a large, colourful figure and ignore the paragraphs of text you’ve written describing the full context.</p>
<p>I’ve also changed the origin of the <em>x</em> axis so the bars are hard against the axis. Putting a blank space to the left of zero on a bar chart is something I’ve only ever seen in ggplot. It’s caused by ggplot’s standard rule of adding 10% padding on either side of the biggest and smallest values plotted. You can turn it off by setting the <code>expand</code> option on the <em>x</em> axis scale.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(election_data_sorted,</span>
<span id="cb6-2">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> seats_won, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> party)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expansion</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mult =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> rev) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of seats won"</span>,</span>
<span id="cb6-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Party"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2020/03/beautiful-bar-charts-ggplot/index_files/figure-html/barchart4-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>The grey background with white gridlines is a very distinctive ggplot default. Sometimes it works well—it can reduce the visual noise of gridlines in complex plots—but in this case I would normally opt for a simpler. I often use <code>theme_bw</code> or <code>theme_minimal</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(election_data_sorted,</span>
<span id="cb7-2">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> seats_won, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> party)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expansion</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mult =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> rev) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of seats won"</span>,</span>
<span id="cb7-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Party"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>()</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2020/03/beautiful-bar-charts-ggplot/index_files/figure-html/barchart5-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>The gridlines on the <em>x</em> axis are useful guides to the eye, but for a categorical variable with only a few categories, the gridlines only introduce clutter. They can be removed using the <code>theme</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(election_data_sorted,</span>
<span id="cb8-2">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> seats_won, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> party)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expansion</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mult =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> rev) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of seats won"</span>,</span>
<span id="cb8-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Party"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2020/03/beautiful-bar-charts-ggplot/index_files/figure-html/barchart6-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>The default dark grey bars look a bit drab. You can choose a colour and give it as an option to <code>geom_col</code>. If you’re like me, you’ll probably try a couple of wrong things first: either passing the colour inside <code>aes()</code> (won’t work, because the colour will be interpreted as data to plot) or using <code>colour</code> instead of <code>fill</code> (which changes the border colour instead). You can either use a hexadecimal colour code (like in HTML), or one of <a href="http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf">a number of built-in colour names</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(election_data_sorted,</span>
<span id="cb9-2">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> seats_won, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> party)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkorchid"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expansion</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mult =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> rev) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of seats won"</span>,</span>
<span id="cb9-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Party"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2020/03/beautiful-bar-charts-ggplot/index_files/figure-html/barchart7-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>In this context, it would be conventional to colour the bars based on the party being represented. Here I’ve set <code>fill = party</code>, then given a manual scale for the fill based on party colours found on Wikipedia. I also disabled the legend, which isn’t necessary in this instance—the party names are already next to the bars. I’ve also added a title and a caption indicating the source of the data; these wouldn’t normally be included in an academic publication but are a very good idea for a plot which might be copied out of context.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(election_data_sorted,</span>
<span id="cb10-2">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> seats_won, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> party, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> party)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expansion</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mult =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> rev) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Australian Labor Party"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Liberal"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The Nationals"</span>,</span>
<span id="cb10-7">                               <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Australian Greens"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Other Candidates"</span>),</span>
<span id="cb10-8">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#DE3533"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#0047AB"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#006644"</span>,</span>
<span id="cb10-9">                               <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#10C25B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#808080"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of seats won"</span>,</span>
<span id="cb10-11">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Party"</span>,</span>
<span id="cb10-12">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Victorian election 2018 lower house results"</span>,</span>
<span id="cb10-13">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Data source: Victorian Electoral Commission"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb10-16">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2020/03/beautiful-bar-charts-ggplot/index_files/figure-html/barchart8-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>Depending on what you’re trying to show with the graph, you may want to add annotations beyond what is contained in the original data. For example, you could add a dashed line at 44 seats indicating the number required for a party to form a majority government (which could slightly misleading, since the Liberal and National parties govern in coalition). In ggplot, you can pass specific data to any <code>geom_</code> function; in this example I’m using <code>geom_vline</code> to draw the dashed line and <code>geom_text</code> to draw the label:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(election_data_sorted,</span>
<span id="cb11-2">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> seats_won, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> party, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> party)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey20"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"majority of</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">parliament"</span>, </span>
<span id="cb11-5">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> .pt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey20"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expansion</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mult =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> rev) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Australian Labor Party"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Liberal"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The Nationals"</span>,</span>
<span id="cb11-10">                               <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Australian Greens"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Other Candidates"</span>),</span>
<span id="cb11-11">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#DE3533"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#0047AB"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#006644"</span>,</span>
<span id="cb11-12">                               <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#10C25B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#808080"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of seats won"</span>,</span>
<span id="cb11-14">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Party"</span>,</span>
<span id="cb11-15">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Victorian election 2018 lower house results"</span>,</span>
<span id="cb11-16">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Data source: Victorian Electoral Commission"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb11-19">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2020/03/beautiful-bar-charts-ggplot/index_files/figure-html/barchart8b-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>Finally, another good option for representing the same type of data as a bar chart is a line with a point at the end. The point draws the eye to the end of the line, which is the actual value being represented. You can create this in ggplot by using a <code>geom_segment</code> to draw the line segment and <code>geom_point</code> to draw the point. You also need to give <code>xend</code> and <code>yend</code> for <code>geom_segment</code> to work—it’s a general function for drawing line segments, not a specific functon for creating this type of plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(election_data_sorted,</span>
<span id="cb12-2">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> seats_won,</span>
<span id="cb12-3">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb12-4">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> party,</span>
<span id="cb12-5">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> party,</span>
<span id="cb12-6">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> party)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expansion</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mult =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> rev) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_colour_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Australian Labor Party"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Liberal"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The Nationals"</span>,</span>
<span id="cb12-12">                                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Australian Greens"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Other Candidates"</span>),</span>
<span id="cb12-13">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#DE3533"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#0047AB"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#006644"</span>,</span>
<span id="cb12-14">                                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#10C25B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#808080"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of seats won"</span>,</span>
<span id="cb12-16">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Party"</span>,</span>
<span id="cb12-17">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Victorian election 2018 lower house results"</span>,</span>
<span id="cb12-18">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Data source: Victorian Electoral Commission"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2020/03/beautiful-bar-charts-ggplot/index_files/figure-html/barchart9-1.png" class="img-fluid" width="720"></p>
</div>
</div>



 ]]></description>
  <category>r</category>
  <category>ggplot2</category>
  <guid>https://cameronpatrick.com/post/2020/03/beautiful-bar-charts-ggplot/index.html</guid>
  <pubDate>Sat, 14 Mar 2020 13:00:00 GMT</pubDate>
</item>
<item>
  <title>Things which are equivalent to t-tests</title>
  <dc:creator>Cameron Patrick</dc:creator>
  <link>https://cameronpatrick.com/post/2019/12/equivalent-to-t-test/index.html</link>
  <description><![CDATA[ 




<p>If you have a continuous measurement and two groups you’d like to compare based on that measurement, what’s the first statistical test that comes to mind? Chances are it’s the two-sample t-test, sometimes known as <em>Student’s t-test</em>. It’s typically the first statistical test taught in an introductory statistics course, it’s well known and understood, and it has good theoretical properties—so if a t-test answers your research question, you should probably use it. (Actually, in practice, you should probably use <em>Welch’s t-test</em> which doesn’t assume equal variance within groups. For the rest of the post, I’m only going to consider the equal variance case.)</p>
<p>Every now and again, I find a client in this situation who has done something which is… not a t-test. Here are some other ways to do the same thing which turn out to be identical to the two-sample t-test:</p>
<ul>
<li><p>One-way ANOVA: since ANOVA is often taught immediately after the t-test as “what do I do if I have more than two groups”, it should perhaps be no surprise that ANOVA gives identical p-values and confidence intervals to the t-test when you are only comparing two groups. This applies to both the overall F-test and the “post-hoc” pairwise t-test, which produce identical p-values in the two group scenario.</p></li>
<li><p>Linear regression with an indicator variable: by this I mean an explanatory variable which takes one numerical value for the first group and a different numerical value for the second group. For example, 0 for the first group and 1 for the second group. This also turns out to be equivalent to a t-test. If you’ve seen how ANOVA is implemented by most software as a linear model with indicator variables for categories, this might not surprise you either.</p></li>
<li><p>Linear regression with the indicator variable as the outcome and the measurement as the explanatory variable: as backwards as this may sound, this will also produce exactly the same p-value as a t-test. The hypothesis test for linear regression slope is the same regardless of which variable is the outcome and which is the predictor, although the regression equation is usually different.</p></li>
<li><p>Correlation with an indicator variable: this is also equivalent to a t-test. This follows from the above two because the hypothesis test for correlation being equal to zero is equivalent to the hypothesis test for linear regression slope being equal to zero.</p></li>
<li><p>Logistic regression with the group variable as the outcome and the continuous variable as a predictor: this is <em>not quite</em> the same as a t-test. However, if the measurements of the two groups are normally distributed, then the t-test and logistic regression are asymptotically equivalent—meaning that for a sufficiently large sample size, they will give the same p-values. The two methods also answer different research questions: the t-test is for a difference in means between two groups while logistic regression estimates the odds ratio of having a positive outcome (being in a particular group) for a given increase in the continuous predictor. The choice between the two methods should be based on which variable is your outcome and which variable is your explanatory variable; or whether you would prefer to discuss an odds ratio or a difference in means.</p></li>
<li><p>Pairwise comparisons from an ANOVA model with more than two groups are also not quite equivalent to a t-test. What’s the difference? Both use a test statistic that has a <em>t</em> distribution calculated from the same difference in means, but the ANOVA pairwise comparisons will have better power because they use a pooled standard deviation from all groups (which, if the assumption of equal standard deviation in every group is true, will be more a precise estimate) and a <em>t</em> distribution with more degrees of freedom (which can make a big difference with a small sample size). As the sample size increases, the advantage of ANOVA over individual t-tests diminishes.</p></li>
<li><p><strong>Bonus:</strong> The Mann-Whitney test (or Wilcoxon rank sum test) is equivalent to proportional odds logistic regression. (This claim is made in Frank Harrell’s <em>Regression Modeling Strategies</em> text; unlike the other examples above, I haven’t proved or read a proof of this equivalence.)</p></li>
</ul>



 ]]></description>
  <category>statistics</category>
  <category>t-test</category>
  <guid>https://cameronpatrick.com/post/2019/12/equivalent-to-t-test/index.html</guid>
  <pubDate>Sun, 15 Dec 2019 13:00:00 GMT</pubDate>
</item>
<item>
  <title>Understanding levels of variation and mixed models</title>
  <dc:creator>Cameron Patrick</dc:creator>
  <link>https://cameronpatrick.com/post/2019/12/understanding-levels-variation/index.html</link>
  <description><![CDATA[ 




<p>Data that has some kind of hierarchical structure to it is very common in many fields, but is rarely discussed in introductory statistics courses. Terms used to describe this kind of data include hierarchical data, multi-level data, longitudinal data, split-plot designs or repeated measures designs. Statistical models used for these types of data include mixed-effects models (often abbreviated to just <em>mixed models</em>), repeated measures ANOVA and generalised estimating equations (GEEs).</p>
<p>All of these terms and models arose from different contexts, but they share a common feature. Observations are not independent, as many classical statistical methods assume, and there is structure to the dependence which can be incorporated into a statistical model.</p>
<p><strong>Using a statistical model which doesn’t account for the hierarchical nature of this data will give incorrect results.</strong></p>
<section id="common-examples-of-hierarchical-data" class="level2">
<h2 class="anchored" data-anchor-id="common-examples-of-hierarchical-data">Common examples of hierarchical data</h2>
<p>Data with two levels of variation often arise when multiple measurements are made on the same units of observation. In the case of designed experiments, treatments may also be assigned to different levels of the hierarchy. Factors are commonly described as <em>within</em>-subject (varying at the lowest level) or <em>between</em>-subject (varying at a higher level). Some examples:</p>
<ul>
<li>Measurements made on the same people at several points in time. This is often called longitudinal data. In this example, time would be a within-subject factor and most other variables of interest—e.g., treatment, age or gender—would be between-subject.</li>
<li>Measurements made at different depths of a number of rock core samples. In this example, the depths would be a within-subject factor and the location where the sample was obtained would be a between-subject factor.</li>
<li>Assigning different treatments to different legs, arms or eyes of a number of people. For example, one eye may be given a new drug and the other eye a placebo. In this example, treatment is a within-subject factor.</li>
<li>A split-plot experiment in agriculture: splitting plots of land into sections, planting different crops in each section, and using different irrigation methods on different plots. In this example, variety is a within-plot factor and irrigation is a between-plot factor.</li>
<li>A split-mouth design in dentistry: assigning different treatments to different parts of participants’ mouths.</li>
</ul>
<p>It is possible to have more than two levels of variation. Some examples from different fields of research:</p>
<ul>
<li>Students within classrooms within schools.</li>
<li>Repeated surveys administered to individuals within organisations.</li>
<li>Glands within lesions within patients.</li>
<li>Blocks of land divided into plots divided into subplots.</li>
</ul>
<p>In situations with multiple levels, it is common to describe variables based on the level at which they are measured or assigned, e.g.&nbsp;student-level, classroom-level or school-level.</p>
</section>
<section id="random-effects" class="level2">
<h2 class="anchored" data-anchor-id="random-effects">Random effects</h2>
<p>Multi-level data is commonly modelled using <em>mixed-effects models</em>, which get their name because they have both fixed effects and random effects. Fixed effects are the kind of explanatory variables you may be used to in ANOVA or linear regression: you would like to directly estimate the effect of these variables on your outcome. For example: treatment (drug or placebo) and time; crop variety and irrigation; depth and location of rock core samples. In these examples, the random effects would be the variables which group together correlated observations: participants in a trial; plots of land; rock core samples.</p>
<p>Here are two different ways to think about random effects:</p>
<ol type="1">
<li>Random effects are factors where the individual levels are random samples from a larger population, or can be thought of in this way.</li>
<li>Random effects are factors where you don’t care about the actual effect they have on your outcome, just their ability to account for correlation between observations.</li>
</ol>
<p>For a random effect, instead of estimating the effect of each specific level of the factor (e.g.&nbsp;each individual in a study), the model estimates the variance explained by that factor. This is sometimes reported as the proportion of variation explained at each level, e.g.&nbsp;63% of variance was at the individual level.</p>
<p>Random effects can be “nested” inside other random effects if there are more than two levels of variation. For example, “classroom within school” could be specified as a random effect.</p>
</section>
<section id="simpler-analysis-options" class="level2">
<h2 class="anchored" data-anchor-id="simpler-analysis-options">Simpler analysis options</h2>
<p>It is sometimes possible to simplify an analysis if there are no variables which distinguish individuals at a particular level. For example, consider an experiment in which treatments were randomly assigned to litters of pigs but measurements were made on individual pigs, with no pig-level variables (e.g.&nbsp;sex) of interest in the analysis. In this situation, analysing litter averages would be a simpler analysis providing the same results as the mixed model.</p>
<p>Another common situation is when there is a single within-subjects factor with two levels, for example before and after measurements. This kind of design can be analysed with a paired t-test or Wilcoxon signed rank test.</p>
<p>As a practical consideration, random effects work best when they have a reasonable number of different levels. It may be better to treat a factor which is conceptually random as a fixed effect instead in some cases; e.g.&nbsp;if you are studying students from two or three schools, school should probably be a fixed effect rather than a random effect. There are also situations where this approach is not appropriate.</p>
<p>If in doubt about how to analyse your multi-level data, <a href="https://scc.ms.unimelb.edu.au/">consult a statistician</a>.</p>
</section>
<section id="study-design-considerations" class="level2">
<h2 class="anchored" data-anchor-id="study-design-considerations">Study design considerations</h2>
<p>Effects at the lowest level of the hierarchy (e.g.&nbsp;within-subject) are usually estimated more precisely than effects at higher levels (e.g.&nbsp;between-subject). Or equivalently, tests of within-subject effects tend to be more powerful than tests of between-subject effects. One intuition about this is that there are more observations at the lowest level (e.g.&nbsp;number of subplots) than there are at higher levels (e.g.&nbsp;number of plots). Another way to look at this is that for within-subject factors, each individual unit of observation is effectively their own control.</p>


</section>

 ]]></description>
  <category>statistics</category>
  <category>mixed-models</category>
  <guid>https://cameronpatrick.com/post/2019/12/understanding-levels-variation/index.html</guid>
  <pubDate>Mon, 09 Dec 2019 13:00:00 GMT</pubDate>
</item>
<item>
  <title>Plotting multiple variables at once using ggplot2 and tidyr</title>
  <dc:creator>Cameron Patrick</dc:creator>
  <link>https://cameronpatrick.com/post/2019/11/plotting-multiple-variables-ggplot2-tidyr/index.html</link>
  <description><![CDATA[ 




<p>In exploratory data analysis, it’s common to want to make similar plots of a number of variables at once. For example, a randomised trial may look at several outcomes, or a survey may have a large number of questions. Here is a way to achieve to plot them efficiently using R and <code>ggplot2</code>.</p>
<section id="pivoting-longer-turning-your-variables-into-rows" class="level2">
<h2 class="anchored" data-anchor-id="pivoting-longer-turning-your-variables-into-rows">Pivoting longer: turning your variables into rows</h2>
<p><code>ggplot2</code> doesn’t provide an easy facility to plot multiple variables at once because this is usually a sign that <a href="https://r4ds.had.co.nz/tidy-data.html">your data is not “tidy”</a>. For example, in situations where you want to plot two columns on a graph as points with different colours, the two columns often really represent the same variable, and there is a hidden grouping factor which distinguishes the data points you want to colour differently. The usual answer in this scenario is that you should restructure your data before plotting it. As a bonus, it will probably be easier to analyse your data in that form too.</p>
<p>Likewise, if you want to split a plot into panels (or facets, in <code>ggplot2</code>-speak), you must plot a single response variable, with a grouping variable to indicate which panel the data should be plotted in. The best structure for your data depends on what you’re trying to do with it, and in this situation, even if your data is in the right form for analysis, it may not be right for some of the plots you want to make.</p>
<p>Fortunately, restructuring your data into the right form is straightforward using the <code>tidyr</code> package and the <code>pivot_longer()</code> function. In this example, I’m going to look at some mocked-up survey data, with six questions stored in variables <code>Q1</code> through <code>Q6</code>. The original data frame looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(survey_data)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 300 × 7
   group    Q1    Q2    Q3    Q4    Q5    Q6
   &lt;fct&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
 1 B         4     1     4     1     2     3
 2 B         5     2     5     4     3     3
 3 B         5     4     4     2     2     3
 4 B         5     1     5     2     4     3
 5 A         5     2     5     1     1     2
 6 A         5     3     5     3     2     2
 7 A         4     3     5     1     4     1
 8 B         4     3     5     1     2     1
 9 B         4     4     4     1     3     2
10 B         4     4     5     2     5     4
# ℹ 290 more rows</code></pre>
</div>
</div>
<p>You can convert this into a longer data frame where the question number is stored in one column and the response is stored in a separate column:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">longer_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> survey_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(Q1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>Q6, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>)</span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(longer_data)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,800 × 3
   group question response
   &lt;fct&gt; &lt;chr&gt;       &lt;int&gt;
 1 B     Q1              4
 2 B     Q2              1
 3 B     Q3              4
 4 B     Q4              1
 5 B     Q5              2
 6 B     Q6              3
 7 B     Q1              5
 8 B     Q2              2
 9 B     Q3              5
10 B     Q4              4
# ℹ 1,790 more rows</code></pre>
</div>
</div>
<p>You don’t even need to store the ‘long form’ data as a separate variable. If you’re not going to use the data in this form for anything else, it’s simpler to pipe the data straight into <code>ggplot2</code>. Here I use the <code>facet_wrap()</code> function to plot each question in a separate panel, so we can see the distribution of all of the questions at once:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">survey_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(Q1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>Q6, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> response)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_bar</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(question), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Response (on a 1 to 5 scale)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of respondents"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2019/11/plotting-multiple-variables-ggplot2-tidyr/index_files/figure-html/panel-plot-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>You can use <code>question</code> as a factor anywhere else you would use a categorical variable with ggplot. For example, you can make some box plots:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">survey_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(Q1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>Q6, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> response, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> question)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_boxplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Question"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Response (on a 1 to 5 scale)"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2019/11/plotting-multiple-variables-ggplot2-tidyr/index_files/figure-html/box-plot-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>This is also a nice demonstration of how box plots are rarely the best way to present Likert scale data.</p>
<p>Any other variables are retained after you call <code>pivot_longer()</code>, so you can e.g.&nbsp;compare the responses to survey questions based on a demographic variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">survey_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(Q1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>Q6, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> response, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> group)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(question), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Response (on a 1 to 5 scale)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of respondents"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://cameronpatrick.com/post/2019/11/plotting-multiple-variables-ggplot2-tidyr/index_files/figure-html/line-plot-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>By default, R will sort the levels of factors alphabetically. This isn’t always what you want in this situation—often the order of the variables in your data frame has some meaning to it. The <code>fct_inorder()</code> function allows you to reorder levels of a factor in the order of first appearance in the file. If you use that with the column produced by <code>pivot_longer()</code>, the factor will be ordered by the order of the columns in the original data frame.</p>


</section>

 ]]></description>
  <category>r</category>
  <category>ggplot</category>
  <guid>https://cameronpatrick.com/post/2019/11/plotting-multiple-variables-ggplot2-tidyr/index.html</guid>
  <pubDate>Mon, 25 Nov 2019 13:00:00 GMT</pubDate>
</item>
</channel>
</rss>
