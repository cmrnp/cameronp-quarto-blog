<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.302">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Cameron Patrick">
<meta name="dcterms.date" content="2023-06-28">

<title>Cameron Patrick - Untangling missing data mechanisms using causal DAGs</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<link href="../../../../Cam_headshot_small.jpg" rel="icon" type="image/jpeg">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">Cameron Patrick</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/camjpatrick" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cmrnp" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Untangling missing data mechanisms using causal DAGs</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">missing-data</div>
                <div class="quarto-category">statistics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Cameron Patrick </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 28, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#mcar-mar-mnar-or-nah" id="toc-mcar-mar-mnar-or-nah" class="nav-link active" data-scroll-target="#mcar-mar-mnar-or-nah">MCAR, MAR, MNAR or nah?</a>
  <ul class="collapse">
  <li><a href="#how-do-i-know-what-kind-of-missing-data-mechanism-i-have" id="toc-how-do-i-know-what-kind-of-missing-data-mechanism-i-have" class="nav-link" data-scroll-target="#how-do-i-know-what-kind-of-missing-data-mechanism-i-have">How do I know what kind of missing data mechanism I have?</a></li>
  <li><a href="#if-i-know-my-missing-data-mechanism-what-analysis-do-i-do" id="toc-if-i-know-my-missing-data-mechanism-what-analysis-do-i-do" class="nav-link" data-scroll-target="#if-i-know-my-missing-data-mechanism-what-analysis-do-i-do">If I know my missing data mechanism, what analysis do I do?</a></li>
  </ul></li>
  <li><a href="#making-the-missing-data-process-explicit-using-causal-diagrams-dags" id="toc-making-the-missing-data-process-explicit-using-causal-diagrams-dags" class="nav-link" data-scroll-target="#making-the-missing-data-process-explicit-using-causal-diagrams-dags">Making the missing data process explicit using causal diagrams (DAGs)</a></li>
  <li><a href="#tell-me-again-what-method-should-i-use" id="toc-tell-me-again-what-method-should-i-use" class="nav-link" data-scroll-target="#tell-me-again-what-method-should-i-use">Tell me again, what method should I use?</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>Missing data refers to data which was intended to have been collected but was not, and is a common scenario in biomedical and social science research. Correctly analysing datasets that have missing data requires extra care and consideration to produce correct results.</p>
<p>The best method for dealing with missing data depends on the underlying process causing the missingness. There is no single approach that is always the best, and the terminology commonly used to describe missingness doesn’t directly relate to what analysis methods perform best. In this blog post I’ll explain how to describe missing data processes using causal diagrams (DAGs) and provide some references to help choose an analysis based on that.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="dont_fight_a_cat_MI.jpeg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">(original image via <a href="https://twitter.com/marginoferror/status/935937659888836609">@marginoferror on Twitter</a>, adapted by me for missing data purposes.)</figcaption><p></p>
</figure>
</div>
<section id="mcar-mar-mnar-or-nah" class="level2">
<h2 class="anchored" data-anchor-id="mcar-mar-mnar-or-nah">MCAR, MAR, MNAR or nah?</h2>
<p>The most common classification for missing data mechanisms is as either Missing Completely at Random (MCAR), Missing at Random (MAR), or Missing Not at Random (MNAR). This classification is based on concepts first introduced in <span class="citation" data-cites="rubin_inference_1976">Rubin (<a href="#ref-rubin_inference_1976" role="doc-biblioref">1976</a>)</span>. These terms are widespread, but can be confusing when first encountered because they do not mean quite what you might expect them to mean.</p>
<p>Data is considered to be <strong>Missing Completely at Random (MCAR)</strong> if the probability of being missing does not depend on the values of any of the variables in the data, whether those values are missing or observed <span class="citation" data-cites="little_statistical_2014">(<a href="#ref-little_statistical_2014" role="doc-biblioref">Little &amp; Rubin, 2014, p. 12</a>)</span>. In other words, the missingness cannot be related to the research question of interest <span class="citation" data-cites="lee_framework_2021">(<a href="#ref-lee_framework_2021" role="doc-biblioref">Lee et al., 2021</a>)</span>.</p>
<p>Data is <strong>Missing at Random (MAR)</strong> if the probability of being missing depends only on data that was observed <span class="citation" data-cites="little_statistical_2014">(<a href="#ref-little_statistical_2014" role="doc-biblioref">Little &amp; Rubin, 2014, p. 12</a>)</span>. This term is misleading if encountered without context, as a plain-language interpretation suggests it may mean something more like MCAR. However, MCAR is a stricter condition than MAR. In other words, if data is MCAR, it is also considered MAR. There are a few subtly different ways of defining this concept mathematically; <span class="citation" data-cites="seaman_what_2013">Seaman et al. (<a href="#ref-seaman_what_2013" role="doc-biblioref">2013</a>)</span> goes into the detail for those who are interested.</p>
<p>Data is <strong>Missing Not at Random (MNAR)</strong> if it’s not Missing at Random <span class="citation" data-cites="little_statistical_2014">(<a href="#ref-little_statistical_2014" role="doc-biblioref">Little &amp; Rubin, 2014, p. 12</a>)</span>. At least that’s relatively straightforward. In other words, the probability of data being missing is related to what the missing values would have been, had we observed them. It is often implied that MNAR data is a lost cause for statistical analysis, but later in this post we will see specific examples of MNAR where common statistical procedures produce valid results for common questions.</p>
<p>Whether data is classified as MAR or MNAR depends on more than just the variables with missing data. It also depends on the availability of additional variables in the dataset which may be able to explain the probability of missingness.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Historical aside
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="citation" data-cites="rubin_inference_1976">Rubin (<a href="#ref-rubin_inference_1976" role="doc-biblioref">1976</a>)</span> is often cited as the source of this classification system, but didn’t actually introduce the terms Missing Completely at Random or Missing Not at Random, only Missing at Random. Rubin originally defined an additional condition, Observed at Random. Data which is both Missing at Random and Observed at Random is what we would now commonly refer to as Missing Completely at Random. The term Missing Completely at Random came later, in <span class="citation" data-cites="marini_maximum-likelihood_1980">Marini et al. (<a href="#ref-marini_maximum-likelihood_1980" role="doc-biblioref">1980</a>)</span>. This history is given in <span class="citation" data-cites="little_missing_2021">Little (<a href="#ref-little_missing_2021" role="doc-biblioref">2021</a>)</span> and was also confirmed <a href="https://twitter.com/rnishimura/status/1668824406766878721">in a Tweet by Raphael Nishimura</a>: ‘I was curious about that too and did some digging with the authors. Rod said that “Rubin’s 1976 Biometrika paper defines MAR and OAR (observed at random) but he may not have put the two together.” Don confirmed it and added that “MCAR was first formally defined in a joint paper with Marini and Olsen, I think in 1980, in a more applied paper.”’</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Ignorable and non-ignorable missingness
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sometimes you may hear missing data described as “ignorable” or “non-ignorable”. These terms are also potentially misleading. “Ignorable” missing data doesn’t mean that you can just ignore the fact that you have missing data when doing an analysis. This term was defined in <span class="citation" data-cites="rubin_inference_1976">Rubin (<a href="#ref-rubin_inference_1976" role="doc-biblioref">1976</a>)</span> to mean that (1) the data is MAR; (2) the likelihood can be factorised into a part relating to the missingness probability and a part relating to the distribution of the underlying data. These provide a sufficient condition for missing data to be dealt with using likelihood-based methods.</p>
</div>
</div>
<section id="how-do-i-know-what-kind-of-missing-data-mechanism-i-have" class="level3">
<h3 class="anchored" data-anchor-id="how-do-i-know-what-kind-of-missing-data-mechanism-i-have">How do I know what kind of missing data mechanism I have?</h3>
<p>Unfortunately, there’s no way to determine the missing data mechanism purely by looking at the data — you need to think about the process generating the data and why some of it is missing. A causal DAG is a good way to reason about the relationship between the variables and their reasons for being missing and can help you decide what analysis to use. I’ll have examples of this later in this blog.</p>
</section>
<section id="if-i-know-my-missing-data-mechanism-what-analysis-do-i-do" class="level3">
<h3 class="anchored" data-anchor-id="if-i-know-my-missing-data-mechanism-what-analysis-do-i-do">If I know my missing data mechanism, what analysis do I do?</h3>
<p>It depends! (I’m statistician, you should have known I would say that.)</p>
<p>Complete cases analysis is unbiased if the data is MCAR. This is a sufficient condition, not a necessary condition <span class="citation" data-cites="little_missing_2021">(<a href="#ref-little_missing_2021" role="doc-biblioref">Little, 2021</a>)</span>: there are situations where complete cases may be valid, or at least provide a valid estimate of a particular quantity of interest, under MAR or MNAR. Depending on the amount of missing data, complete cases analysis may be inefficient (i.e., have lower power than other methods) because only cases where no variables have missing values are used in the analysis.</p>
<p>Multiple imputation, likelihood-based methods and full Bayesian methods are unbiased if the data is MAR or MCAR <span class="citation" data-cites="little_missing_2021">(<a href="#ref-little_missing_2021" role="doc-biblioref">Little, 2021</a>)</span>. Multiple imputation is approximately equivalent to a maximum-likelihood method if the underlying model is the same <span class="citation" data-cites="collins_comparison_2001">(<a href="#ref-collins_comparison_2001" role="doc-biblioref">Collins et al., 2001</a>)</span>.</p>
<p>In some specific MNAR situations, either or both of the above methods may still be valid, depending on what you’re trying to estimate <span class="citation" data-cites="white_bias_2010">(<a href="#ref-white_bias_2010" role="doc-biblioref">White &amp; Carlin, 2010</a>)</span>.</p>
</section>
</section>
<section id="making-the-missing-data-process-explicit-using-causal-diagrams-dags" class="level2">
<h2 class="anchored" data-anchor-id="making-the-missing-data-process-explicit-using-causal-diagrams-dags">Making the missing data process explicit using causal diagrams (DAGs)</h2>
<p>Causal diagrams are used to represent causal relationships between variables in a study <span class="citation" data-cites="pearl_causal_1995">(<a href="#ref-pearl_causal_1995" role="doc-biblioref">Pearl, 1995</a>)</span>. These relationships are shown visually using a directed acyclic graph (DAG), which is a mathematical term for a bunch of circles with arrows between them. The circles (nodes) represent variables and arrows (edges) between them represent direct causal pathways. The direction of the arrows represents the direction of causation, and a valid DAG never has a path leading from a particular point back to that same point (a “cycle” in mathematician-speak). If there is no path following the arrows between two variables in a DAG, there is no causal connection between them.</p>
<p>The structure of the DAG behind your data cannot be inferred just from looking at the data. It needs to come from substantive expertise about the underlying variables in the data, their relationship to each other, and how the data was collected.</p>
<p>The idea of using a DAG to represent missing data assumptions was first introduced in <span class="citation" data-cites="mohan_graphical_2014">Mohan &amp; Pearl (<a href="#ref-mohan_graphical_2014" role="doc-biblioref">2014</a>)</span>. To provide more practical advice for specific scenarios, <span class="citation" data-cites="moreno-betancur_canonical_2018">Moreno-Betancur et al. (<a href="#ref-moreno-betancur_canonical_2018" role="doc-biblioref">2018</a>)</span> introduces “canonical” causal diagrams for missing data in the setting where we want to estimate the relationship between an outcome <em>Y</em> and an exposure <em>X</em> (that’s epidemiologist-speak for the main predictor of interest), adjusting for some confounding variables which may influence both the outcome and the exposure. The confounding variables may be either completely observed (<em>Z1</em>) or have some missing data (<em>Z2</em>). There may also be some unknown, unmeasured factors <em>U</em> which affect the exposure and the confounders.</p>
<p>The code below plots the DAG corresponding to the scenario above using the R packages <a href="http://www.dagitty.net/"><em>dagitty</em></a> <span class="citation" data-cites="textor_robust_2017">(<a href="#ref-textor_robust_2017" role="doc-biblioref">Textor et al., 2017</a>)</span> and <a href="https://CRAN.R-project.org/package=ggdag"><em>ggdag</em></a>. You don’t need to understand the R code to use and apply DAGs but it is provided as an example for those who may want to make causal diagrams for their own studies. The first part of the code describes the underlying relationships between the variables, using the same syntax used to describe regression models in R. The second part of the code sets up the visual coordinates used for plotting the DAG — an aesthetic consideration only.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>dag_nomiss <span class="ot">&lt;-</span> <span class="fu">dagify</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> X <span class="sc">+</span> Z1 <span class="sc">+</span> Z2,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  X <span class="sc">~</span> Z1 <span class="sc">+</span> Z2 <span class="sc">+</span> U,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  Z1 <span class="sc">~</span> U,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  Z2 <span class="sc">~</span> U</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(dag_nomiss) <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">c</span>(<span class="at">U =</span> <span class="dv">0</span>, <span class="at">Z1 =</span> <span class="dv">1</span>, <span class="at">Z2 =</span> <span class="dv">1</span>, <span class="at">X =</span> <span class="dv">2</span>, <span class="at">Y =</span> <span class="dv">3</span>),</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">c</span>(<span class="at">U =</span> <span class="dv">0</span>, <span class="at">Z1 =</span> <span class="dv">1</span>, <span class="at">Z2 =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">X =</span> <span class="dv">0</span>, <span class="at">Y =</span> <span class="dv">0</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag</span>(dag_nomiss) <span class="sc">+</span> <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/dag-nomiss-1.png" class="img-fluid" width="1170"></p>
</div>
</div>
<p>This DAG is called a complete-data DAG, or <em>c-DAG</em>. It represents the causal relationships between the variables if all of them had been completely observed.</p>
<p>To represent possible causes of missing data, we can introduce three new variables in the DAG: <em>MX</em>, <em>MY</em> and <em>MZ2</em>, representing whether or not the exposure, outcome, or incomplete confounders are missing. Adding these variables produces a missingness DAG, or <em>m-DAG</em>. <span class="citation" data-cites="moreno-betancur_canonical_2018">Moreno-Betancur et al. (<a href="#ref-moreno-betancur_canonical_2018" role="doc-biblioref">2018</a>)</span> also considers unmeasured causes of missingness (<em>W</em>) which are not related to any of the substantive variables in the study but do affect the probability of missingness.</p>
<p>If we interpret the c-DAG above as an m-DAG, the absence of arrows to <em>MX</em>, <em>MY</em> and <em>MZ2</em> would mean that there is no causal relationship between any of the variables and their missingness. So the c-DAG is the m-DAG for MCAR. This scenario would be quite unusual in most real studies, unless the missing data was deliberately planned.</p>
<p>Figure 2 in <span class="citation" data-cites="moreno-betancur_canonical_2018">Moreno-Betancur et al. (<a href="#ref-moreno-betancur_canonical_2018" role="doc-biblioref">2018</a>)</span> provides 10 examples of m-DAGs, with different combinations of the following features:</p>
<ul>
<li>incomplete confounders and exposure related to missingness of other variables;</li>
<li>incomplete confounders and exposure related to their own missingness;</li>
<li>outcome related to missingness of other variables; and</li>
<li>outcome related to its own missingness.</li>
</ul>
<p>The first of these canonical DAGs, m-DAG A, is an example of a MAR process, where the missingness is only related to completely-observed confounders (<em>Z1</em>) and unmeasured variables unrelated to other variables in the study (<em>W</em>). We can visualise that DAG using the code below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>dag_a <span class="ot">&lt;-</span> <span class="fu">dagify</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> X <span class="sc">+</span> Z1 <span class="sc">+</span> Z2,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  X <span class="sc">~</span> Z1 <span class="sc">+</span> Z2 <span class="sc">+</span> U,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  Z1 <span class="sc">~</span> U,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  Z2 <span class="sc">~</span> U,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  MX <span class="sc">~</span> Z1 <span class="sc">+</span> W,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  MY <span class="sc">~</span> Z1 <span class="sc">+</span> W,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  MZ2 <span class="sc">~</span> Z1 <span class="sc">+</span> W</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(dag_a) <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">c</span>(<span class="at">U =</span> <span class="dv">0</span>, <span class="at">Z1 =</span> <span class="dv">1</span>, <span class="at">Z2 =</span> <span class="dv">1</span>, <span class="at">X =</span> <span class="dv">2</span>, <span class="at">Y =</span> <span class="dv">3</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">MX =</span> <span class="fl">1.5</span>, <span class="at">MY =</span> <span class="dv">2</span>, <span class="at">MZ2 =</span> <span class="fl">2.5</span>, <span class="at">W =</span> <span class="dv">2</span>),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">c</span>(<span class="at">U =</span> <span class="dv">0</span>, <span class="at">Z1 =</span> <span class="fl">0.75</span>, <span class="at">Z2 =</span> <span class="sc">-</span><span class="fl">0.75</span>, <span class="at">X =</span> <span class="dv">0</span>, <span class="at">Y =</span> <span class="dv">0</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">MX =</span> <span class="fl">1.75</span>, <span class="at">MY =</span> <span class="fl">1.75</span>, <span class="at">MZ2 =</span> <span class="fl">1.75</span>, <span class="at">W =</span> <span class="fl">2.5</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag</span>(dag_a) <span class="sc">+</span> <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/dag-a-1.png" class="img-fluid" width="1170"></p>
</div>
</div>
<p>In this DAG, both complete cases analysis and multiple imputation provide valid estimates of not just the relationship between the exposure and the outcome, but also the complete distribution of the outcome. This isn’t something that should be obvious just from looking at the DAG — there’s a derivation in the supplementary materials for <span class="citation" data-cites="moreno-betancur_canonical_2018">Moreno-Betancur et al. (<a href="#ref-moreno-betancur_canonical_2018" role="doc-biblioref">2018</a>)</span> for this and the other DAGs, with the results summarised in Tables 1 and 2 of that paper.</p>
<p>In other missing data situations, it may be possible to obtain the effect of the exposure but not, for example, the population mean of the outcome. In some situations, it may not be possible to obtain a valid estimate of either.</p>
<p>The figure below shows m-DAG E, which is an example of a MNAR process. The probability of missingness in all variables is affected by both the exposure <em>X</em> (which may itself have missing values) and partially-observed confounders <em>Z2</em>. Perhaps surprisingly, even though this missingness process is MNAR, it is possible to obtain a valid estimate of the relationship between the exposure and the outcome using either complete cases analysis or multiple imputation. However, it is not possible to recover the overall mean of the outcome.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>dag_e <span class="ot">&lt;-</span> <span class="fu">dagify</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> X <span class="sc">+</span> Z1 <span class="sc">+</span> Z2,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  X <span class="sc">~</span> Z1 <span class="sc">+</span> Z2 <span class="sc">+</span> U,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  Z1 <span class="sc">~</span> U,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  Z2 <span class="sc">~</span> U,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  MX <span class="sc">~</span> Z1 <span class="sc">+</span> Z2 <span class="sc">+</span> X <span class="sc">+</span> W,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  MY <span class="sc">~</span> Z1 <span class="sc">+</span> Z2 <span class="sc">+</span> X <span class="sc">+</span> W,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  MZ2 <span class="sc">~</span> Z1 <span class="sc">+</span> Z2 <span class="sc">+</span> X <span class="sc">+</span> W</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(dag_e) <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">c</span>(<span class="at">U =</span> <span class="dv">0</span>, <span class="at">Z1 =</span> <span class="dv">1</span>, <span class="at">Z2 =</span> <span class="dv">1</span>, <span class="at">X =</span> <span class="dv">2</span>, <span class="at">Y =</span> <span class="dv">3</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">MX =</span> <span class="fl">1.5</span>, <span class="at">MY =</span> <span class="dv">2</span>, <span class="at">MZ2 =</span> <span class="fl">2.5</span>, <span class="at">W =</span> <span class="dv">2</span>),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">c</span>(<span class="at">U =</span> <span class="dv">0</span>, <span class="at">Z1 =</span> <span class="fl">0.75</span>, <span class="at">Z2 =</span> <span class="sc">-</span><span class="fl">0.75</span>, <span class="at">X =</span> <span class="dv">0</span>, <span class="at">Y =</span> <span class="dv">0</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">MX =</span> <span class="fl">1.75</span>, <span class="at">MY =</span> <span class="fl">1.75</span>, <span class="at">MZ2 =</span> <span class="fl">1.75</span>, <span class="at">W =</span> <span class="fl">2.5</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag</span>(dag_e) <span class="sc">+</span> <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/dag-e-1.png" class="img-fluid" width="1170"></p>
</div>
</div>
<p>The final example in this blog is m-DAG J, which is another MNAR process. In this example, missingness is also affected by the value of the outcome <em>Y</em>. For this m-DAG, it is not possible to recover the relationship between the outcome and the exposure.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>dag_j <span class="ot">&lt;-</span> <span class="fu">dagify</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> X <span class="sc">+</span> Z1 <span class="sc">+</span> Z2,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  X <span class="sc">~</span> Z1 <span class="sc">+</span> Z2 <span class="sc">+</span> U,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  Z1 <span class="sc">~</span> U,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  Z2 <span class="sc">~</span> U,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  MX <span class="sc">~</span> Z1 <span class="sc">+</span> Z2 <span class="sc">+</span> X <span class="sc">+</span> Y <span class="sc">+</span> W,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  MY <span class="sc">~</span> Z1 <span class="sc">+</span> Z2 <span class="sc">+</span> X <span class="sc">+</span> Y <span class="sc">+</span> W,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  MZ2 <span class="sc">~</span> Z1 <span class="sc">+</span> Z2 <span class="sc">+</span> X <span class="sc">+</span> Y <span class="sc">+</span> W</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(dag_j) <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">c</span>(<span class="at">U =</span> <span class="dv">0</span>, <span class="at">Z1 =</span> <span class="dv">1</span>, <span class="at">Z2 =</span> <span class="dv">1</span>, <span class="at">X =</span> <span class="dv">2</span>, <span class="at">Y =</span> <span class="dv">3</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">MX =</span> <span class="fl">1.5</span>, <span class="at">MY =</span> <span class="dv">2</span>, <span class="at">MZ2 =</span> <span class="fl">2.5</span>, <span class="at">W =</span> <span class="dv">2</span>),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">c</span>(<span class="at">U =</span> <span class="dv">0</span>, <span class="at">Z1 =</span> <span class="fl">0.75</span>, <span class="at">Z2 =</span> <span class="sc">-</span><span class="fl">0.75</span>, <span class="at">X =</span> <span class="dv">0</span>, <span class="at">Y =</span> <span class="dv">0</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">MX =</span> <span class="fl">1.75</span>, <span class="at">MY =</span> <span class="fl">1.75</span>, <span class="at">MZ2 =</span> <span class="fl">1.75</span>, <span class="at">W =</span> <span class="fl">2.5</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag</span>(dag_j) <span class="sc">+</span> <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/dag-j-1.png" class="img-fluid" width="1170"></p>
</div>
</div>
</section>
<section id="tell-me-again-what-method-should-i-use" class="level2">
<h2 class="anchored" data-anchor-id="tell-me-again-what-method-should-i-use">Tell me again, what method should I use?</h2>
<p>Once you’ve drawn a DAG for your study, you can compare it to the canonical DAGs in <span class="citation" data-cites="moreno-betancur_canonical_2018">Moreno-Betancur et al. (<a href="#ref-moreno-betancur_canonical_2018" role="doc-biblioref">2018</a>)</span>. For canonical DAGs A, B, D and E, complete cases analysis was shown to provide a valid estimate of the relationship between the outcome and the exposure. For canonical DAGs A, B, C, D and E, multiple imputation was shown to provide a valid estimate of the relationship between the outcome and the exposure. <span class="citation" data-cites="lee_assumptions_2023">Lee et al. (<a href="#ref-lee_assumptions_2023" role="doc-biblioref">2023</a>)</span> provides further practical guidance for data analysis using missingness DAGs.</p>
<p><span class="citation" data-cites="white_bias_2010">White &amp; Carlin (<a href="#ref-white_bias_2010" role="doc-biblioref">2010</a>)</span> considers some scenarios where covariates are missing and compares complete cases and multiple imputation. In some scenarios, complete cases analysis was unbiased while multiple imputation was not; in other scenarios, the reverse was true.</p>
<p>Randomised clinical trials provide some additional guarantees about the nature of the missing data process which observational studies do not: the exposure is completely observed and known to be unrelated to baseline covariates. <span class="citation" data-cites="sullivan_should_2018">Sullivan et al. (<a href="#ref-sullivan_should_2018" role="doc-biblioref">2018</a>)</span> considers several methods for dealing with missing data in randomised trials.</p>
<p>The papers above provide examples of situations where multiple imputation is not necessarily better than simpler methods, as well as situations where multiple imputation is required.</p>
</section>
<section id="references" class="level2">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-line-spacing="2" role="list">
<div id="ref-collins_comparison_2001" class="csl-entry" role="listitem">
Collins, L. M., Schafer, J. L., &amp; Kam, C.-M. (2001). A comparison of inclusive and restrictive strategies in modern missing data procedures. <em>Psychological Methods</em>, <em>6</em>(4), 330–351. <a href="https://doi.org/10.1037/1082-989X.6.4.330">https://doi.org/10.1037/1082-989X.6.4.330</a>
</div>
<div id="ref-lee_assumptions_2023" class="csl-entry" role="listitem">
Lee, K. J., Carlin, J. B., Simpson, J. A., &amp; Moreno-Betancur, M. (2023). Assumptions and analysis planning in studies with missing data in multiple variables: Moving beyond the <span>MCAR</span>/<span>MAR</span>/<span>MNAR</span> classification. <em>International Journal of Epidemiology</em>, dyad008. <a href="https://doi.org/10.1093/ije/dyad008">https://doi.org/10.1093/ije/dyad008</a>
</div>
<div id="ref-lee_framework_2021" class="csl-entry" role="listitem">
Lee, K. J., Tilling, K. M., Cornish, R. P., Little, R. J. A., Bell, M. L., Goetghebeur, E., Hogan, J. W., &amp; Carpenter, J. R. (2021). Framework for the treatment and reporting of missing data in observational studies: <span>The</span> <span>Treatment</span> <span>And</span> <span>Reporting</span> of <span>Missing</span> data in <span>Observational</span> <span>Studies</span> framework. <em>Journal of Clinical Epidemiology</em>, <em>134</em>, 79–88. <a href="https://doi.org/10.1016/j.jclinepi.2021.01.008">https://doi.org/10.1016/j.jclinepi.2021.01.008</a>
</div>
<div id="ref-little_missing_2021" class="csl-entry" role="listitem">
Little, R. J. A. (2021). Missing <span>Data</span> <span>Assumptions</span>. <em>Annual Review of Statistics and Its Application</em>, <em>8</em>(1), 89–107. <a href="https://doi.org/10.1146/annurev-statistics-040720-031104">https://doi.org/10.1146/annurev-statistics-040720-031104</a>
</div>
<div id="ref-little_statistical_2014" class="csl-entry" role="listitem">
Little, R. J. A., &amp; Rubin, D. B. (2014). <em>Statistical analysis with missing data</em> (Second edition). John Wiley &amp; Sons.
</div>
<div id="ref-marini_maximum-likelihood_1980" class="csl-entry" role="listitem">
Marini, M. M., Olsen, A. R., &amp; Rubin, D. B. (1980). Maximum-<span>Likelihood</span> <span>Estimation</span> in <span>Panel</span> <span>Studies</span> with <span>Missing</span> <span>Data</span>. <em>Sociological Methodology</em>, <em>11</em>, 314. <a href="https://doi.org/10.2307/270868">https://doi.org/10.2307/270868</a>
</div>
<div id="ref-mohan_graphical_2014" class="csl-entry" role="listitem">
Mohan, K., &amp; Pearl, J. (2014). Graphical <span>Models</span> for <span>Recovering</span> <span>Probabilistic</span> and <span>Causal</span> <span>Queries</span> from <span>Missing</span> <span>Data</span>. <em>Proceedings of the 27th <span>International</span> <span>Conference</span> on <span>Neural</span> <span>Information</span> <span>Processing</span> <span>Systems</span> - <span>Volume</span> 1</em>, 1520–1528.
</div>
<div id="ref-moreno-betancur_canonical_2018" class="csl-entry" role="listitem">
Moreno-Betancur, M., Lee, K. J., Leacy, F. P., White, I. R., Simpson, J. A., &amp; Carlin, J. B. (2018). Canonical <span>Causal</span> <span>Diagrams</span> to <span>Guide</span> the <span>Treatment</span> of <span>Missing</span> <span>Data</span> in <span>Epidemiologic</span> <span>Studies</span>. <em>American Journal of Epidemiology</em>, <em>187</em>(12), 2705–2715. <a href="https://doi.org/10.1093/aje/kwy173">https://doi.org/10.1093/aje/kwy173</a>
</div>
<div id="ref-pearl_causal_1995" class="csl-entry" role="listitem">
Pearl, J. (1995). Causal diagrams for empirical research. <em>Biometrika</em>, <em>82</em>(4), 669–688. <a href="https://doi.org/10.1093/biomet/82.4.669">https://doi.org/10.1093/biomet/82.4.669</a>
</div>
<div id="ref-rubin_inference_1976" class="csl-entry" role="listitem">
Rubin, D. B. (1976). Inference and missing data. <em>Biometrika</em>, <em>63</em>(3), 581–592. <a href="https://doi.org/10.1093/biomet/63.3.581">https://doi.org/10.1093/biomet/63.3.581</a>
</div>
<div id="ref-seaman_what_2013" class="csl-entry" role="listitem">
Seaman, S., Galati, J., Jackson, D., &amp; Carlin, J. (2013). What <span>Is</span> <span>Meant</span> by <span>“<span>Missing</span> at <span>Random</span>”</span>? <em>Statistical Science</em>, <em>28</em>(2). <a href="https://doi.org/10.1214/13-STS415">https://doi.org/10.1214/13-STS415</a>
</div>
<div id="ref-sullivan_should_2018" class="csl-entry" role="listitem">
Sullivan, T. R., White, I. R., Salter, A. B., Ryan, P., &amp; Lee, K. J. (2018). Should multiple imputation be the method of choice for handling missing data in randomized trials? <em>Statistical Methods in Medical Research</em>, <em>27</em>(9), 2610–2626. <a href="https://doi.org/10.1177/0962280216683570">https://doi.org/10.1177/0962280216683570</a>
</div>
<div id="ref-textor_robust_2017" class="csl-entry" role="listitem">
Textor, J., Van Der Zander, B., Gilthorpe, M. S., Liśkiewicz, M., &amp; Ellison, G. T. H. (2017). Robust causal inference using directed acyclic graphs: The r package <span>“dagitty.”</span> <em>International Journal of Epidemiology</em>, dyw341. <a href="https://doi.org/10.1093/ije/dyw341">https://doi.org/10.1093/ije/dyw341</a>
</div>
<div id="ref-white_bias_2010" class="csl-entry" role="listitem">
White, I. R., &amp; Carlin, J. B. (2010). Bias and efficiency of multiple imputation compared with complete-case analysis for missing covariate values. <em>Statistics in Medicine</em>, <em>29</em>(28), 2920–2931. <a href="https://doi.org/10.1002/sim.3944">https://doi.org/10.1002/sim.3944</a>
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>